/*! 
* WeX5 v3 (http://www.justep.com) 
* Copyright 2015 Justep, Inc.
* Licensed under Apache License, Version 2.0 (http://www.apache.org/licenses/LICENSE-2.0) 
*/

define("$model/UI2/system/components/justep/cellLayout/designer/cellLayout",["require","jquery","css!./css/cellLayout","$UI/system/components/designerCommon/js/xuiService"],function(require){function insertface(e,t){if(document.selection){var n=document.selection.createRange().text;n||(n=t),e.focus(),n.charAt(n.length-1)==" "?(n=n.substring(0,n.length-1),document.selection.createRange().text=n+" "):document.selection.createRange().text=n}else if(e.selectionStart||e.selectionStart=="0"){var r=e.selectionStart,i=e.selectionEnd,s=e.value.substring(r,i),o;s||(s=t),s.charAt(s.length-1)==" "?o=s.substring(0,s.length-1)+" ":o=s,e.value=e.value.substring(0,r)+o+e.value.substring(i,e.value.length),e.focus();var u=r+s.length;e.selectionStart=u,e.selectionEnd=u}else e.value+=t,e.focus();e.createTextRange&&(e.caretPos=document.selection.createRange().duplicate())}var $=require("jquery");require("css!./css/cellLayout").load();var xuiService=require("$UI/system/components/designerCommon/js/xuiService"),xuiDoc=xuiService.getXuiDoc(),SelectionUnit=function(e){this.ownerCom=e};String.prototype.replaceAll=function(e,t){return this.replace(new RegExp(e,"gm"),t)},SelectionUnit.prototype={setBound:function(e){this.bound=e;var t=this.ownerCom.domNode,n=e.x,r=e.y,i=e.w-1,s=e.h-1;if(!this.lines){var o="black",u="solid",a=";overflow:visible;font-size:0px;z-index:2200;position:absolute;",f=[];f.push("top:"+r+"px;left:"+n+"px;width:1px;height:"+s+"px;line-height:0px;"+";border-left:2px "+u+" "+o+a),f.push("top:"+r+"px;left:"+n+"px;width:"+i+"px;height:1px;line-height:0px;"+";border-top:2px "+u+" "+o+a),f.push("top:"+r+"px;left:"+(n+i)+"px;width:1px;height:"+(s+1)+"px;line-height:0px;"+";border-left:2px "+u+" "+o+a),f.push("top:"+(r+s)+"px;left:"+n+"px;width:"+i+"px;height:1px;line-height:0px;"+";border-top:2px "+u+" "+o+a),this.lines=[];var l=0;for(l=0,n=f.length;l<n;l++)this.lines.push(this._paintLine(t,f[l]))}else $(this.lines[0]).css({top:r+"px",left:n+"px",height:s+"px"}),$(this.lines[1]).css({top:r+"px",left:n+"px",width:i+"px"}),$(this.lines[2]).css({top:r+"px",left:n+i+"px",height:s+2+"px"}),$(this.lines[3]).css({top:r+s+"px",left:n+"px",width:i+"px"});return this.cells=this.getCells(),this},reGetCells:function(){this.cells=this.getCells()},updateBound:function(){var e=this.cells[0],t=this.cells[this.cells.length-1],n=this.ownerCom.getCellBound(e),r=this.ownerCom.getCellBound(t),i=n.x,s=n.y,o=r.x-n.x+r.w,u=r.y-n.y+r.h;this.setBound({x:i,y:s,w:o,h:u})},_paintLine:function(e,t,n){var r=document.createElement("div");return e.appendChild(r),r.className="cell-select-line",r.style.cssText=t,r},getCells:function(){return this.getCellsWithColRowIndics()[2]},getCellsWithColRowIndics:function(){var e=this.getBound(),t=e.x-2,n=e.x+e.w-2,r=this.ownerCom.getRowColIndex(e.x+1,e.y+1),i=this.ownerCom.getRowColIndex(e.x+e.w-3,e.y+e.h-3),s=this.ownerCom.getCells(r[0],i[0]-1,t,n);return[r,i,s]},getBound:function(){return this.bound},dispose:function(){if(this.lines)for(var e=0,t=this.lines.length;e<t;e++)this.lines[e].parentNode.removeChild(this.lines[e]);this.lines=null}};var CellLayout=function(e){this.selctionChangeCaller=null,this.selectionClearCaller=null,this.selections=[],this.preAddChild={},this.maxPos={x:0,y:0},this.domNode=this.templateNode=e.templateNode,this.domNode.setAttribute("tabindex","0"),this.paintContent(this.templateNode)};CellLayout.prototype={paintContent:function(e){var t=this;$(this.domNode).on("childChanged",">*",function(){setTimeout(function(){t.updateAllSelectionUnitBound()},100)}),$(this.domNode).on("childChanged",function(){setTimeout(function(){t.updateAllSelectionUnitBound()},100)}),this.isInit=!0,this.rowHeight=e.getAttribute("row-height"),this.columnWidth=e.getAttribute("column-width");if(!this.rowHeight||this.rowHeight=="0")this.rowHeight="19";if(!this.columnWidth||this.columnWidth=="0")this.columnWidth="80";this.rowHeight+="px",this.columnWidth+="px";var n=e.childNodes,r,i={};for(var s=0,o=n.length;s<o;s++){var u=n[s];if(u.tagName.toLowerCase()=="layout-content"){var a=u.childNodes,f=[];for(var l=0;l<a.length;l++)a[l].nodeType==3&&f.push(a[l].nodeValue);r=$(f.join(""))[0]}else u.nodeType===1&&(i[u.getAttribute("xid")]=u.outerHTML)}this._init(r,i),this.isInit=!1;var c=this.getMaxRowColIndex();this.updateBeforeCellsHeight(c[0],c[1])},_init:function(e,t){var n=this,r=this._buildHtml(e,t);this.domNode.innerHTML=r,this.mainTable=this.domNode.childNodes[0];var i=!1,s,o,u;$(this.domNode).bind("mousedown",function(e){o=e.clientX,u=e.clientY;if(n.ownerDesigner.ctx.action!==null)return;var t=e.target,r=$(e.target);if(r.hasClass("cell")){if(e.button==2&&n.getSelectionUnit(e.target)){e.stopPropagation();return}if(t.getAttribute("d_canAddChild")!="true"){n.clearSelectionUnit();return}n.mouseDonwCell=t,n.ownerDesigner.clearSelections(),n.ownerDesigner.clearResizeBoxes(),n.executeSelect(e,t),n.currentCell=t,s=t,n.moveRowIndex=s.parentNode.rowIndex,e.stopPropagation(),n.ownerDesigner.clearCompTip()}}).bind("mouseup",function(e){i=!1,s=null;var t=$(e.target);n.ownerDesigner.ctx.action===null&&(t.hasClass("cell")||t.hasClass("cell-select-line"))&&e.button==2&&n.ownerDesigner.dispatchEvent({event:"contextmenu",selections:JSON.stringify([n.domNode.getAttribute("d_id")]),componentNames:JSON.stringify([n.domNode.getAttribute("componentName")])})}).bind("mousemove",function(e){!i&&s&&(Math.abs(e.clientX-o)>1||Math.abs(e.clientY-u)>1)&&(i=!0,n.dragSelect(e,s,n))}).bind("dblclick",function(e){var t=e.target;if(t.tagName=="TD"&&$(t).hasClass("cell")&&t.getAttribute("d_canAddChild")=="true"){var r=t.childNodes;for(var i=0;i<r.length;i+=1)if(r[i].nodeType==1&&r[i].tagName!="BR")return;n.ownerDesigner.focusable=!1,n.showLabelInput(t),setTimeout(function(){n.ownerDesigner.focusable=!0},800)}}).bind("keydown",function(e){if(!n.currentCell)return;var t=e.keyCode;if(t==37)return n.gotoPrevTd(n.currentCell,e.shiftKey),!1;if(t==39||t==9)return t==9&&e.shiftKey?n.gotoPrevTd(n.currentCell,!1):n.gotoNextTd(n.currentCell,e.shiftKey),!1;if(t==38)return n.gotoUpTd(n.currentCell,e.shiftKey),!1;if(t==40||t==13){if(t!=13||!e.shiftKey)return n.gotoDownTd(n.currentCell,e.shiftKey),!1;n.gotoUpTd(n.currentCell,!1)}else if(t==32||t==113)n.showLabelInput(n.lastSelectCell),e.preventDefault();else if(t==46)e.stopPropagation(),n.clearCellContent();else if(!e.ctrlKey||e.keyCode!=67&&e.keyCode!=88)if(t==27&&n.selections&&n.selections.length>0)return n.clearSelectionUnit(),n.ownerDesigner.setSelection(n.domNode),n.ownerDesigner.dispatchSelectionChangedEvent(),!1})},endCellEdit:function(){this.currentTextInput&&this.currentTextInput.blur()},copyCells:function(e){if(this.selections.length>1){alert("不能同时复制多个区域");return}if(this.selections.length==1){var t={},n=this.selections[0].getCellsWithColRowIndics(),r=n[0],i=n[1],s=i[1]-r[1],o=i[0]-r[0],u=n[2],a=[],f=[];for(var l=0,c=u.length;l<c;l++){var h=u[l];this.getComIds(h,a,f);var p=t[h.parentNode.rowIndex];p||(p=t[h.parentNode.rowIndex]=[]),p.push(this.genaCellHtml(h))}var d=['<table rowNums="'+o+'" colNums="'+s+'">'];for(var v in t)d.push("<tr>"+t[v].join("")+"</tr>");d.push("</table>"),e.cellData=d.join(""),e.comIds=a,e.paths=f}},pasteCells:function(e){var t=e.cells;if(t){t=t.replace(new RegExp("#C1C1C1|#c1c1c1","gm"),"#010101");var n=this.selections[0].getCells(),r=n[0],i=$(t)[0],s=parseInt(i.getAttribute("rowNums"),10),o=parseInt(i.getAttribute("colNums"),10),u=r.parentNode.rowIndex,a=this.getColIndex(r),f=u+s-1,l=a+o-1,c=this.mainTable.rows[0].cells[a],h=this.mainTable.rows[0].cells[l];if(!h){alert("列数不足！");return}var p=this.mainTable.rows[f];if(!p){alert("行数不足！");return}var d=p.cells[0],v=c.offsetLeft,m=c.offsetTop,g=h.offsetLeft+h.offsetWidth,y=d.offsetTop+d.offsetHeight,b=5e4,w=5e4,E=0,S=0,x="",T=this.getCells(u,f,v,g),N=null;for(var C=0;C<T.length;C++){var k=T[C],L=k.offsetLeft,A=k.offsetTop,O=k.offsetWidth+L,M=k.offsetHeight+A;b=Math.min(b,L),w=Math.min(w,A),E=Math.max(O,E),S=Math.max(M,S),!x&&(L<v||A<m||k.offsetWidth+L>g||k.offsetHeight+A>y)&&(x="不能对合并单元格做部分修改！"),N=k}N!=r&&(this.selections[this.selections.length-1].setBound({x:b,y:w,w:E-b,h:S-w}),this.paintResizeBoxes(N,!0));if(x){alert(x);return}this.cancelCellMerging(!1),n=this.selections[0].getCells();var _=[],D=0;u=-1;var C=0;for(C=0;C<n.length;C++){var k=n[C];u==-1&&(u=k.parentNode.rowIndex);var P=_[k.parentNode.rowIndex-u];P||(D+=1,P=_[k.parentNode.rowIndex-u]=[]),P.push(k)}var H=_[0];if(D!=s||H.length!=o){alert("不能对合并单元格做部分修改！");return}var B=i.childNodes[0].childNodes;this.comIdToCellMap={};for(C=0;C<B.length;C++){var P=B[C],j=P.childNodes;for(var F=0;F<j.length;F++){var k=j[F];if(k.nodeType==1){k.setAttribute("class","cell"),k.setAttribute("d_canAddChild","true");var I=$(k.outerHTML).insertBefore(_[C][0])[0];I.setAttribute("id","_id")}}}var q=[],R=[];for(C=n.length-1;C>=0;C--)this._fetchComIds(n[C],q,R),n[C].parentNode.removeChild(n[C]);e.removeComIds=q,e.removeComPaths=R;var U=this.asHtml();e["layout-data"]=U,this.isInit=!0;var z=this;this.currentCell=this.selections[0].getCells()[0]}},_buildHtml:function(e,t){var n=["<table class='nohead' cellspacing=0 cellpadding=0 d_canAddChild='false' style='background:white;border-collapse: collapse;table-layout:fixed; top:0px;left:0px;width:1px;'>"],r=e?e.getElementsByTagName("tr"):[],i=r.length,s=r.length>0?r[0].childNodes.length:0,o=Math.max(8,s),u=Math.max(20,i),a={};for(var f=0;f<u;f++){n.push("<tr d_canAddChild='false'>");var l="cell";f==0&&(l+=" first-row");var c=r[f];if(!c)for(var h=0;h<o;h++){var p=l;f==0&&h==0&&(p+=" first-cell"),n.push("<td name='"+(f+"-"+h)+"' d_canAddChild='"+(f>0&&h>0?"true":"false")+"' class='"+p+(h>0?"":" first-col")+"'"+(h>0?"":" height='"+this.rowHeight+"' ")+(f>0?"":" width='"+this.columnWidth+"' ")+"></td>")}else{var d=c.childNodes;for(var h=0;h<o;h++){var v=d[h],m="",p=l;f==0&&h==0&&(p+=" first-cell");if(v){var g=v.getAttribute("class");if(g){g=g.split(" ");for(var y=g.length-1;y>=0;y-=1)(g[f]=="cell"||g[f]=="first-col"||g[f]=="first-row"||g[f]=="first-cell")&&g.splice(y,1);p+=" "+g.join(" ")}var b=[],w=[],E=v.getAttribute("style");E&&(E=E.replace(new RegExp("#C1C1C1|#c1c1c1","gm"),"#010101"),b.push("style='"+E+"'"));if(f>=0){var S=v.getAttribute("rowSpan");S&&b.push("rowspan="+S+"");var x=v.getAttribute("colSpan");x&&b.push("colspan="+x+"");var T=v.getAttribute("_cellAttr");T&&b.push("_cellAttr='"+T+"'");var N=v.getAttribute("format");N&&b.push('format="'+N+'"'),b.push("noWrap='true'");var C=v.getAttribute("componentId");if(C){var k=C.split(",");for(var L=0;L<k.length;L++){var A=t[k[L]];A&&w.push(A)}}m=v.text}var O=[],M=v.childNodes;for(var y=0,_=M.length;y<_;y++)M[y].nodeType==1?O.push(M[y].outerHTML):O.push(M[y].nodeValue);var D=O.join("");D&&(D=D.replaceAll(">","&gt;").replaceAll("<","&lt;").replaceAll("&lt;br&gt;","<br>")),w.length>0&&(D=(D||"")+w.join("")),n.push("<td "+b.join(" ")+" d_canAddChild='"+(f>0&&h>0?"true":"false")+"' class='"+p+(h>0?"":" first-col")+"'"+(h>0?"":" height='"+this.rowHeight+"' ")+(f>0?"":" width='"+this.columnWidth+"' ")+">"+D+"</td>")}else h>=s&&n.push("<td d_canAddChild='"+(f>0?"true":"false")+"'  class='"+p+(h>0?"":" first-col")+"'"+(h>0?"":" height='"+this.rowHeight+"' ")+(f>0?"":" width='"+this.columnWidth+"' ")+">"+m+"</td>")}}n.push("</tr>")}return n.push("</table>"),this.comIdToCellMap=a,n.join("")},buildCellHtml:function(e,t){var n=[];for(var r=0;r<e;r++)n.push("<td d_canAddChild='true' class='cell'>"+(t||"")+"</td>");return n.join("")},asHtml:function(){var e=this.getMaxRowColIndex();this.updateBeforeCellsHeight(e[0],e[1]);var t=this.getMaxOffset(),n=t.x,r=t.y,i=[];if(n>0&&r>0){var s=this.mainTable.rows;i.push('\n  <table cellspacing="0" cellpadding="0" rowHeight="'+this.rowHeight.replace("px","")+'" columnWidth="'+this.columnWidth.replace("px","")+'"'+' style="border-collapse:collapse;table-layout:fixed;width:1px;">\n');for(var o=0;;o++){var u=s[o];if(!u||u.offsetTop+2>r)break;i.push("     <tr>");var a=u.cells;for(var f=0;;f++){var l=a[f];if(!l||l.offsetLeft+2>n)break;l.noWrap=!0,i.push(this.genaCellHtml(l,o,f))}i.push("</tr>\n")}i.push("  </table>\n")}return i.join("")},updateLayoutContent:function(e,t){e=e||[];var n=this,r=this.asHtml();return xuiDoc.callMethod(this,"setContent",{"layout-data":r,paths:t,removeComIds:e},function(){n.updateAllSelectionUnitBound(),n.domNode.focus()}),r},genaCellHtml:function(e,t,n,r){var i=e.style.cssText,s=e.className;if(s){var o=s.split(" ");for(var u=o.length-1;u>=0;u-=1)(o[u]=="cell"||o[u]=="first-col"||o[u]=="first-row"||o[u]=="first-cell")&&o.splice(u,1);s=o.join(" ")}s=s?' class="'+s+'" ':"",i=i.replace(new RegExp("#010101","gm"),"#C1C1C1");var a=(e.colSpan>1?' colSpan="'+e.colSpan+'"':"")+(e.rowSpan>1?' rowSpan="'+e.rowSpan+'"':"")+s+(i?' style="'+i+'"':""),f=[],l=[],c=e.childNodes;for(var h=0,p=c.length;h<p;h++){var d=c[h];if(d.nodeType==1){var v=this.ownerDesigner.getComponent(d);v?l.push(v.domNode.getAttribute("xid")):d.getAttribute("xid")?l.push(d.getAttribute("xid")):f.push("<"+d.tagName+"/>")}else t!==0&&n!==0&&f.push(d.nodeValue)}if(l.length>0)a+=' componentId="'+l.join(",")+'"';else{var m=e.getAttribute("componentId");m&&(a+=' componentId="'+m+'"')}a=this.buildOtherAttribute(e,a);var g=f.join("");return g&&(g=g.replace(new RegExp("<","gm"),"&lt;"),g=g.replace(new RegExp(">","gm"),"&gt;")),"<td "+a+">"+g+"</td>"},buildOtherAttribute:function(e,t){return t},paintResizeBoxes:function(e,t,n){this.currentCell=e;var r=this.getCellBound(e),i=r.x-3,s=r.y-3,o=r.w,u=r.h,a=[[i+o+(e.parentNode.cells.length-1==e.cellIndex?-2:2),s+u/2],[i+o/2,s+u+(this.mainTable.rows.length-1==e.parentNode.rowIndex?-2:2)]];if(!this.resizeBoxes||this.resizeBoxes.length===0){var f=this.domNode,l=[];n||(n="e,s"),n.indexOf("e")!=-1&&l.push(this.buildResizBoxHtml(a[0],"e","e-resize")),n.indexOf("s")!=-1&&l.push(this.buildResizBoxHtml(a[1],"s","s-resize")),this.resizeBoxes=[];var c=this;$(l.join("")).appendTo(f).each(function(e,t){c.resizeBoxes.push(t)}).bind("mousedown",function(e){$(this).attr("direction")=="e"?c.dragResizeColWidth(e,c.currentCell,c):c.dragResizeRowHeight(e,c.currentCell,c),e.stopPropagation(),e.preventDefault()})}else $(this.resizeBoxes[0]).css("top",a[0][1]).css("left",a[0][0]),$(this.resizeBoxes[1]).css("top",a[1][1]).css("left",a[1][0])},buildResizBoxHtml:function(e,t,n){var r="top:"+e[1]+"px;left:"+e[0]+"px;";return"<div class='select-box' isResizeBox='true' direction='"+t+"' cursor='"+n+"' style='cursor:"+n+";z-index:3500;"+r+"'></div>"},clearResizeBox:function(){if(this.resizeBoxes){for(var e=0,t=this.resizeBoxes.length;e<t;e++)$(this.resizeBoxes[e]).unbind(),this.resizeBoxes[e].parentNode.removeChild(this.resizeBoxes[e]);this.resizeBoxes=null}},containInRect:function(e,t,n){if(e>=n.x&&e<=n.x+n.w&&t>=n.y&&t<=n.y+n.h)return!0},setProperty:function(e){var t=e.name,n=e.value;if(t==="layout-data"){if(n==this.asHtml())return;xuiDoc.repaintComponent(this)}else if(t==="row-height"){if(!n||n=="0")n=19;this.rowHeight=n+"px";var r=this.mainTable.rows;for(var i=1;i<r.length;i++)r[i].cells[0].height=this.rowHeight;this.clearSelectionUnit(),this.updateLayoutContent()}else if(t==="column-width"){if(!n||n=="0")n=80;this.columnWidth=n+"px";var s=this.mainTable.rows[0].cells;for(var i=1;i<s.length;i++)s[i].width=this.columnWidth;this.clearSelectionUnit(),this.updateLayoutContent()}},setCellStyle:function(config){debugger;if(!this.selections)return;if(config["border-color"]||config["border-width"]||config["border-style"])return;delete config.methodType,delete config.methodName;var i=0,j=0,cells;if(!config["cell-layout-border-style"])for(i=0,l=this.selections.length;i<l;i++){var cells=this.selections[i].getCells();for(j=0,cCount=cells.length;j<cCount;j++){cell=cells[j];if(config["border-color"]!==undefined){if(cell.style.borderWidth=="")continue;config["border-color"]==""&&(config["border-color"]="#000000")}if(config["border-style"]!==undefined&&cell.style.borderWidth==="")continue;$(cell).css(config),this.updateMaxPos(cell)}}else{var style;eval("style="+config["cell-layout-border-style"]);var borderStyle=style.style,defaultWidth=style.width+"px",defaultColor=style.color;defaultColor||(defaultColor="#010101");var defaultPattern=style.pattern;for(i=0,l=this.selections.length;i<l;i++){var bound=this.selections[i].getBound();cells=this.selections[i].getCells();for(j=0,cCount=cells.length;j<cCount;j++){config={};var currentCell=cells[j];borderStyle=="border_all"?(config["border-width"]=defaultWidth,config["border-color"]=defaultColor,config["border-style"]=defaultPattern,this.setExtCellStyle(bound,currentCell,!0,!0,defaultWidth,defaultColor,defaultPattern)):borderStyle=="border_remove"?(config["border-width"]="",config["border-color"]="",config["border-style"]="",this.setExtCellStyle(bound,currentCell,!0,!0,"","","")):((borderStyle=="border_left"||borderStyle=="border_outline"||borderStyle=="border_left_right")&&currentCell.offsetLeft==bound.x&&(config["border-left-width"]=defaultWidth,config["border-left-color"]=defaultColor,config["border-left-style"]=defaultPattern,this.setExtCellStyle(bound,currentCell,!0,!1,defaultWidth,defaultColor,defaultPattern)),(borderStyle=="border_right"||borderStyle=="border_outline"||borderStyle=="border_left_right")&&currentCell.offsetLeft+currentCell.offsetWidth==bound.x+bound.w&&(config["border-right-width"]=defaultWidth,config["border-right-color"]=defaultColor,config["border-right-style"]=defaultPattern),(borderStyle=="border_top"||borderStyle=="border_outline"||borderStyle=="border_top_bottom")&&currentCell.offsetTop==bound.y&&(config["border-top-width"]=defaultWidth,config["border-top-color"]=defaultColor,config["border-top-style"]=defaultPattern,this.setExtCellStyle(bound,currentCell,!1,!0,defaultWidth,defaultColor,defaultPattern)),(borderStyle=="border_bottom"||borderStyle=="border_outline"||borderStyle=="border_top_bottom")&&currentCell.offsetTop+currentCell.offsetHeight==bound.y+bound.h&&(config["border-bottom-width"]=defaultWidth,config["border-bottom-color"]=defaultColor,config["border-bottom-style"]=defaultPattern),(borderStyle=="border_center_v"||borderStyle=="border_center_v_h")&&currentCell.offsetLeft+currentCell.offsetWidth!=bound.x+bound.w&&(config["border-right-width"]=defaultWidth,config["border-right-color"]=defaultColor,config["border-right-style"]=defaultPattern),(borderStyle=="border_center_h"||borderStyle=="border_center_v_h")&&currentCell.offsetTop+currentCell.offsetHeight!=bound.y+bound.h&&(config["border-bottom-width"]=defaultWidth,config["border-bottom-color"]=defaultColor,config["border-bottom-style"]=defaultPattern)),$(currentCell).css(config),this.updateMaxPos(currentCell)}}}this.updateLayoutContent()},setExtCellStyle:function(e,t,n,r,i,s,o){if(n&&t.offsetLeft==e.x){var u=this.getPrevTd(t);if(u){var a={};a["border-right-width"]=i,a["border-right-color"]=s,a["border-right-style"]=o,$(u).css(a)}}if(r&&t.offsetTop==e.y){var f=this.getUpTd(t);if(f){var l={};l["border-bottom-width"]=i,l["border-bottom-color"]=s,l["border-bottom-style"]=o,$(f).css(l)}}},setCellStyleStr:function(e){var t=e.style,n=e.isClass,r=e["class"];for(var i=0,s=this.selections.length;i<s;i++){var o=this.selections[i].getCells();for(var u=0,a=o.length;u<a;u++){var f=o[u];if(n=="true"){var l=[],c=f.className;if(c){c=c.split(" ");for(var h=0;h<c.length;h+=1)(c[h]=="cell"||c[h]=="first-cell"||c[h]=="first-col"||c[h]=="first-row")&&l.push(c[h])}r&&l.push(r),f.className=l.join(" ")}else f.style.cssText=t}}this.updateLayoutContent()},setColWidth:function(e,t){t<0&&(t=2),this.mainTable.rows[0].cells[e].style.width=t+"px",this.updateLayoutContent()},setRowHeight:function(e,t){if(t<0)return;this.mainTable.rows[e].cells[0].style.height=t+"px",this.updateLayoutContent()},getCellBound:function(e){return{x:e.offsetLeft,y:e.offsetTop,w:e.offsetWidth,h:e.offsetHeight}},getOwnerCell:function(e){var t=e;while(t){if($(t).hasClass("cell"))return t;t=t.parentNode}return t},getActivteViewPartElement:function(){if(this.currentCell)return this.currentCell},getRowIndics:function(e,t){var n=this.mainTable.rows,r=-1,i=-1;for(var s=0,o=n.length;s<o;s++){var u=n[s].offsetTop+2;u>=e&&r==-1&&(r=s);if(u>=t){i=s-1;break}}return i==-1&&(i=n.length-1),[r,i]},getFirstRowCellByPos:function(e){var t=this.mainTable.rows,n=t[0],r=n.cells;for(var i=0,s=r.length;i<s;i++)if(e>=r[i].offsetLeft&&e<r[i].offsetLeft+r[i].offsetWidth)return r[i]},getFirstColCellByPos:function(e){var t=this.mainTable.rows;for(var n=1,r=t.length;n<r;n++){var i=t[n].cells[0];if(e>=i.offsetTop&&e<i.offsetTop+i.offsetHeight)return i}},getMaxOffset:function(){var e=this.mainTable.rows,t=0,n=0;for(var r=e.length-1;r>0;r--){var i=e[r].cells;for(var s=i.length-1;s>0;s--){var o=i[s];if(o.colSpan>1||o.rowSpan>1||o.firstChild||o.style.cssText&&o.style.cssText!="HEIGHT: 19px"||o._cellAttr){var u=this.getCellBound(o);t=Math.max(u.x+u.w,t),n=Math.max(u.y+u.h,n)}}}return{x:t,y:n}},getMaxRowColIndex:function(){var e=this.getMaxOffset(),t=e.x,n=e.y;if(t>0&&n>0){var r=this.getRowColIndex(t-3,n-3);return[r[0]-1,r[1]-1]}return[-1,-1]},getRowColIndex:function(e,t){var n=this.mainTable.rows,r=n[0],i=r.cells,s=-1,o=-1,u=0,a=i.length;for(u=0;u<a;u++)if(i[u].offsetLeft+2>=e){s=u;break}for(u=0,a=n.length;u<a;u++)if(n[u].offsetTop+2>=t){o=u;break}return s==-1&&(s=i.length),o==-1&&(o=n.length),[o,s]},getCells:function(e,t,n,r){var i=this.mainTable.rows,s=[];for(var o=e;o<=t;o++){var u=i[o].cells;for(var a=0,f=u.length;a<f;a++){var l=u[a];if(!l)break;var c=l.offsetLeft;if(c>=n&&c<r)s.push(l);else if(c>r)break}}return s},createSelectionUnit:function(e){if(!e)return;var t=this.domNode.getAttribute("d_id");if(!this.getSelectionUnit(e)){this.lastSelectCell=e,this.selections.push((new SelectionUnit(this)).setBound(this.getCellBound(e))),this.paintResizeBoxes(e),this.selctionChangeCaller&&(clearTimeout(this.selectionClearCaller),this.selectionClearCaller=null,clearTimeout(this.selctionChangeCaller),this.selctionChangeCaller=null);var n=this,r=e.className,i=[];if(r){r=r.split(" ");for(var s=0;s<r.length;s+=1)r[s]!="cell"&&r[s]!="first-cell"&&r[s]!="first-col"&&r[s]!="first-row"&&i.push(r[s])}this.selctionChangeCaller=setTimeout(function(){n.ownerDesigner&&n.ownerDesigner.dispatchEvent({className:i.join(" "),event:"cellLayoutSelectionChanged",id:t,path:$(e).getPath(),style:e.style.cssText,value:e.innerHTML})},400)}},getSelectionUnit:function(e){for(var t=0,n=this.selections.length;t<n;t++)if(this.containInRect(e.offsetLeft+2,e.offsetTop+2,this.selections[t].getBound()))return this.selections[t]},getDId:function(){return this.domNode.getAttribute("d_id")},clearSelectionUnit:function(e){for(var t=0,n=this.selections.length;t<n;t++)this.selections[t].dispose();this.selections=[],this.lastSelectCell=null,this.currentCell=null,this.headerSelectRowIndex=-1,this.headerSelectRowIndex=-1,this.clearResizeBox(),this.selectionClearCaller&&(clearTimeout(this.selectionClearCaller),this.selectionClearCaller=null);if(e===!0)return;var r=this;r.mouseDownFlag?r.ownerDesigner.dispatchEvent({event:"cellLayoutClearSeleection",id:r.getDId()}):this.selectionClearCaller=setTimeout(function(){r.ownerDesigner&&r.ownerDesigner.dispatchEvent({event:"cellLayoutClearSeleection",id:r.getDId()})},400)},_fetchComIds:function(e,t,n){var r=e.childNodes;for(var i=r.length-1;i>=0;i--)if(r[i]&&r[i].nodeType==1){var s=r[i].getAttribute("d_id");s&&(t.push(s),n.push($(r[i]).getPath()))}},getComIds:function(e,t,n){e=e.length||e.length===0?e:[e];for(var r=e.length-1;r>=0;r--)this._fetchComIds(e[r],t,n)},colRowIndicsMap:{},deleteCells:function(e,t,n,r,i){this.stopFireUpdateContent=!0;var s=0;try{e=e.length||e.length===0?e:[e];if(r)for(s=e.length-1;s>=0;s--)this._fetchComIds(e[s],r,i);if(!r){r=[],i=[];for(s=e.length-1;s>=0;s--)this._fetchComIds(e[s],r,i);r.length>0&&this.ownerDesigner.dispatchEvent({event:"removeSelections",selections:JSON.stringify(r),paths:i})}for(s=e.length-1;s>=0;s--)n||(t||e[s].parentNode).removeChild(e[s]);if(n)for(s=e.length-1;s>=0;s--)e[s].innerHTML="",e[s].setAttribute("componentId","")}finally{this.stopFireUpdateContent=!1}},clearCellContent:function(){var e=this.selections.length,t=[],n=[];this.colRowIndicsMap={};for(var r=0;r<e;r++){var i=this.selections[r].getCells();this.deleteCells(i,null,!0,t,n)}e>0&&this.updateLayoutContent(t,n)},executeSelect:function(e,t){if(!t)return;var n=this.selections.length;if(e.ctrlKey)this.createSelectionUnit(t);else if(e.shiftKey&&n>0){var r=e.target;r=this.getOwnerCell(r);if(!r||r.tagName!="TD"||r.getAttribute("d_canAddChild")!="true")return;this.updateSelectionUnit(r)}else this.currentCell!=t&&(this.clearSelectionUnit(),this.createSelectionUnit(t))},dragSelect:function(e,t,n){try{var r=n.getSelectionUnit(t);if(!r)return;n.domNode.style.cursor="default";var i=function(e){var t=e.target;t=n.getOwnerCell(t);if(!t||t.tagName!="TD"||t.getAttribute("d_canAddChild")!="true")return;n.updateSelectionUnit(t),n.isDragSelect=!0,e.stopPropagation()},s=function(e){$(n.domNode).unbind("mouseover",i).unbind("mouseup",s),n.isDragSelect=!1,e.stopPropagation()};$(n.domNode).bind("mouseover",i).bind("mouseup",s)}catch(o){alert("选择出错"+o)}},updateMaxPos:function(e){var t=this.getCellBound(e);this.maxPos.x=Math.max(this.maxPos.x,t.x+t.w-2),this.maxPos.y=Math.max(this.maxPos.y,t.y+t.h-2)},dragResizeColWidth:function(e,t,n){n.isResize=!0;var r=document,i=t.offsetWidth-1,s=n.domNode.clientHeight,o=$("<div class='col-resize-line' style='top:"+n.domNode.scrollTop+"px;left:"+t.offsetLeft+"px;width:"+i+"px;height:"+s+"px'></div>").appendTo(n.domNode),u=i,a=e.clientX;r.onmousemove=function(e){var t=(e||window.event).clientX-a+i;t>5&&o.css("width",u=t)},r.onmouseup=function(e){n.isResize=!1,o.remove(),o=null,r.onmousemove=null,r.onmouseup=null,r=null;if(u!=i){var s=n.getCellBound(t),a=n.getFirstRowCellByPos(s.x+s.w-2);a&&n.setColWidth(a.cellIndex,a.offsetWidth+(u-i))}}},dragResizeRowHeight:function(e,t,n){n.isResize=!0;var r=document,i=t.offsetHeight-1,s=n.domNode.clientWidth,o=$("<div class='row-resize-line' style='top:"+t.offsetTop+"px;left:"+n.domNode.scrollLeft+"px;width:"+s+"px;height:"+i+"px'></div>").appendTo(n.domNode),u=i,a=e.clientY;r.onmousemove=function(e){var t=(e||window.event).clientY-a+i;t>5&&o.css("height",u=t)},r.onmouseup=function(e){n.isResize=!1,o.remove(),o=null,r.onmousemove=null,r.onmouseup=null,r=null;if(u!=i){var s=n.getCellBound(t),a=n.getFirstColCellByPos(s.y+s.h-2);a&&n.setRowHeight(a.parentNode.rowIndex,a.offsetHeight+(u-i))}}},showLabelInput:function(e){var t=e.childNodes;for(var n=0,r=t.length;n<r;n++)if(t[n].nodeType==1&&t[n].component)return;document.body.onselectstart="";var i=$("<textarea  style='top:"+e.offsetTop+"px;left:"+e.offsetLeft+"px;border:1px solid;position:absolute;font:normal 12px 宋体, arial, serif;overflow:visible;word-wrap:normal;z-index:8000;overflow-y:hidden'/>")[0],s=e.innerHTML;i.value=s.replaceAll("&nbsp;"," ").replaceAll("<br>","\n").replaceAll("&lt;","<").replaceAll("&gt;",">");var o=this.calcTextSize(i.value);$(i).css({width:Math.max(e.offsetWidth,o.w)+"px",height:Math.max(e.offsetHeight,o.h)+"px"}),this.domNode.appendChild(i),i.onmousedown=function(e){e.stopPropagation()},i.onmouseup=function(e){e.stopPropagation()},i.onmousemove=function(e){e.stopPropagation()},i.onkeydown=function(t){t.keyCode==13&&(t.altKey?insertface(i,"\r\n"):(i.blur(),u.createSelectionUnit(e),setTimeout(function(){u.domNode.focus()},100)));var n=u.calcTextSize(i.value);$(i).css({width:Math.max(e.offsetWidth,n.w)+"px",height:Math.max(e.offsetHeight,n.h)+"px"}),t.stopPropagation()};var u=this;u.currentTextInput=i,i.onblur=function(t){document.body.onselectstart=function(){return!1};var n=i.value||"",r=n.replaceAll(" ","&nbsp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll("\n","<br>");$(e).html(r),u.updateMaxPos(e),u.currentTextInput=null,u.labelChanging=!1,setTimeout(function(){$(i).remove()},100),u.updateLayoutContent(),e.focus()},i.focus(),i.selectionStart=i.selectionEnd=i.value.length},getLayoutData:function(e){e=e||{},e.layoutData=this.asHtml()},mergeCell:function(){var e=[],t=0,n=this.selections.length;for(t=0;t<n;t++)e.push(this.selections[t].getBound());if(this.hasIntersection(e)){alert("选择区域存在交集，不能合并");return}var r=[],i=[];this.colRowIndicsMap={};for(t=0,n=this.selections.length;t<n;t++){var s=this.selections[t].getBound(),o=s.x-2,u=s.x+s.w-2,a=this.getRowColIndex(s.x+1,s.y+1),f=this.getRowColIndex(s.x+s.w-3,s.y+s.h-3),l=f[0]-a[0],c=f[1]-a[1],h=this.getCells(a[0],f[0]-1,o,u);c>1&&(h[0].colSpan=c),l>1&&(h[0].rowSpan=l);var p=h[0];h.splice(0,1),this.deleteCells(h,null,null,r,i),this.paintResizeBoxes(p,!0),this.updateMaxPos(p),this.selections[t].reGetCells()}this.updateLayoutContent(r,i)},cancelCellMerging:function(e){var t=this.mainTable.rows;for(var n=0,r=this.selections.length;n<r;n++){var i=this.selections[n].getBound(),s=i.x-2,o=i.x+i.w-2,u=this.getRowColIndex(i.x+1,i.y+1),a=this.getRowColIndex(i.x+i.w-3,i.y+i.h-3),f=a[0]-u[0],l=a[1]-u[1],c=this.getCells(u[0],a[0]-1,s,o);for(var h=0,p=c.length;h<p;h++){l=c[h].colSpan,f=c[h].rowSpan,l>1&&($(this.buildCellHtml(l-1)).insertAfter(c[h]),c[h].colSpan=1);if(f>1){var d=this.buildCellHtml(l),v=c[h].offsetLeft,m=this.getRowIndics(c[h].offsetTop,c[h].offsetTop+c[h].clientHeight);for(var g=m[0]+1;g<=m[1];g++){var y=t[g].cells;for(var b=0,w=y.length;b<w;b++){var E=y[b],S=y[b+1];if(E.offsetLeft<v&&(S&&S.offsetLeft>v||!S)){$(d).insertAfter(E);break}}}c[h].rowSpan=1}}}this.paintResizeBoxes(this.currentCell,!0),e!==!1&&this.updateLayoutContent()},insertRowAfter:function(){this.insertRow(!0)},insertRow:function(e){if(this.selections.length>1){alert("有多个选择区域时不能插入");return}if(this.selections.length===0){alert("请选择单元格");return}var t=this.selections[0],n=0,r=-1,i=0,s;if(t&&t.getCells().length>0){var o=t.getCells()[0],u=o.parentNode,a=u.previousSibling;r=u.rowIndex;while(a){for(i=0;i<a.cells.length;i++)s=a.cells[i],s.rowSpan>=2&&a.rowIndex+s.rowSpan>r&&(s.rowSpan=s.rowSpan+1,n+=s.colSpan);a=a.previousSibling}}else this.headerSelectRowIndex>=0&&(r=this.headerSelectRowIndex);e===!0&&r++;var f=0,l=this.mainTable.rows[0].cells.length-n,c=r!=-1?this.mainTable.insertRow(r):this.mainTable.insertRow();c.setAttribute("d_canAddChild","false");for(i=0;i<l;i++)s=c.insertCell(i),s.className="cell"+(i===0?" first-col":""),i===0&&(s.height=this.rowHeight),s.setAttribute("d_canAddChild","true"),i===0&&(f=s.offsetHeight);this.updateLayoutContent()},insertColAfter:function(){this.insertCol(!0)},insertCol:function(e){if(this.selections.length>1){alert("有多个选择区域时不能插入");return}if(this.selections.length===0){alert("请选择单元格");return}var t=this.selections[0],n=0,r;if(t&&t.getCells().length>0||this.headerSelectColIndex>=0){var i=null;this.headerSelectColIndex>=0?i=this.currentCell:i=t.getCells()[0];var s=this.getColIndex(i);e===!0&&s++;var o=this.mainTable.rows.length,u=[],a=[],f=[];for(n=0;n<o;n++){r=this.mainTable.rows[n],u[n]=r.cells.length;for(var l=1,c=r.cells.length;l<c;l++){var h=r.cells[l],p=h.cellIndex;if(n<=o){p=this.getColIndex(h);if(p==-1)break}if(p==s){u[n]=h.cellIndex;break}if(h.colSpan>=2&&p+h.colSpan>s){a.push(h),f.push(h.colSpan+1);break}if(p+1==s){var d=h.nextSibling;if(d){u[n]=d.cellIndex;break}}else if(p>s)break}}for(n=0;n<a.length;n++)a[n].colSpan=f[n];var v=0;for(n=0;n<this.mainTable.rows.length;n++)if(u[n]!=-1){r=this.mainTable.rows[n];var m=r.insertCell(u[n]);m.className="cell"+(n===0?" first-row":""),n===0&&(m.width=this.columnWidth),m.setAttribute("d_canAddChild","true"),n===0&&(v=m.offsetWidth)}}else for(n=0;n<this.mainTable.rows.length;n++){r=this.mainTable.rows[n];var g=r.insertCell();g.className="cell"+(n===0?" first-row":""),n===0&&(g.width=this.columnWidth),g.setAttribute("d_canAddChild","true")}this.updateLayoutContent()},deleteRow:function(){if((!this.selections[0]||this.selections[0].getCells().length===0)&&this.headerSelectRowIndex<0)return;var e=[],t=0,n=0,r=0;if(this.headerSelectRowIndex>=0)e=[this.mainTable.rows[this.headerSelectRowIndex]];else{var i={};for(t=0;t<this.selections.length;t++){var s=this.selections[t].getCells();for(n=0;n<s.length;n++){var o=s[n].parentNode,u=o.rowIndex;i["_"+u]||(e.push(o),i["_"+u]=!0);for(r=1;r<s[n].rowSpan;r++)i["_"+(u+r)]||(e.push(this.mainTable.rows[u+r]),i["_"+(u+r)]=!0)}}e=e.sort(function(e,t){return e.rowIndex>t.rowIndex})}var a=e[e.length-1].previousSibling;while(a){for(t=0;t<a.cells.length;t++){var f=a.cells[t];if(f.rowSpan>=2)for(n=0;n<e.length;n++)a.rowIndex+f.rowSpan>e[n].rowIndex&&(f.rowSpan=f.rowSpan-1)}a=a.previousSibling}var l=[],c=[];this.colRowIndicsMap={};for(t=e.length-1;t>=0;t--){var h=e[t];for(n=0;n<h.cells.length;n++){var p=h.cells[n];if(p.rowSpan>=2){var d=this.getColIndex(p),v=h.nextSibling;for(r=0;r<v.cells.length;r++){var m=v.cells[r],g=this.getColIndex(m);if(g>=d){var y=v.insertCell(m.cellIndex);y.rowSpan=p.rowSpan-1,y.colSpan=p.colSpan,y.className="cell",y.setAttribute("d_canAddChild","true");break}}}}this.deleteCells(h.cells,h,null,l,c),this.mainTable.deleteRow(h.rowIndex)}this.clearSelectionUnit(),this.updateLayoutContent(l,c)},deleteCol:function(){if((!this.selections[0]||this.selections[0].getCells().length===0)&&this.headerSelectColIndex<0)return;var e=[],t=0,n=0,r,i=[];if(this.headerSelectColIndex>=0)i.push(this.getCellBound(this.mainTable.rows[0].cells[this.headerSelectColIndex]));else for(n=0;n<this.selections.length;n++)i.push(this.selections[n].getBound());for(t=0;t<this.mainTable.rows.length;t++){r=this.mainTable.rows[t];for(var s=0;s<r.cells.length;s++){var o=r.cells[s],u=this.getCellBound(o);for(n=0;n<i.length;n++){var a=i[n];if(Math.max(u.x,a.x)<Math.min(u.x+u.w,a.x+a.w)){var f={};f.rowIndex=t,f.cellIndex=o.cellIndex,o.colSpan>1?f.colSpan=o.colSpan-1:f.del=!0,e.push(f);break}}}}var l=[],c=[];this.colRowIndicsMap={};for(t=e.length-1;t>=0;t--){var h=e[t].rowIndex,p=e[t].cellIndex;r=this.mainTable.rows[h],e[t].del?this.deleteCells(r.cells[p],r,null,l):r.cells[p].colSpan=e[t].colSpan}this.clearSelectionUnit(),this.updateLayoutContent(l,c)},getColIndex:function(e){try{var t=this.getCellBound(e),n=this.getFirstRowCellByPos(t.x,t.w-2);return n.cellIndex}catch(r){return-1}},getSectionsColIndexes:function(){var e=[],t=this.mainTable.rows[0].cells;for(var n=1;n<t.length;n++){var r=this.getCellBound(t[n]);for(var i=0;i<this.selections.length;i++){var s=this.selections[i].getBound();if(r.x>=s.x&&r.x<s.x+s.w){e.push(t[n].cellIndex);break}}}return e},calcTextSize:function(e){var t=window.tempSpan;t||(t=document.createElement("span"),t.style.position="absolute",t.style.top="-100px",t.style.font="normal 13px 宋体, arial, serif;",document.body.appendChild(t),window.tempSpan=t),t.style.display="",t.innerHTML=e.replaceAll("\n","<br>").replaceAll(" ","&nbsp;");var n=t.offsetWidth+20,r=t.offsetHeight+10;return t.style.display="none",{w:n,h:r}},gotoPrevTd:function(e,t){var n=this.getPrevTd(e);n&&n.cellIndex>0&&(n.offsetLeft<this.domNode.scrollLeft&&(this.domNode.scrollLeft=n.offsetLeft),t?this.updateSelectionUnit(n):(this.clearSelectionUnit(),this.createSelectionUnit(n)))},getPrevTd:function(e){var t=this.getCellBound(e),n=this.getFirstRowCellByPos(t.x,t.w-2),r=n.previousSibling;if(!r)return;var i=this.getCellBound(r),s=null,o=e.parentNode;if(e.rowSpan>1)try{o=this.mainTable.rows[this.moveRowIndex]}catch(u){}while(o&&!s){for(var a=1,f=o.cells.length;a<f;a++){var l=this.getCellBound(o.cells[a]);if(Math.max(i.x,l.x)<Math.min(i.x+i.w,l.x+l.w)){s=o.cells[a];break}}o=o.previousSibling}return s},gotoNextTd:function(e,t){var n=this.getCellBound(e),r=this.getFirstRowCellByPos(n.x,n.w-2),i=r.nextSibling;if(!i)return;var s=0;for(s=1;s<e.colSpan;s++)i&&(i=i.nextSibling);if(!i)return;var o=this.getCellBound(i),u=null,a=e.parentNode;if(e.rowSpan>1)try{a=this.mainTable.rows[this.moveRowIndex]}catch(f){}while(a&&!u){var l=a.cells.length;for(s=1;s<l;s++){var c=this.getCellBound(a.cells[s]);if(Math.max(o.x,c.x)<Math.min(o.x+o.w,c.x+c.w)){u=a.cells[s];break}}a=a.previousSibling}u&&(u.offsetLeft+u.offsetWidth+20>this.domNode.scrollLeft+this.domNode.offsetWidth&&(this.domNode.scrollLeft=this.domNode.scrollLeft+u.offsetWidth),t?this.updateSelectionUnit(u):(this.clearSelectionUnit(),this.createSelectionUnit(u)))},gotoUpTd:function(e,t){var n=this.getUpTd(e);if(!n||n.parentNode.rowIndex===0)return;n.offsetTop<this.domNode.scrollTop&&(this.domNode.scrollTop=n.offsetTop),t?this.updateSelectionUnit(n):(this.clearSelectionUnit(),this.createSelectionUnit(n)),this.moveRowIndex=n.parentNode.rowIndex},getUpTd:function(e){var t=null,n=e.parentNode.previousSibling;while(n&&!t){var r=this.getCellBound(e);for(var i=1,s=n.cells.length;i<s;i++){var o=this.getCellBound(n.cells[i]);if(Math.max(r.x,o.x)<Math.min(r.x+r.w,o.x+o.w)){t=n.cells[i];break}}n=n.previousSibling}return t},gotoDownTd:function(e,t){var n=null,r=e.parentNode.nextSibling;while(r&&!n){var i=this.getCellBound(e);for(var s=1,o=r.cells.length;s<o;s++){var u=this.getCellBound(r.cells[s]);if(Math.max(i.x,u.x)<Math.min(i.x+i.w,u.x+u.w)){n=r.cells[s];break}}r=r.nextSibling}if(!n)return;n.offsetTop+n.offsetHeight+20>this.domNode.scrollTop+this.domNode.offsetHeight&&(this.domNode.scrollTop=this.domNode.scrollTop+n.offsetHeight),t?this.updateSelectionUnit(n):(this.clearSelectionUnit(),this.createSelectionUnit(n)),this.moveRowIndex=n.parentNode.rowIndex},updateAllSelectionUnitBound:function(){for(var e=0;e<this.selections.length;e++){var t=this.selections[e];t.updateBound()}this.paintResizeBoxes(this.currentCell)},updateSelectionUnit:function(e){this.currentCell=e||this.currentCell;if(!this.currentCell)return;var t=this,n=t.getCellBound(this.lastSelectCell),r=n.x,i=n.y,s=r+n.w,o=i+n.h;if($(e).hasClass("first-row")||$(e).hasClass("first-col"))return;var u=t.getCellBound(e),a=Math.min(r,u.x),f=Math.min(i,u.y),l=Math.max(s,u.x+u.w)-a,c=Math.max(o,u.y+u.h)-f;this.selections[this.selections.length-1].setBound({x:a,y:f,w:l,h:c}),t.paintResizeBoxes(e,!0)},hasIntersection:function(e){for(var t=0;t<e.length;t++){var n=e[t];for(var r=t+1;r<e.length;r++){var i=e[r];if(Math.max(n.x,i.x)<Math.min(n.x+n.w,i.x+i.w)&&Math.max(n.y,i.y)<Math.min(n.y+n.h,i.y+i.h))return!0}}return!1},importFromExcel:function(){},getCurrentCellValue:function(){return this.currentCell?this.currentCell.innerHTML:""},setCurrentCellValue:function(e){this.currentCell&&(this.currentCell.innerHTML=e.data)},getCurrentCellProperties:function(){var e={width:80,height:19},t=this.getSelectionsRows(),n=0;for(;n<t.length;n++){var r=t[n],i=r.cells[0].style.height;if(n===0)i?e.height=i:e.height="19px";else if(i&&i!=e.height){e.height="0px";break}}e.height=parseInt(e.height.replace("px",""),10);var s=this.getSectionsColIndexes();for(n=0;n<s.length;n++){var o=this.mainTable.rows[0].cells[s[n]];if(n===0)e.width=o.offsetWidth-1;else if(e.width!=o.offsetWidth-1){e.width=0;break}}return JSON.stringify(e)},setCellProperties:function(e){var t=[],n=0,r;for(;n<this.selections.length;n++){var i=this.selections[n];r=i.getCells(),r.length>0&&t.push({sel:i,cells:r})}if(e.columnWidth>0){var s=this.getSectionsColIndexes();for(n=0;n<s.length;n++)this.mainTable.rows[0].cells[s[n]].style.width=e.columnWidth+"px"}if(e.rowHeight>0){var o=this.getSelectionsRows();for(n=0;n<o.length;n++)o[n].cells[0].style.height=e.rowHeight+"px"}this.updateLayoutContent()},getSelectionsRows:function(){var e=[];if(this.headerSelectRowIndex>=0)e=[this.mainTable.rows[this.headerSelectRowIndex]];else{var t={};for(var n=0;n<this.selections.length;n++){var r=this.selections[n].getCells();for(var i=0;i<r.length;i++){var s=r[i].parentNode,o=s.rowIndex;t["_"+o]||(e.push(s),t["_"+o]=!0);for(var u=1;u<r[i].rowSpan;u++)t["_"+(o+u)]||(e.push(this.mainTable.rows[o+u]),t["_"+(o+u)]=!0)}}e=e.sort(function(e,t){return e.rowIndex>t.rowIndex})}return e},updateBeforeCellsHeight:function(e,t){for(var n=1;n<=e;n++){var r=this.mainTable.rows[n];if(!r)break;var i=r.cells.length,s=r.cells[0].style.height;s?s=parseInt(s.replace("px",""),10):s=19;var o;for(var u=1;u<=t&&u<i;u++){var a=r.cells[u];if(!a)break;if(a.rowSpan<2)a.style.height=s+"px";else{var f=s;for(o=1;o<a.rowSpan;o++){var l=this.mainTable.rows[n+o].cells[0].style.height;l?l=parseInt(l.replace("px",""),10):l=19,f+=l}a.style.height=f+"px"}var c=a.childNodes,h=c.length;for(o=0;o<h;o++)c[o].tagName=="TEXTAREA"&&(c[o].style.height=a.style.height)}}},showHideCellBorder:function(){var e=this.mainTable.className;e.indexOf("nocellborder")==-1?e+=" nocellborder":e=e.replace("nocellborder",""),this.mainTable.className=e},getCell:function(e,t){var n=this.mainTable.rows[e];if(n)return n.cells[t]}};var quickIdeEx={"$UI/system/components/justep/cellLayout/cellLayout":{styleConfig:function(e){return[e.getCommonStyleItem("font"),e.getCommonStyleItem("baseStyle"),e.getCommonStyleItem("border")]}}};return{"$UI/system/components/justep/cellLayout/cellLayout":CellLayout,quickIdeEx:quickIdeEx}});