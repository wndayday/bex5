/*! 
* WeX5 v3 (http://www.justep.com) 
* Copyright 2015 Justep, Inc.
* Licensed under Apache License, Version 2.0 (http://www.apache.org/licenses/LICENSE-2.0) 
*/

define("$model/UI2/system/components/justep/cellLayout/designer/cellLayout1",["require","jquery","css!./css/cellLayout","$UI/system/components/designerCommon/js/xuiService","$UI/system/lib/base/xml"],function(e){function s(e,t){if(document.selection){var n=document.selection.createRange().text;n||(n=t),e.focus(),n.charAt(n.length-1)==" "?(n=n.substring(0,n.length-1),document.selection.createRange().text=n+" "):document.selection.createRange().text=n}else if(e.selectionStart||e.selectionStart=="0"){var r=e.selectionStart,i=e.selectionEnd,s=e.value.substring(r,i),o;s||(s=t),s.charAt(s.length-1)==" "?o=s.substring(0,s.length-1)+" ":o=s,e.value=e.value.substring(0,r)+o+e.value.substring(i,e.value.length),e.focus();var u=r+s.length;e.selectionStart=u,e.selectionEnd=u}else e.value+=t,e.focus();e.createTextRange&&(e.caretPos=document.selection.createRange().duplicate())}var t=e("jquery");e("css!./css/cellLayout").load();var n=e("$UI/system/components/designerCommon/js/xuiService"),r=n.getXuiDoc(),i=e("$UI/system/lib/base/xml"),o=function(e){this.ownerCom=e};String.prototype.replaceAll=function(e,t){return this.replace(new RegExp(e,"gm"),t)},o.prototype={setBound:function(e){this.bound=e;var n=this.ownerCom.domNode,r=e.x,i=e.y,s=e.w-1,o=e.h-1;if(!this.lines){var u="black",a="solid",f=";overflow:visible;font-size:0px;z-index:2200;position:absolute;",l=[];l.push("top:"+i+"px;left:"+r+"px;width:1px;height:"+o+"px;line-height:0px;"+";border-left:2px "+a+" "+u+f),l.push("top:"+i+"px;left:"+r+"px;width:"+s+"px;height:1px;line-height:0px;"+";border-top:2px "+a+" "+u+f),l.push("top:"+i+"px;left:"+(r+s)+"px;width:1px;height:"+(o+1)+"px;line-height:0px;"+";border-left:2px "+a+" "+u+f),l.push("top:"+(i+o)+"px;left:"+r+"px;width:"+s+"px;height:1px;line-height:0px;"+";border-top:2px "+a+" "+u+f),this.lines=[];var c=0;for(c=0,r=l.length;c<r;c++)this.lines.push(this._paintLine(n,l[c]))}else t(this.lines[0]).css({top:i+"px",left:r+"px",height:o+"px"}),t(this.lines[1]).css({top:i+"px",left:r+"px",width:s+"px"}),t(this.lines[2]).css({top:i+"px",left:r+s+"px",height:o+2+"px"}),t(this.lines[3]).css({top:i+o+"px",left:r+"px",width:s+"px"});return this.cells=this.getCells(),this},reGetCells:function(){this.cells=this.getCells()},updateBound:function(){var e=this.cells[0],t=this.cells[this.cells.length-1],n=this.ownerCom.getCellBound(e),r=this.ownerCom.getCellBound(t),i=n.x,s=n.y,o=r.x-n.x+r.w,u=r.y-n.y+r.h;this.setBound({x:i,y:s,w:o,h:u})},_paintLine:function(e,t,n){var r=document.createElement("div");return e.appendChild(r),r.className="cell-select-line",r.style.cssText=t,r},getCells:function(){return this.getCellsWithColRowIndics()[2]},getCellsWithColRowIndics:function(){var e=this.getBound(),t=e.x-2,n=e.x+e.w-2,r=this.ownerCom.getRowColIndex(e.x+1,e.y+1),i=this.ownerCom.getRowColIndex(e.x+e.w-3,e.y+e.h-3),s=this.ownerCom.getCells(r[0],i[0]-1,t,n);return[r,i,s]},getBound:function(){return this.bound},dispose:function(){if(this.lines)for(var e=0,t=this.lines.length;e<t;e++)this.lines[e].parentNode.removeChild(this.lines[e]);this.lines=null}};var u=function(e){this.selctionChangeCaller=null,this.selectionClearCaller=null,this.selections=[],this.preAddChild={},this.maxPos={x:0,y:0},this.domNode=this.templateNode=e.templateNode,this.domNode.setAttribute("tabindex","0")};u.prototype={init:function(){this.paintContent(this.templateNode)},showMenu:function(e){if(!this.ownerDesigner.showMenu)return;var n=e.target,r=t(this.ownerDesigner.element).offset(),i=e.clientY-r.top,s=e.clientX-r.left;this.ownerDesigner.showMenu(this.domNode,s,i)},paintContent:function(e){var n=this;t(this.domNode).on("childChanged",function(e){setTimeout(function(){n.updateLayoutContent()},100)}),this.isInit=!0,this.rowHeight=e.getAttribute("row-height"),this.columnWidth=e.getAttribute("column-width");if(!this.rowHeight||this.rowHeight=="0")this.rowHeight="19";if(!this.columnWidth||this.columnWidth=="0")this.columnWidth="80";this.rowHeight+="px",this.columnWidth+="px";var r=e.childNodes,i,s={};for(var o=0,u=r.length;o<u;o++){var a=r[o];if(a.nodeType!=1)continue;if(a.tagName.toLowerCase()=="layout-content")if(this.ownerDesigner.dataModel)i=this.ownerDesigner.dataModel.getPropValue(this.domNode.getAttribute("d_id"),"layout-data"),i&&(i=t(i)[0]);else{var f=a.childNodes,l=[];for(var c=0;c<f.length;c++)f[c].nodeType==3&&l.push(f[c].nodeValue);i=t(l.join(""))[0]}else a.nodeType===1&&(s[a.getAttribute("xid")]=a.outerHTML)}e.innerHTML="",this._init(i,s),this.isInit=!1;var h=this.getMaxRowColIndex();this.updateBeforeCellsHeight(h[0],h[1])},_init:function(e,n){var r=this,i=this._buildHtml(e,n);this.domNode.innerHTML=i,this.mainTable=this.domNode.childNodes[0];var s=!1,o,u,a;t(this.domNode).bind("mousedown",function(e){u=e.clientX,a=e.clientY;if(r.ownerDesigner.ctx.action!==null)return;e.button==2?r.showMenu(e):r.ownerDesigner.hideMenu();var n=e.target,i=t(e.target);if(i.hasClass("cell")){if(e.button==2&&r.getSelectionUnit(e.target)){e.stopPropagation();return}if(n.getAttribute("d_canAddChild")!="true"){r.clearSelectionUnit();return}r.mouseDonwCell=n,r.ownerDesigner.clearSelections(),r.ownerDesigner.clearResizeBoxes(),r.executeSelect(e,n),r.currentCell=n,o=n,r.moveRowIndex=o.parentNode.rowIndex,e.stopPropagation(),r.ownerDesigner.clearCompTip()}}).bind("mouseup",function(e){s=!1,o=null;var n=t(e.target);r.ownerDesigner.ctx.action===null&&(n.hasClass("cell")||n.hasClass("cell-select-line"))&&e.button==2&&r.ownerDesigner.dispatchEvent({event:"contextmenu",selections:JSON.stringify([r.domNode.getAttribute("d_id")]),componentNames:JSON.stringify([r.domNode.getAttribute("componentName")])})}).bind("mousemove",function(e){!s&&o&&(Math.abs(e.clientX-u)>1||Math.abs(e.clientY-a)>1)&&(s=!0,r.dragSelect(e,o,r))}).bind("dblclick",function(e){var n=e.target;if(n.tagName=="TD"&&t(n).hasClass("cell")&&n.getAttribute("d_canAddChild")=="true"){var i=n.childNodes;for(var s=0;s<i.length;s+=1)if(i[s].nodeType==1&&i[s].tagName!="BR")return;r.ownerDesigner.focusable=!1,r.showLabelInput(n),setTimeout(function(){r.ownerDesigner.focusable=!0},800)}}).bind("keydown",function(e){if(!r.currentCell)return;var t=e.keyCode;if(t==37)return r.gotoPrevTd(r.currentCell,e.shiftKey),!1;if(t==39||t==9)return t==9&&e.shiftKey?r.gotoPrevTd(r.currentCell,!1):r.gotoNextTd(r.currentCell,e.shiftKey),!1;if(t==38)return r.gotoUpTd(r.currentCell,e.shiftKey),!1;if(t==40||t==13){if(t!=13||!e.shiftKey)return r.gotoDownTd(r.currentCell,e.shiftKey),!1;r.gotoUpTd(r.currentCell,!1)}else if(t==32||t==113)r.showLabelInput(r.lastSelectCell),e.preventDefault();else if(t==46)e.stopPropagation(),r.clearCellContent();else if(!e.ctrlKey||e.keyCode!=67&&e.keyCode!=88)if(t==27&&r.selections&&r.selections.length>0)return r.clearSelectionUnit(),r.ownerDesigner.setSelection(r.domNode),r.ownerDesigner.dispatchSelectionChangedEvent(),!1})},endCellEdit:function(){this.currentTextInput&&this.currentTextInput.blur()},copyCells:function(e){if(this.selections.length>1){alert("不能同时复制多个区域");return}if(this.selections.length==1){var t={},n=this.selections[0].getCellsWithColRowIndics(),r=n[0],i=n[1],s=i[1]-r[1],o=i[0]-r[0],u=n[2],a=[],f=[];for(var l=0,c=u.length;l<c;l++){var h=u[l];this.getComIds(h,a,f);var p=t[h.parentNode.rowIndex];p||(p=t[h.parentNode.rowIndex]=[]),p.push(this.genaCellHtml(h,null,null,null,!0))}var d=['<table rowNums="'+o+'" colNums="'+s+'">'];for(var v in t)d.push("<tr>"+t[v].join("")+"</tr>");d.push("</table>"),e.cellData=d.join(""),e.comIds=a,e.paths=f}},pasteCells:function(e){var n=e.cells;if(n){var r=this.selections[0].getCells(),s=r[0];if(n.substring(0,6)!="<table"){var o=this.ownerDesigner.buildNewNodeXml(n),u=o.getAttribute("componentName");content=i.toString(o),content=content.replace('xmlns="http://www.w3.org/1999/xhtml"',"");var a=this.ownerDesigner.dataModel.createElement({clientParent:s,modelParentDid:this.domNode.getAttribute("d_id"),componentName:u,templateContent:content});s.setAttribute("componentId",a.getAttribute("xid")),this.updateLayoutContent();return}n=n.replace(new RegExp("#C1C1C1|#c1c1c1","gm"),"#010101");var f=i.fromString(n).documentElement,l=t(n)[0];t(l).find("*").each(function(){t(this).removeAttr("d_id")});var c=parseInt(l.getAttribute("rowNums"),10),h=parseInt(l.getAttribute("colNums"),10),p=s.parentNode.rowIndex,d=this.getColIndex(s),v=p+c-1,m=d+h-1,g=this.mainTable.rows[0].cells[d],y=this.mainTable.rows[0].cells[m];if(!y){alert("列数不足！");return}var b=this.mainTable.rows[v];if(!b){alert("行数不足！");return}var w=b.cells[0],E=g.offsetLeft,S=g.offsetTop,x=y.offsetLeft+y.offsetWidth,T=w.offsetTop+w.offsetHeight,N=5e4,C=5e4,k=0,L=0,A="",O=this.getCells(p,v,E,x),M=null;for(var _=0;_<O.length;_++){var D=O[_],P=D.offsetLeft,H=D.offsetTop,B=D.offsetWidth+P,j=D.offsetHeight+H;N=Math.min(N,P),C=Math.min(C,H),k=Math.max(B,k),L=Math.max(j,L),!A&&(P<E||H<S||D.offsetWidth+P>x||D.offsetHeight+H>T)&&(A="不能对合并单元格做部分修改！"),M=D}M!=s&&(this.selections[this.selections.length-1].setBound({x:N,y:C,w:k-N,h:L-C}),this.paintResizeBoxes(M,!0));if(A){alert(A);return}this.cancelCellMerging(!1),r=this.selections[0].getCells();var F=[],I=0;p=-1;var _=0;for(_=0;_<r.length;_++){var D=r[_];p==-1&&(p=D.parentNode.rowIndex);var q=F[D.parentNode.rowIndex-p];q||(I+=1,q=F[D.parentNode.rowIndex-p]=[]),q.push(D)}var R=F[0];if(I!=c||R.length!=h){alert("不能对合并单元格做部分修改！");return}var U=l.childNodes[0].childNodes;this.comIdToCellMap={};var z=[];for(_=0;_<U.length;_++){var q=U[_],W=q.childNodes;for(var X=0;X<W.length;X++){var D=W[X];if(D.nodeType==1){D.setAttribute("class","cell"),D.setAttribute("d_canAddChild","true");var V=D.childNodes,J=[];for(var K=0,Q=V.length;K<Q;K+=1){var G=V[K];if(G.nodeType==1){var Y=G.getAttribute("xid");J.push(Y)}}for(var K=V.length-1;K>=0;K-=1){var G=V[K];G.nodeType==1&&t(G).remove()}J.length>0&&D.setAttribute("componentId",J.join(","));var Z=t(D.outerHTML).insertBefore(F[_][0])[0];Z.setAttribute("id","_id");for(var K=0;K<J.length;K+=1){var Y=J[K],a=t(f).find("*[xid='"+Y+"']:first")[0];if(a){var et=i.toString(a);z.push({clientParent:Z,parent:this.domNode,templateContent:et,componentName:a.getAttribute("componentName")})}}}}}var tt=[],nt=[];for(_=r.length-1;_>=0;_--)this._fetchComIds(r[_],tt,nt),r[_].parentNode.removeChild(r[_]);e.removeComIds=tt,e.removeComPaths=nt;var rt=this.asHtml();e["layout-data"]=rt,this.isInit=!0;var it=this;for(var _=0;_<z.length;_+=1)this.ownerDesigner.createComponent(z[_]);this.currentCell=this.selections[0].getCells()[0],this.updateLayoutContent(tt)}},_buildHtml:function(e,t){var n=["<table class='nohead' cellspacing=0 cellpadding=0 d_canAddChild='false' style='background:white;border-collapse: collapse;table-layout:fixed; top:0px;left:0px;width:1px;'>"],r=e?e.getElementsByTagName("tr"):[],i=r.length,s=r.length>0?r[0].childNodes.length:0,o=Math.max(8,s),u=Math.max(20,i),a={};for(var f=0;f<u;f++){n.push("<tr d_canAddChild='false'>");var l="cell";f==0&&(l+=" first-row");var c=r[f];if(!c)for(var h=0;h<o;h++){var p=l;f==0&&h==0&&(p+=" first-cell"),n.push("<td name='"+(f+"-"+h)+"' d_canAddChild='"+(f>0&&h>0?"true":"false")+"' class='"+p+(h>0?"":" first-col")+"'"+(h>0?"":" height='"+this.rowHeight+"' ")+(f>0?"":" width='"+this.columnWidth+"' ")+"></td>")}else{var d=c.childNodes;for(var h=0;h<o;h++){var v=d[h],m="",p=l;f==0&&h==0&&(p+=" first-cell");if(v){var g=v.getAttribute("class");if(g){g=g.split(" ");for(var y=g.length-1;y>=0;y-=1)(g[f]=="cell"||g[f]=="first-col"||g[f]=="first-row"||g[f]=="first-cell")&&g.splice(y,1);p+=" "+g.join(" ")}var b=[],w=[],E=v.getAttribute("style");E&&(E=E.replace(new RegExp("#C1C1C1|#c1c1c1","gm"),"#010101"),b.push("style='"+E+"'"));if(f>=0){var S=v.getAttribute("rowSpan");S&&b.push("rowspan="+S+"");var x=v.getAttribute("colSpan");x&&b.push("colspan="+x+"");var T=v.getAttribute("_cellAttr");T&&b.push("_cellAttr='"+T+"'");var N=v.getAttribute("format");N&&b.push('format="'+N+'"'),b.push("noWrap='true'");var C=v.getAttribute("componentId");if(C){var k=C.split(",");for(var L=0;L<k.length;L++){var A=t[k[L]];A&&w.push(A)}}m=v.text}var O=[],M=v.childNodes;for(var y=0,_=M.length;y<_;y++)M[y].nodeType==1?O.push(M[y].outerHTML):O.push(M[y].nodeValue);var D=O.join("");D&&(D=D.replaceAll(">","&gt;").replaceAll("<","&lt;").replaceAll("&lt;br&gt;","<br>")),w.length>0&&(D=(D||"")+w.join("")),n.push("<td "+b.join(" ")+" d_canAddChild='"+(f>0&&h>0?"true":"false")+"' class='"+p+(h>0?"":" first-col")+"'"+(h>0?"":" height='"+this.rowHeight+"' ")+(f>0?"":" width='"+this.columnWidth+"' ")+">"+D+"</td>")}else h>=s&&n.push("<td d_canAddChild='"+(f>0?"true":"false")+"'  class='"+p+(h>0?"":" first-col")+"'"+(h>0?"":" height='"+this.rowHeight+"' ")+(f>0?"":" width='"+this.columnWidth+"' ")+">"+m+"</td>")}}n.push("</tr>")}return n.push("</table>"),this.comIdToCellMap=a,n.join("")},buildCellHtml:function(e,t){var n=[];for(var r=0;r<e;r++)n.push("<td d_canAddChild='true' class='cell'>"+(t||"")+"</td>");return n.join("")},asHtml:function(){var e=this.getMaxRowColIndex();this.updateBeforeCellsHeight(e[0],e[1]);var t=this.getMaxOffset(),n=t.x,r=t.y,i=[];if(n>0&&r>0){var s=this.mainTable.rows;i.push('\n  <table cellspacing="0" cellpadding="0" rowHeight="'+this.rowHeight.replace("px","")+'" columnWidth="'+this.columnWidth.replace("px","")+'"'+' style="border-collapse:collapse;table-layout:fixed;width:1px;">\n');for(var o=0;;o++){var u=s[o];if(!u||u.offsetTop+2>r)break;i.push("     <tr>");var a=u.cells;for(var f=0;;f++){var l=a[f];if(!l||l.offsetLeft+2>n)break;l.noWrap=!0,i.push(this.genaCellHtml(l,o,f))}i.push("</tr>\n")}i.push("  </table>\n")}return i.join("")},updateLayoutContent:function(e,t){e=e||[];var n=this,r=this.asHtml();return this.ownerDesigner.dataModel&&(e&&(this.ownerDesigner.dataModel.stopUndoRedo=!0,this.ownerDesigner.removeSelections({ids:e}),this.ownerDesigner.dataModel.stopUndoRedo=!1),this.ownerDesigner.dataModel.setPropValue(this.domNode.getAttribute("d_id"),"layout-data",r,!0,"updateLayoutContent")),r},genaCellHtml:function(e,t,n,r,i){var s=e.style.cssText,o=e.className;if(o){var u=o.split(" ");for(var a=u.length-1;a>=0;a-=1)(u[a]=="cell"||u[a]=="first-col"||u[a]=="first-row"||u[a]=="first-cell")&&u.splice(a,1);o=u.join(" ")}o=o?' class="'+o+'" ':"",s=s.replace(new RegExp("#010101","gm"),"#C1C1C1");var f=(e.colSpan>1?' colSpan="'+e.colSpan+'"':"")+(e.rowSpan>1?' rowSpan="'+e.rowSpan+'"':"")+o+(s?' style="'+s+'"':""),l=[],c=[],h=[],p=e.childNodes;for(var d=0,v=p.length;d<v;d++){var m=p[d];if(m.nodeType==1){if(i){var g=m.getAttribute("d_id");if(g){var y=this.ownerDesigner.getNodeXml(g);h.push(y)}}var b=this.ownerDesigner.getComponent(m);b?c.push(b.domNode.getAttribute("xid")):m.getAttribute("xid")?c.push(m.getAttribute("xid")):l.push("<"+m.tagName+"/>")}else t!==0&&n!==0&&l.push(m.nodeValue)}if(c.length>0)f+=' componentId="'+c.join(",")+'"';else{var w=e.getAttribute("componentId");w&&(f+=' componentId="'+w+'"')}f=this.buildOtherAttribute(e,f);var E=l.join("");return E&&(E=E.replace(new RegExp("<","gm"),"&lt;"),E=E.replace(new RegExp(">","gm"),"&gt;")),"<td "+f+">"+E+h.join("")+"</td>"},buildOtherAttribute:function(e,t){return t},paintResizeBoxes:function(e,n,r){this.currentCell=e;var i=this.getCellBound(e),s=i.x-3,o=i.y-3,u=i.w,a=i.h,f=[[s+u+(e.parentNode.cells.length-1==e.cellIndex?-2:2),o+a/2],[s+u/2,o+a+(this.mainTable.rows.length-1==e.parentNode.rowIndex?-2:2)]];if(!this.resizeBoxes||this.resizeBoxes.length===0){var l=this.domNode,c=[];r||(r="e,s"),r.indexOf("e")!=-1&&c.push(this.buildResizBoxHtml(f[0],"e","e-resize")),r.indexOf("s")!=-1&&c.push(this.buildResizBoxHtml(f[1],"s","s-resize")),this.resizeBoxes=[];var h=this;t(c.join("")).appendTo(l).each(function(e,t){h.resizeBoxes.push(t)}).bind("mousedown",function(e){t(this).attr("direction")=="e"?h.dragResizeColWidth(e,h.currentCell,h):h.dragResizeRowHeight(e,h.currentCell,h),e.stopPropagation(),e.preventDefault()})}else t(this.resizeBoxes[0]).css("top",f[0][1]).css("left",f[0][0]),t(this.resizeBoxes[1]).css("top",f[1][1]).css("left",f[1][0])},buildResizBoxHtml:function(e,t,n){var r="top:"+e[1]+"px;left:"+e[0]+"px;";return"<div class='select-box' isResizeBox='true' direction='"+t+"' cursor='"+n+"' style='cursor:"+n+";z-index:3500;"+r+"'></div>"},clearResizeBox:function(){if(this.resizeBoxes){for(var e=0,n=this.resizeBoxes.length;e<n;e++)t(this.resizeBoxes[e]).unbind(),this.resizeBoxes[e].parentNode.removeChild(this.resizeBoxes[e]);this.resizeBoxes=null}},containInRect:function(e,t,n){if(e>=n.x&&e<=n.x+n.w&&t>=n.y&&t<=n.y+n.h)return!0},set:function(e,t){this.setProperty(t)},setProperty:function(e){var t=e.name,n=e.value;if(t==="layout-data"){if(n==this.asHtml())return;r.repaintComponent(this)}else if(t==="row-height"){if(!n||n=="0")n=19;this.rowHeight=n+"px";var i=this.mainTable.rows;for(var s=1;s<i.length;s++)i[s].cells[0].height=this.rowHeight;this.clearSelectionUnit(),this.updateLayoutContent()}else if(t==="column-width"){if(!n||n=="0")n=80;this.columnWidth=n+"px";var o=this.mainTable.rows[0].cells;for(var s=1;s<o.length;s++)o[s].width=this.columnWidth;this.clearSelectionUnit(),this.updateLayoutContent()}},css:function(e,n){if(!e)return;var r=e.getAttribute("style")||"",i={},s=r.split(";");for(var o=0;o<s.length;o+=1){var u=s[o];if(u){var a=t.trim(u).split(":");a.length==2&&(i[a[0]]=a[1])}}for(var f in n){var l=n[f];l=="remove"?(delete i[f],delete n[f]):i[f]=n[f]}var c=[];for(var f in i){var l=i[f];l&&c.push(f+":"+i[f])}var r=c.join(";");return e.setAttribute("style",r),r},getCurrentCellStyle:function(){if(!this.selections)return"";var e=this.selections[0].getCells();return e[0].getAttribute("style")},setCellStyle:function(e){if(!this.selections)return;delete e.methodType,delete e.methodName;var n=0,r=0,i;if(!e["cell-layout-border-style"])for(n=0,l=this.selections.length;n<l;n++){var i=this.selections[n].getCells();for(r=0,cCount=i.length;r<cCount;r++){cell=i[r],this.css(cell,t.extend({},e)),this.updateMaxPos(cell);continue}}else{var s=e["cell-layout-border-style"],f=s.style,c=s.width+"px",h=s.color;h||(h="#010101");var p=s.pattern;for(n=0,l=this.selections.length;n<l;n++){var d=this.selections[n].getBound();i=this.selections[n].getCells();for(r=0,cCount=i.length;r<cCount;r++){e={};var v=i[r];f=="border_all"?(e["border-width"]=c,e["border-color"]=h,e["border-style"]=p,this.setExtCellStyle(d,v,!0,!0,c,h,p)):f=="border_remove"?(e["border-width"]="",e["border-color"]="",e["border-style"]="",this.setExtCellStyle(d,v,!0,!0,"","","")):((f=="border_left"||f=="border_outline"||f=="border_left_right")&&v.offsetLeft==d.x&&(e["border-left-width"]=c,e["border-left-color"]=h,e["border-left-style"]=p,this.setExtCellStyle(d,v,!0,!1,c,h,p)),(f=="border_right"||f=="border_outline"||f=="border_left_right")&&v.offsetLeft+v.offsetWidth==d.x+d.w&&(e["border-right-width"]=c,e["border-right-color"]=h,e["border-right-style"]=p),(f=="border_top"||f=="border_outline"||f=="border_top_bottom")&&v.offsetTop==d.y&&(e["border-top-width"]=c,e["border-top-color"]=h,e["border-top-style"]=p,this.setExtCellStyle(d,v,!1,!0,c,h,p)),(f=="border_bottom"||f=="border_outline"||f=="border_top_bottom")&&v.offsetTop+v.offsetHeight==d.y+d.h&&(e["border-bottom-width"]=c,e["border-bottom-color"]=h,e["border-bottom-style"]=p),(f=="border_center_v"||f=="border_center_v_h")&&v.offsetLeft+v.offsetWidth!=d.x+d.w&&(e["border-right-width"]=c,e["border-right-color"]=h,e["border-right-style"]=p),(f=="border_center_h"||f=="border_center_v_h")&&v.offsetTop+v.offsetHeight!=d.y+d.h&&(e["border-bottom-width"]=c,e["border-bottom-color"]=h,e["border-bottom-style"]=p)),t(v).css(e),this.updateMaxPos(v)}}}this.updateLayoutContent()},setExtCellStyle:function(e,n,r,i,s,o,u){if(r&&n.offsetLeft==e.x){var a=this.getPrevTd(n);if(a){var f={};f["border-right-width"]=s,f["border-right-color"]=o,f["border-right-style"]=u,t(a).css(f)}}if(i&&n.offsetTop==e.y){var l=this.getUpTd(n);if(l){var c={};c["border-bottom-width"]=s,c["border-bottom-color"]=o,c["border-bottom-style"]=u,t(l).css(c)}}},setCellStyleStr:function(e){var t=e.style,n=e.isClass,r=e["class"];for(var i=0,s=this.selections.length;i<s;i++){var o=this.selections[i].getCells();for(var u=0,a=o.length;u<a;u++){var f=o[u];if(n=="true"){var l=[],c=f.className;if(c){c=c.split(" ");for(var h=0;h<c.length;h+=1)(c[h]=="cell"||c[h]=="first-cell"||c[h]=="first-col"||c[h]=="first-row")&&l.push(c[h])}r&&l.push(r),f.className=l.join(" ")}else f.style.cssText=t}}this.updateLayoutContent()},setColWidth:function(e,t){t<0&&(t=2),this.mainTable.rows[0].cells[e].style.width=t+"px",this.updateLayoutContent()},setRowHeight:function(e,t){if(t<0)return;this.mainTable.rows[e].cells[0].style.height=t+"px",this.updateLayoutContent()},getCellBound:function(e){return{x:e.offsetLeft,y:e.offsetTop,w:e.offsetWidth,h:e.offsetHeight}},getOwnerCell:function(e){var n=e;while(n){if(t(n).hasClass("cell"))return n;n=n.parentNode}return n},getActivteViewPartElement:function(){if(this.currentCell)return this.currentCell},getRowIndics:function(e,t){var n=this.mainTable.rows,r=-1,i=-1;for(var s=0,o=n.length;s<o;s++){var u=n[s].offsetTop+2;u>=e&&r==-1&&(r=s);if(u>=t){i=s-1;break}}return i==-1&&(i=n.length-1),[r,i]},getFirstRowCellByPos:function(e){var t=this.mainTable.rows,n=t[0],r=n.cells;for(var i=0,s=r.length;i<s;i++)if(e>=r[i].offsetLeft&&e<r[i].offsetLeft+r[i].offsetWidth)return r[i]},getFirstColCellByPos:function(e){var t=this.mainTable.rows;for(var n=1,r=t.length;n<r;n++){var i=t[n].cells[0];if(e>=i.offsetTop&&e<i.offsetTop+i.offsetHeight)return i}},getMaxOffset:function(){var e=this.mainTable.rows,t=0,n=0;for(var r=e.length-1;r>0;r--){var i=e[r].cells;for(var s=i.length-1;s>0;s--){var o=i[s];if(o.colSpan>1||o.rowSpan>1||o.firstChild||o.style.cssText&&o.style.cssText!="HEIGHT: 19px"||o._cellAttr){var u=this.getCellBound(o);t=Math.max(u.x+u.w,t),n=Math.max(u.y+u.h,n)}}}return{x:t,y:n}},getMaxRowColIndex:function(){var e=this.getMaxOffset(),t=e.x,n=e.y;if(t>0&&n>0){var r=this.getRowColIndex(t-3,n-3);return[r[0]-1,r[1]-1]}return[-1,-1]},getRowColIndex:function(e,t){var n=this.mainTable.rows,r=n[0],i=r.cells,s=-1,o=-1,u=0,a=i.length;for(u=0;u<a;u++)if(i[u].offsetLeft+2>=e){s=u;break}for(u=0,a=n.length;u<a;u++)if(n[u].offsetTop+2>=t){o=u;break}return s==-1&&(s=i.length),o==-1&&(o=n.length),[o,s]},getCells:function(e,t,n,r){var i=this.mainTable.rows,s=[];for(var o=e;o<=t;o++){var u=i[o].cells;for(var a=0,f=u.length;a<f;a++){var l=u[a];if(!l)break;var c=l.offsetLeft;if(c>=n&&c<r)s.push(l);else if(c>r)break}}return s},createSelectionUnit:function(e){if(!e)return;var n=this.domNode.getAttribute("d_id");if(!this.getSelectionUnit(e)){this.lastSelectCell=e,this.selections.push((new o(this)).setBound(this.getCellBound(e))),this.paintResizeBoxes(e),this.selctionChangeCaller&&(clearTimeout(this.selectionClearCaller),this.selectionClearCaller=null,clearTimeout(this.selctionChangeCaller),this.selctionChangeCaller=null);var r=this,i=e.className,s=[];if(i){i=i.split(" ");for(var u=0;u<i.length;u+=1)i[u]!="cell"&&i[u]!="first-cell"&&i[u]!="first-col"&&i[u]!="first-row"&&s.push(i[u])}this.selctionChangeCaller=setTimeout(function(){r.ownerDesigner&&(r.ownerDesigner.updatePropEditor(n,"cellLayoutCell",{style:e.getAttribute("style")},function(){}),r.ownerDesigner.dispatchEvent({className:s.join(" "),event:"cellLayoutSelectionChanged",id:n,path:t(e).getPath(),style:e.style.cssText,value:e.innerHTML}))},400)}},getSelectionUnit:function(e){for(var t=0,n=this.selections.length;t<n;t++)if(this.containInRect(e.offsetLeft+2,e.offsetTop+2,this.selections[t].getBound()))return this.selections[t]},getDId:function(){return this.domNode.getAttribute("d_id")},clearSelectionUnit:function(e){for(var t=0,n=this.selections.length;t<n;t++)this.selections[t].dispose();this.selections=[],this.lastSelectCell=null,this.currentCell=null,this.headerSelectRowIndex=-1,this.headerSelectRowIndex=-1,this.clearResizeBox(),this.selectionClearCaller&&(clearTimeout(this.selectionClearCaller),this.selectionClearCaller=null);if(e===!0)return;var r=this;r.mouseDownFlag?r.ownerDesigner.dispatchEvent({event:"cellLayoutClearSeleection",id:r.getDId()}):this.selectionClearCaller=setTimeout(function(){r.ownerDesigner&&r.ownerDesigner.dispatchEvent({event:"cellLayoutClearSeleection",id:r.getDId()})},400)},_fetchComIds:function(e,n,r){var i=e.childNodes;for(var s=i.length-1;s>=0;s--)if(i[s]&&i[s].nodeType==1){var o=i[s].getAttribute("d_id");o&&(n.push(o),r.push(t(i[s]).getPath()))}},getComIds:function(e,t,n){e=e.length||e.length===0?e:[e];for(var r=e.length-1;r>=0;r--)this._fetchComIds(e[r],t,n)},colRowIndicsMap:{},deleteCells:function(e,t,n,r,i){this.stopFireUpdateContent=!0;var s=0;try{e=e.length||e.length===0?e:[e];if(r)for(s=e.length-1;s>=0;s--)this._fetchComIds(e[s],r,i);if(!r){r=[],i=[];for(s=e.length-1;s>=0;s--)this._fetchComIds(e[s],r,i);r.length>0&&this.ownerDesigner.removeSelections({ids:r})}for(s=e.length-1;s>=0;s--)n||(t||e[s].parentNode).removeChild(e[s]);if(n)for(s=e.length-1;s>=0;s--)e[s].innerHTML="",e[s].setAttribute("componentId","")}finally{this.stopFireUpdateContent=!1}},clearCellContent:function(){var e=this.selections.length;this.colRowIndicsMap={};for(var t=0;t<e;t++){var n=this.selections[t].getCells();this.deleteCells(n,null,!0)}e>0&&this.updateLayoutContent()},executeSelect:function(e,t){if(!t)return;var n=this.selections.length;if(e.ctrlKey)this.createSelectionUnit(t);else if(e.shiftKey&&n>0){var r=e.target;r=this.getOwnerCell(r);if(!r||r.tagName!="TD"||r.getAttribute("d_canAddChild")!="true")return;this.updateSelectionUnit(r)}else this.currentCell!=t&&(this.clearSelectionUnit(),this.createSelectionUnit(t))},dragSelect:function(e,n,r){try{var i=r.getSelectionUnit(n);if(!i)return;r.domNode.style.cursor="default";var s=function(e){var t=e.target;t=r.getOwnerCell(t);if(!t||t.tagName!="TD"||t.getAttribute("d_canAddChild")!="true")return;r.updateSelectionUnit(t),r.isDragSelect=!0,e.stopPropagation()},o=function(e){t(r.domNode).unbind("mouseover",s).unbind("mouseup",o),r.isDragSelect=!1,e.stopPropagation()};t(r.domNode).bind("mouseover",s).bind("mouseup",o)}catch(u){alert("选择出错"+u)}},updateMaxPos:function(e){var t=this.getCellBound(e);this.maxPos.x=Math.max(this.maxPos.x,t.x+t.w-2),this.maxPos.y=Math.max(this.maxPos.y,t.y+t.h-2)},dragResizeColWidth:function(e,n,r){r.isResize=!0;var i=document,s=n.offsetWidth-1,o=r.domNode.clientHeight,u=t("<div class='col-resize-line' style='top:"+r.domNode.scrollTop+"px;left:"+n.offsetLeft+"px;width:"+s+"px;height:"+o+"px'></div>").appendTo(r.domNode),a=s,f=e.clientX;i.onmousemove=function(e){var t=(e||window.event).clientX-f+s;t>5&&u.css("width",a=t)},i.onmouseup=function(e){r.isResize=!1,u.remove(),u=null,i.onmousemove=null,i.onmouseup=null,i=null;if(a!=s){var t=r.getCellBound(n),o=r.getFirstRowCellByPos(t.x+t.w-2);o&&r.setColWidth(o.cellIndex,o.offsetWidth+(a-s))}}},dragResizeRowHeight:function(e,n,r){r.isResize=!0;var i=document,s=n.offsetHeight-1,o=r.domNode.clientWidth,u=t("<div class='row-resize-line' style='top:"+n.offsetTop+"px;left:"+r.domNode.scrollLeft+"px;width:"+o+"px;height:"+s+"px'></div>").appendTo(r.domNode),a=s,f=e.clientY;i.onmousemove=function(e){var t=(e||window.event).clientY-f+s;t>5&&u.css("height",a=t)},i.onmouseup=function(e){r.isResize=!1,u.remove(),u=null,i.onmousemove=null,i.onmouseup=null,i=null;if(a!=s){var t=r.getCellBound(n),o=r.getFirstColCellByPos(t.y+t.h-2);o&&r.setRowHeight(o.parentNode.rowIndex,o.offsetHeight+(a-s))}}},showLabelInput:function(e){var n=e.childNodes;for(var r=0,i=n.length;r<i;r++)if(n[r].nodeType==1&&n[r].component)return;document.body.onselectstart="";var o=t("<textarea  style='top:"+e.offsetTop+"px;left:"+e.offsetLeft+"px;border:1px solid;position:absolute;font:normal 12px 宋体, arial, serif;overflow:visible;word-wrap:normal;z-index:8000;overflow-y:hidden'/>")[0],u=e.innerHTML;o.value=u.replaceAll("&nbsp;"," ").replaceAll("<br>","\n").replaceAll("&lt;","<").replaceAll("&gt;",">");var a=this.calcTextSize(o.value);t(o).css({width:Math.max(e.offsetWidth,a.w)+"px",height:Math.max(e.offsetHeight,a.h)+"px"}),this.domNode.appendChild(o),o.onmousedown=function(e){e.stopPropagation()},o.onmouseup=function(e){e.stopPropagation()},o.onmousemove=function(e){e.stopPropagation()},o.onkeydown=function(n){n.keyCode==13&&(n.altKey?s(o,"\r\n"):(o.blur(),f.createSelectionUnit(e),setTimeout(function(){f.domNode.focus()},100)));var r=f.calcTextSize(o.value);t(o).css({width:Math.max(e.offsetWidth,r.w)+"px",height:Math.max(e.offsetHeight,r.h)+"px"}),n.stopPropagation()};var f=this;f.currentTextInput=o,o.onblur=function(n){document.body.onselectstart=function(){return!1};var r=o.value||"",i=r.replaceAll(" ","&nbsp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll("\n","<br>");t(e).html(i),f.updateMaxPos(e),f.currentTextInput=null,f.labelChanging=!1,setTimeout(function(){t(o).remove()},100),f.updateLayoutContent(),e.focus()},o.focus(),o.selectionStart=o.selectionEnd=o.value.length},getLayoutData:function(e){e=e||{},e.layoutData=this.asHtml()},mergeCell:function(){var e=[],t=0,n=this.selections.length;for(t=0;t<n;t++)e.push(this.selections[t].getBound());if(this.hasIntersection(e)){alert("选择区域存在交集，不能合并");return}var r=[],i=[];this.colRowIndicsMap={};for(t=0,n=this.selections.length;t<n;t++){var s=this.selections[t].getBound(),o=s.x-2,u=s.x+s.w-2,a=this.getRowColIndex(s.x+1,s.y+1),f=this.getRowColIndex(s.x+s.w-3,s.y+s.h-3),l=f[0]-a[0],c=f[1]-a[1],h=this.getCells(a[0],f[0]-1,o,u);c>1&&(h[0].colSpan=c),l>1&&(h[0].rowSpan=l);var p=h[0];h.splice(0,1),this.deleteCells(h,null,null),this.paintResizeBoxes(p,!0),this.updateMaxPos(p),this.selections[t].reGetCells()}this.updateLayoutContent()},cancelCellMerging:function(e){var n=this.mainTable.rows;for(var r=0,i=this.selections.length;r<i;r++){var s=this.selections[r].getBound(),o=s.x-2,u=s.x+s.w-2,a=this.getRowColIndex(s.x+1,s.y+1),f=this.getRowColIndex(s.x+s.w-3,s.y+s.h-3),l=f[0]-a[0],c=f[1]-a[1],h=this.getCells(a[0],f[0]-1,o,u);for(var p=0,d=h.length;p<d;p++){c=h[p].colSpan,l=h[p].rowSpan,c>1&&(t(this.buildCellHtml(c-1)).insertAfter(h[p]),h[p].colSpan=1);if(l>1){var v=this.buildCellHtml(c),m=h[p].offsetLeft,g=this.getRowIndics(h[p].offsetTop,h[p].offsetTop+h[p].clientHeight);for(var y=g[0]+1;y<=g[1];y++){var b=n[y].cells;for(var w=0,E=b.length;w<E;w++){var S=b[w],x=b[w+1];if(S.offsetLeft<m&&(x&&x.offsetLeft>m||!x)){t(v).insertAfter(S);break}}}h[p].rowSpan=1}}}this.paintResizeBoxes(this.currentCell,!0),e!==!1&&this.updateLayoutContent()},insertRowAfter:function(){this.insertRow(!0)},insertRow:function(e){if(this.selections.length>1){alert("有多个选择区域时不能插入");return}if(this.selections.length===0){alert("请选择单元格");return}var t=this.selections[0],n=0,r=-1,i=0,s;if(t&&t.getCells().length>0){var o=t.getCells()[0],u=o.parentNode,a=u.previousSibling;r=u.rowIndex;while(a){for(i=0;i<a.cells.length;i++)s=a.cells[i],s.rowSpan>=2&&a.rowIndex+s.rowSpan>r&&(s.rowSpan=s.rowSpan+1,n+=s.colSpan);a=a.previousSibling}}else this.headerSelectRowIndex>=0&&(r=this.headerSelectRowIndex);e===!0&&r++;var f=0,l=this.mainTable.rows[0].cells.length-n,c=r!=-1?this.mainTable.insertRow(r):this.mainTable.insertRow();c.setAttribute("d_canAddChild","false");for(i=0;i<l;i++)s=c.insertCell(i),s.className="cell"+(i===0?" first-col":""),i===0&&(s.height=this.rowHeight),s.setAttribute("d_canAddChild","true"),i===0&&(f=s.offsetHeight);this.updateLayoutContent()},insertColAfter:function(){this.insertCol(!0)},insertCol:function(e){if(this.selections.length>1){alert("有多个选择区域时不能插入");return}if(this.selections.length===0){alert("请选择单元格");return}var t=this.selections[0],n=0,r;if(t&&t.getCells().length>0||this.headerSelectColIndex>=0){var i=null;this.headerSelectColIndex>=0?i=this.currentCell:i=t.getCells()[0];var s=this.getColIndex(i);e===!0&&s++;var o=this.mainTable.rows.length,u=[],a=[],f=[];for(n=0;n<o;n++){r=this.mainTable.rows[n],u[n]=r.cells.length;for(var l=1,c=r.cells.length;l<c;l++){var h=r.cells[l],p=h.cellIndex;if(n<=o){p=this.getColIndex(h);if(p==-1)break}if(p==s){u[n]=h.cellIndex;break}if(h.colSpan>=2&&p+h.colSpan>s){a.push(h),f.push(h.colSpan+1);break}if(p+1==s){var d=h.nextSibling;if(d){u[n]=d.cellIndex;break}}else if(p>s)break}}for(n=0;n<a.length;n++)a[n].colSpan=f[n];var v=0;for(n=0;n<this.mainTable.rows.length;n++)if(u[n]!=-1){r=this.mainTable.rows[n];var m=r.insertCell(u[n]);m.className="cell"+(n===0?" first-row":""),n===0&&(m.width=this.columnWidth),m.setAttribute("d_canAddChild","true"),n===0&&(v=m.offsetWidth)}}else for(n=0;n<this.mainTable.rows.length;n++){r=this.mainTable.rows[n];var g=r.insertCell();g.className="cell"+(n===0?" first-row":""),n===0&&(g.width=this.columnWidth),g.setAttribute("d_canAddChild","true")}this.updateLayoutContent()},deleteRow:function(){if((!this.selections[0]||this.selections[0].getCells().length===0)&&this.headerSelectRowIndex<0)return;var e=[],t=0,n=0,r=0;if(this.headerSelectRowIndex>=0)e=[this.mainTable.rows[this.headerSelectRowIndex]];else{var i={};for(t=0;t<this.selections.length;t++){var s=this.selections[t].getCells();for(n=0;n<s.length;n++){var o=s[n].parentNode,u=o.rowIndex;i["_"+u]||(e.push(o),i["_"+u]=!0);for(r=1;r<s[n].rowSpan;r++)i["_"+(u+r)]||(e.push(this.mainTable.rows[u+r]),i["_"+(u+r)]=!0)}}e=e.sort(function(e,t){return e.rowIndex>t.rowIndex})}var a=e[e.length-1].previousSibling;while(a){for(t=0;t<a.cells.length;t++){var f=a.cells[t];if(f.rowSpan>=2)for(n=0;n<e.length;n++)a.rowIndex+f.rowSpan>e[n].rowIndex&&(f.rowSpan=f.rowSpan-1)}a=a.previousSibling}var l=[],c=[];this.colRowIndicsMap={};for(t=e.length-1;t>=0;t--){var h=e[t];for(n=0;n<h.cells.length;n++){var p=h.cells[n];if(p.rowSpan>=2){var d=this.getColIndex(p),v=h.nextSibling;for(r=0;r<v.cells.length;r++){var m=v.cells[r],g=this.getColIndex(m);if(g>=d){var y=v.insertCell(m.cellIndex);y.rowSpan=p.rowSpan-1,y.colSpan=p.colSpan,y.className="cell",y.setAttribute("d_canAddChild","true");break}}}}this.deleteCells(h.cells,h,null),this.mainTable.deleteRow(h.rowIndex)}this.clearSelectionUnit(),this.updateLayoutContent()},deleteCol:function(){if((!this.selections[0]||this.selections[0].getCells().length===0)&&this.headerSelectColIndex<0)return;var e=[],t=0,n=0,r,i=[];if(this.headerSelectColIndex>=0)i.push(this.getCellBound(this.mainTable.rows[0].cells[this.headerSelectColIndex]));else for(n=0;n<this.selections.length;n++)i.push(this.selections[n].getBound());for(t=0;t<this.mainTable.rows.length;t++){r=this.mainTable.rows[t];for(var s=0;s<r.cells.length;s++){var o=r.cells[s],u=this.getCellBound(o);for(n=0;n<i.length;n++){var a=i[n];if(Math.max(u.x,a.x)<Math.min(u.x+u.w,a.x+a.w)){var f={};f.rowIndex=t,f.cellIndex=o.cellIndex,o.colSpan>1?f.colSpan=o.colSpan-1:f.del=!0,e.push(f);break}}}}var l=[],c=[];this.colRowIndicsMap={};for(t=e.length-1;t>=0;t--){var h=e[t].rowIndex,p=e[t].cellIndex;r=this.mainTable.rows[h],e[t].del?this.deleteCells(r.cells[p],r,null):r.cells[p].colSpan=e[t].colSpan}this.clearSelectionUnit(),this.updateLayoutContent()},getColIndex:function(e){try{var t=this.getCellBound(e),n=this.getFirstRowCellByPos(t.x,t.w-2);return n.cellIndex}catch(r){return-1}},getSectionsColIndexes:function(){var e=[],t=this.mainTable.rows[0].cells;for(var n=1;n<t.length;n++){var r=this.getCellBound(t[n]);for(var i=0;i<this.selections.length;i++){var s=this.selections[i].getBound();if(r.x>=s.x&&r.x<s.x+s.w){e.push(t[n].cellIndex);break}}}return e},calcTextSize:function(e){var t=window.tempSpan;t||(t=document.createElement("span"),t.style.position="absolute",t.style.top="-100px",t.style.font="normal 13px 宋体, arial, serif;",document.body.appendChild(t),window.tempSpan=t),t.style.display="",t.innerHTML=e.replaceAll("\n","<br>").replaceAll(" ","&nbsp;");var n=t.offsetWidth+20,r=t.offsetHeight+10;return t.style.display="none",{w:n,h:r}},gotoPrevTd:function(e,t){var n=this.getPrevTd(e);n&&n.cellIndex>0&&(n.offsetLeft<this.domNode.scrollLeft&&(this.domNode.scrollLeft=n.offsetLeft),t?this.updateSelectionUnit(n):(this.clearSelectionUnit(),this.createSelectionUnit(n)))},getPrevTd:function(e){var t=this.getCellBound(e),n=this.getFirstRowCellByPos(t.x,t.w-2),r=n.previousSibling;if(!r)return;var i=this.getCellBound(r),s=null,o=e.parentNode;if(e.rowSpan>1)try{o=this.mainTable.rows[this.moveRowIndex]}catch(u){}while(o&&!s){for(var a=1,f=o.cells.length;a<f;a++){var l=this.getCellBound(o.cells[a]);if(Math.max(i.x,l.x)<Math.min(i.x+i.w,l.x+l.w)){s=o.cells[a];break}}o=o.previousSibling}return s},gotoNextTd:function(e,t){var n=this.getCellBound(e),r=this.getFirstRowCellByPos(n.x,n.w-2),i=r.nextSibling;if(!i)return;var s=0;for(s=1;s<e.colSpan;s++)i&&(i=i.nextSibling);if(!i)return;var o=this.getCellBound(i),u=null,a=e.parentNode;if(e.rowSpan>1)try{a=this.mainTable.rows[this.moveRowIndex]}catch(f){}while(a&&!u){var l=a.cells.length;for(s=1;s<l;s++){var c=this.getCellBound(a.cells[s]);if(Math.max(o.x,c.x)<Math.min(o.x+o.w,c.x+c.w)){u=a.cells[s];break}}a=a.previousSibling}u&&(u.offsetLeft+u.offsetWidth+20>this.domNode.scrollLeft+this.domNode.offsetWidth&&(this.domNode.scrollLeft=this.domNode.scrollLeft+u.offsetWidth),t?this.updateSelectionUnit(u):(this.clearSelectionUnit(),this.createSelectionUnit(u)))},gotoUpTd:function(e,t){var n=this.getUpTd(e);if(!n||n.parentNode.rowIndex===0)return;n.offsetTop<this.domNode.scrollTop&&(this.domNode.scrollTop=n.offsetTop),t?this.updateSelectionUnit(n):(this.clearSelectionUnit(),this.createSelectionUnit(n)),this.moveRowIndex=n.parentNode.rowIndex},getUpTd:function(e){var t=null,n=e.parentNode.previousSibling;while(n&&!t){var r=this.getCellBound(e);for(var i=1,s=n.cells.length;i<s;i++){var o=this.getCellBound(n.cells[i]);if(Math.max(r.x,o.x)<Math.min(r.x+r.w,o.x+o.w)){t=n.cells[i];break}}n=n.previousSibling}return t},gotoDownTd:function(e,t){var n=null,r=e.parentNode.nextSibling;while(r&&!n){var i=this.getCellBound(e);for(var s=1,o=r.cells.length;s<o;s++){var u=this.getCellBound(r.cells[s]);if(Math.max(i.x,u.x)<Math.min(i.x+i.w,u.x+u.w)){n=r.cells[s];break}}r=r.nextSibling}if(!n)return;n.offsetTop+n.offsetHeight+20>this.domNode.scrollTop+this.domNode.offsetHeight&&(this.domNode.scrollTop=this.domNode.scrollTop+n.offsetHeight),t?this.updateSelectionUnit(n):(this.clearSelectionUnit(),this.createSelectionUnit(n)),this.moveRowIndex=n.parentNode.rowIndex},updateAllSelectionUnitBound:function(){for(var e=0;e<this.selections.length;e++){var t=this.selections[e];t.updateBound()}this.paintResizeBoxes(this.currentCell)},updateSelectionUnit:function(e){this.currentCell=e||this.currentCell;if(!this.currentCell)return;var n=this,r=n.getCellBound(this.lastSelectCell),i=r.x,s=r.y,o=i+r.w,u=s+r.h;if(t(e).hasClass("first-row")||t(e).hasClass("first-col"))return;var a=n.getCellBound(e),f=Math.min(i,a.x),l=Math.min(s,a.y),c=Math.max(o,a.x+a.w)-f,h=Math.max(u,a.y+a.h)-l;this.selections[this.selections.length-1].setBound({x:f,y:l,w:c,h:h}),n.paintResizeBoxes(e,!0)},hasIntersection:function(e){for(var t=0;t<e.length;t++){var n=e[t];for(var r=t+1;r<e.length;r++){var i=e[r];if(Math.max(n.x,i.x)<Math.min(n.x+n.w,i.x+i.w)&&Math.max(n.y,i.y)<Math.min(n.y+n.h,i.y+i.h))return!0}}return!1},importFromExcel:function(){},getCurrentCellValue:function(){return this.currentCell?this.currentCell.innerHTML:""},setCurrentCellValue:function(e){this.currentCell&&(this.currentCell.innerHTML=e.data)},getCurrentCellProperties:function(){var e={width:80,height:19},t=this.getSelectionsRows(),n=0;for(;n<t.length;n++){var r=t[n],i=r.cells[0].style.height;if(n===0)i?e.height=i:e.height="19px";else if(i&&i!=e.height){e.height="0px";break}}e.height=parseInt(e.height.replace("px",""),10);var s=this.getSectionsColIndexes();for(n=0;n<s.length;n++){var o=this.mainTable.rows[0].cells[s[n]];if(n===0)e.width=o.offsetWidth-1;else if(e.width!=o.offsetWidth-1){e.width=0;break}}return JSON.stringify(e)},setCellProperties:function(e){var t=[],n=0,r;for(;n<this.selections.length;n++){var i=this.selections[n];r=i.getCells(),r.length>0&&t.push({sel:i,cells:r})}if(e.columnWidth>0){var s=this.getSectionsColIndexes();for(n=0;n<s.length;n++)this.mainTable.rows[0].cells[s[n]].style.width=e.columnWidth+"px"}if(e.rowHeight>0){var o=this.getSelectionsRows();for(n=0;n<o.length;n++)o[n].cells[0].style.height=e.rowHeight+"px"}this.updateLayoutContent()},getSelectionsRows:function(){var e=[];if(this.headerSelectRowIndex>=0)e=[this.mainTable.rows[this.headerSelectRowIndex]];else{var t={};for(var n=0;n<this.selections.length;n++){var r=this.selections[n].getCells();for(var i=0;i<r.length;i++){var s=r[i].parentNode,o=s.rowIndex;t["_"+o]||(e.push(s),t["_"+o]=!0);for(var u=1;u<r[i].rowSpan;u++)t["_"+(o+u)]||(e.push(this.mainTable.rows[o+u]),t["_"+(o+u)]=!0)}}e=e.sort(function(e,t){return e.rowIndex>t.rowIndex})}return e},updateBeforeCellsHeight:function(e,t){for(var n=1;n<=e;n++){var r=this.mainTable.rows[n];if(!r)break;var i=r.cells.length,s=r.cells[0].style.height;s?s=parseInt(s.replace("px",""),10):s=19;var o;for(var u=1;u<=t&&u<i;u++){var a=r.cells[u];if(!a)break;if(a.rowSpan<2)a.style.height=s+"px";else{var f=s;for(o=1;o<a.rowSpan;o++){var l=this.mainTable.rows[n+o].cells[0].style.height;l?l=parseInt(l.replace("px",""),10):l=19,f+=l}a.style.height=f+"px"}var c=a.childNodes,h=c.length;for(o=0;o<h;o++)c[o].tagName=="TEXTAREA"&&(c[o].style.height=a.style.height)}}},showHideCellBorder:function(){var e=this.mainTable.className;e.indexOf("nocellborder")==-1?e+=" nocellborder":e=e.replace("nocellborder",""),this.mainTable.className=e},getCell:function(e,t){var n=this.mainTable.rows[e];if(n)return n.cells[t]}};var a={"$UI/system/components/justep/cellLayout/cellLayout":{styleConfig:function(e){return[e.getCommonStyleItem("font"),e.getCommonStyleItem("baseStyle"),e.getCommonStyleItem("border")]}}};return{"$UI/system/components/justep/cellLayout/cellLayout":u,quickIdeEx:a}});