/*! 
* BeX5 v3 (http://www.justep.com) 
* Copyright 2015 Justep, Inc.
*/

define("$model/UI2/system/components/justep/processDesigner/js/processWebCanvas",["require","jquery"],function(require){function autoAlign(e,t,n){if(!t||t.length===0)return e;n||(n=document.body);var r;n.valignLine||(r=$("<div style='left:0px;top:0;display:none;overflow:hidden;border-top:1px dotted green;position:absolute;width:100%;height:1px;'/>").appendTo(n)[0],n.valignLine=r),n.halignLine||(r=$("<div style='top:0px;display:none;overflow:hidden;border-left:1px dotted green;position:absolute;width:1px;height:100%;'/>").appendTo(n)[0],n.halignLine=r);var i={offset:10,bound:null,align:null},s={offset:10,bound:null,align:null};for(var o=0;o<t.length;o++){var u=t[o],a=Math.abs(e.y-u.y);a<i.offset&&(i.offset=a,i.bound=u,i.align="top");if(Math.abs(u.h-e.h)>2){var f=Math.abs(e.y+e.h/2-u.y-u.h/2);f<i.offset&&(i.offset=f,i.bound=u,i.align="vcenter");var l=Math.abs(e.y+e.h-u.y-u.h);l<i.offset&&(i.offset=l,i.bound=u,i.align="bottom")}var c=Math.abs(e.x-u.x);c<s.offset&&(s.offset=c,s.bound=u,s.align="left");if(Math.abs(u.w-e.w)>2){var h=Math.abs(e.x+e.w/2-u.x-u.w/2);h<s.offset&&(s.offset=h,s.bound=u,s.align="hcenter");var p=Math.abs(e.x+e.w-u.x-u.w);p<s.offset&&(s.offset=p,s.bound=u,s.align="right")}}return i.bound?(i.align=="top"?(e.y=i.bound.y,n.valignLine.style.top=i.bound.y+"px"):i.align=="vcenter"?(e.y=i.bound.y+i.bound.h/2-e.h/2,n.valignLine.style.top=i.bound.y+i.bound.h/2+"px"):(e.y=i.bound.y+i.bound.h-e.h,n.valignLine.style.top=i.bound.y+i.bound.h+"px"),n.valignLine.style.left=n.scrollLeft+"px",n.valignLine.style.display="block"):n.valignLine.style.display="none",s.bound?(s.align=="left"?(e.x=s.bound.x,n.halignLine.style.left=s.bound.x+"px"):s.align=="hcenter"?(e.x=s.bound.x+s.bound.w/2-e.w/2,n.halignLine.style.left=s.bound.x+s.bound.w/2+"px"):(e.x=s.bound.x+s.bound.w-e.w,n.halignLine.style.left=s.bound.x+s.bound.w+"px"),n.halignLine.style.top=n.scrollTop+"px",n.halignLine.style.display="block"):n.halignLine.style.display="none",e}function hiddenAlignLine(e){e||(e=document.body),e.valignLine&&(e.valignLine.style.display="none"),e.halignLine&&(e.halignLine.style.display="none")}var $=require("jquery"),jQuery=$;if(!$.browser){if($.browser)return;$.browser={},$.browser.mozilla=!1,$.browser.webkit=!1,$.browser.opera=!1,$.browser.msie=!1;var nAgt=navigator.userAgent;$.browser.name=navigator.appName,$.browser.fullVersion=""+parseFloat(navigator.appVersion),$.browser.majorVersion=parseInt(navigator.appVersion,10);var nameOffset,verOffset,ix;(verOffset=nAgt.indexOf("Opera"))!=-1?($.browser.opera=!0,$.browser.name="Opera",$.browser.fullVersion=nAgt.substring(verOffset+6),(verOffset=nAgt.indexOf("Version"))!=-1&&($.browser.fullVersion=nAgt.substring(verOffset+8))):(verOffset=nAgt.indexOf("MSIE"))!=-1?($.browser.msie=!0,$.browser.name="Microsoft Internet Explorer",$.browser.fullVersion=nAgt.substring(verOffset+5)):(verOffset=nAgt.indexOf("Chrome"))!=-1?($.browser.webkit=!0,$.browser.name="Chrome",$.browser.fullVersion=nAgt.substring(verOffset+7)):(verOffset=nAgt.indexOf("Safari"))!=-1?($.browser.webkit=!0,$.browser.name="Safari",$.browser.fullVersion=nAgt.substring(verOffset+7),(verOffset=nAgt.indexOf("Version"))!=-1&&($.browser.fullVersion=nAgt.substring(verOffset+8))):(verOffset=nAgt.indexOf("Firefox"))!=-1?($.browser.mozilla=!0,$.browser.name="Firefox",$.browser.fullVersion=nAgt.substring(verOffset+8)):(nameOffset=nAgt.lastIndexOf(" ")+1)<(verOffset=nAgt.lastIndexOf("/"))&&($.browser.name=nAgt.substring(nameOffset,verOffset),$.browser.fullVersion=nAgt.substring(verOffset+1),$.browser.name.toLowerCase()==$.browser.name.toUpperCase()&&($.browser.name=navigator.appName)),(ix=$.browser.fullVersion.indexOf(";"))!=-1&&($.browser.fullVersion=$.browser.fullVersion.substring(0,ix)),(ix=$.browser.fullVersion.indexOf(" "))!=-1&&($.browser.fullVersion=$.browser.fullVersion.substring(0,ix)),$.browser.majorVersion=parseInt(""+$.browser.fullVersion,10),isNaN($.browser.majorVersion)&&($.browser.fullVersion=""+parseFloat(navigator.appVersion),$.browser.majorVersion=parseInt(navigator.appVersion,10)),$.browser.version=$.browser.majorVersion}var pd={};$.fn.extend({setCapture:function(e){e.setCapture?e.setCapture():window.captureEvents&&window.captureEvents(Event.MOUSEMOVE|Event.MOUSEUP)},releaseCapture:function(e){e.releaseCapture?e.releaseCapture():window.captureEvents&&window.captureEvents(Event.MOUSEMOVE|Event.MOUSEUP)}}),function(e){function t(t,n){return this.each(function(){if(typeof n!="string")return;if(!jQuery.isXMLDoc(this))return;var r=e.parseXml(n).firstChild.cloneNode(!0);switch(t){case"append":this.appendChild(r);break;case"prepend":this.childNodes.length>0?this.insertBefore(r,this.firstChild):this.appendChild(r);break;case"after":this.nextSibling?this.parentNode.insertBefore(r,this.nextSibling):this.parentNode.appendChild(r);break;case"before":this.parentNode.insertBefore(r,this)}})}e.fn.extend({appendXml:function(e){return t.call(this,"append",e)},prependXml:function(e){return t.call(this,"prepend",e)},afterXml:function(e){return t.call(this,"after",e)},beforeXml:function(e){return t.call(this,"before",e)},xml:function(){var e=this[0];return e.xml||(new XMLSerializer).serializeToString(e)},innerXml:function(){var e=this.xml(),t=e.indexOf(">"),n=e.lastIndexOf("<");return n>t?e.substring(t+1,n):""}}),e.extend(jQuery,{parseXml:function(e){var t;try{return t=(new DOMParser).parseFromString(e,"text/xml"),t}catch(n){return t=new ActiveXObject("Microsoft.XMLDOM"),t.async=!1,t.loadXML(e),t}},toXml:function(t,n,r){var i=e(e.parseXml("<"+n+" />")),s=i.find(":first");for(var o in t)r?s.attr(o,t[o]):s.appendXml("<"+o+" />").find(o).text(t[o]);return i[0]}})}(jQuery);var console,idx=0,msgBuf=[];println=function(e){console||(console=document.getElementById("console")),msgBuf.splice(0,0,e+"  ["+idx++ +"]\n"),console.value=msgBuf.join(" "),$("#console").val(msgBuf.join(" ")),idx%50==0&&msgBuf.splice(idx-1,1)};var XLINK_NS="http://www.w3.org/1999/xlink";pd.vml={},pd.vml.Shape=function(e){if(!e)return;for(var t in e)this[t]=e[t]},pd.vml.Shape.prototype={_commonStyle:"Behavior: url(#default#VML);position:absolute;width:100;height:100;",createVmlElement:function(e,t,n,r){var i=[],s;if($.browser.version=="7.0"||$.browser.version=="6.0"){for(var o in r)i.push(o+"='"+r[o]+"'");s=document.createElement("<"+t+" "+i.join(" ")+" style='"+n+"'></"+t+">")}else{s=document.createElement(t),n&&(s.style.cssText=n);if(r)for(var o in r)s.setAttribute(o,r[o])}return e&&e.appendChild(s),s},createRawNode:function(e,t,n){this.rawNode=this.createVmlElement(this.parent,e,t,n),this.rawNode.ownerFigure=this,this.setShape(this.shape),this.setText(this.text)},setShape:function(e){if(!e)return;this.shape=e;var t=$(this.rawNode);t.css({top:e.y+"px",left:e.x+"px",width:e.w+"px",height:e.h+"px"}),t.width()>0&&(t.width(e.w-(t.width()-e.w)),t.height(e.h-(t.height()-e.h))),this.updateTextPos()},getStroke:function(){return{color:this.rawNode.strokeColor,weight:this.rawNode.StrokeWeight}},setStroke:function(e){this.rawNode.strokeColor=e.color||"",this.rawNode.StrokeWeight=e.weight||"1px",this.rawNode.stroked=e.weight==0||e.weight=="0"?"f":"t"},setFill:function(e){typeof e=="string"?this.rawNode.fillcolor=e||"white":(this.rawNode.fillcolor=e.color||"green",this.rawNode.style.filter="alpha(opacity="+e.opacity*100||"100)")},moveToFront:function(){return this.rawNode.parentNode.appendChild(this.rawNode),this},getShape:function(){return this.shape},getBound:function(){if(this.rawNode){var e=$(this.rawNode),t=e.position();return{x:t.left,y:t.top,w:e.outerWidth(),h:e.outerHeight()}}},setText:function(e){this.text=e||"",this.text=this.text.replace(/@br@/gm,"<br/>"),this.rawNode&&(this.textNode||(this.textNode=document.createElement("span"),this.textColor=this.textColor?this.textColor:"black",$(this.textNode).css({cursor:"default",overflow:"auto",position:"absolute",font:"normal 12px 宋体, 'Arial Narrow', arial, serif",color:this.textColor}),this.parent.appendChild(this.textNode),this.textNode.ownerFigure=this.rawNode.ownerFigure),this.textNode.innerHTML=this.text,this.updateTextPos())},setVisible:function(e){var t=e?"":"none";this.rawNode.style.display=t,this.textNode&&(this.textNode.style.display=t)},getText:function(){return this.text.replace(/<br\/>/gm,"@br@")},setTextColor:function(e){this.textColor=e,this.textNode&&$(this.textNode).css({color:e})},updateTextPos:function(){if(this.textNode){var e=this.getShape(),t=this.calcTextSize(),n=t.w,r=t.h;this.textNode.style.width=n+1+"px",this.textNode.style.left=e.x+(e.w-n)/2+"px",this.textNode.style.top=e.y+(e.h-r)/2+"px"}},calcTextSize:function(){var e=document.createElement("span");e.style.position="absolute",e.style.top="-100px",e.style.font="normal 12px 宋体, 'Arial Narrow', arial, serif",document.body.appendChild(e),e.innerHTML=this.text;var t=e.offsetWidth,n=e.offsetHeight;return document.body.removeChild(e),{w:t,h:n}},dispose:function(){this.textNode&&(this.textNode.ownerFigure=null),this.parent.removeChild(this.rawNode),this.textNode&&this.parent.removeChild(this.textNode);for(var e in this)this[e]=null}},pd.vml.Rect=function(e){pd.vml.Shape.call(this,e),this.createRawNode("v:RoundRect",this._commonStyle)},pd.vml.Rect.prototype=new pd.vml.Shape,pd.vml.Triangular=function(e){pd.vml.Shape.call(this,e),this.createRawNode("v:shape",this._commonStyle,{coordsize:"100 100",path:"m 0,0 l 100,0,50,100,0,0 x e"})},pd.vml.Triangular.prototype=new pd.vml.Shape,pd.vml.Rhombus=function(e){pd.vml.Shape.call(this,e),this.createRawNode("v:shape",this._commonStyle,{coordsize:"100 100",path:"m 0,50 l 50,0,100,50,50,100,0,50 x e"})},pd.vml.Rhombus.prototype=new pd.vml.Shape,pd.vml.Circle=function(e){pd.vml.Shape.call(this,e),this.createRawNode("v:oval",this._commonStyle)},pd.vml.Circle.prototype=new pd.vml.Shape,pd.vml.Trapezoid=function(e){pd.vml.Shape.call(this,e),this.createRawNode("v:shape",this._commonStyle,{coordsize:"100 100",path:"m 0,0 l 100,0,75,100,25,100,0,0 x e"})},pd.vml.Trapezoid.prototype=new pd.vml.Shape,pd.vml.Path=function(e){pd.vml.Shape.call(this,e),this.createRawNode("v:shape",this._commonStyle+";display:inline-block;width:1px;height:1px;",{filled:"false",path:"m 0,0,0,0 x e",coordsize:"1 1"}),this.arrow=document.createElement("v:stroke"),this.arrow.style.cssText="BEHAVIOR: url(#default#VML);DISPLAY: inline-block;",this.rawNode.appendChild(this.arrow)},pd.vml.Path.prototype=new pd.vml.Shape,pd.vml.Path.prototype.setShape=function(e){this.shape=e;var t=["M"];for(var n=0,r=e.length;n<r;n++){var i=parseInt(e[n].x,10),s=parseInt(e[n].y,10);n==0?(t.push(i),t.push(s)):(t.push("L"),t.push(i),t.push(s));if(e[n].attach){var o=e[n].attach,u=o.split(" ");for(var a=0;a<u.length/8;a++)t.push("L"),t.push(parseInt(u[0+a*8].replace("L",""),10)+","+parseInt(u[1+a*8],10)),t.push("C"),t.push(parseInt(u[2+a*8].replace("C",""),10)+","+parseInt(u[3+a*8],10)),t.push(parseInt(u[4+a*8],10)+","+parseInt(u[5+a*8],10)),t.push(parseInt(u[6+a*8],10)+","+parseInt(u[7+a*8],10))}}if($.browser.version=="9.0"){var f=this;setTimeout(function(){f.rawNode.path=t.join(" "),f.updateTextPos()},1)}else this.rawNode.path=t.join(" "),this.updateTextPos()},pd.vml.Path.prototype.updateTextPos=function(){if(this.textNode){var e=this.shape[0].x,t=this.shape[0].y,n=this.shape[1].x,r=this.shape[1].y,i=this.calcTextSize(),s=i.w,o=i.h;this.textNode.style.left=(e+n-s)/2+"px",this.textNode.style.top=(t+r-o)/2+"px"}},pd.vml.Path.prototype.paintEndArrow=function(){this.endArrow||(this.arrow.setAttribute("EndArrow","Classic"),this.arrow.EndArrow="Classic",this.endArrow=!0)},pd.vml.Path.prototype.paintStartArrow=function(){this.StartArrow||(this.arrow.setAttribute("StartArrow","Classic"),this.arrow.StartArrow="Classic",this.startArrow=!0)},pd.vml.Path.prototype.removeEndArrow=function(){this.endArrow&&(this.arrow.setAttribute("EndArrow",undefined),this.arrow.EndArrow=undefined,this.endArrow=!1)},pd.vml.Path.prototype.removeStartArrow=function(){this.startArrow&&(this.arrow.setAttribute("StartArrow",undefined),this.arrow.StartArrow=undefined,this.startArrow=!1)};var SVG_NS="http://www.w3.org/2000/svg";return pd.svg={},pd.svg.Shape=function(e){if(!e)return;for(var t in e)this[t]=e[t]},pd.svg.Shape.prototype={createRawNode:function(e,t){this.rawNode=document.createElementNS(SVG_NS,e);var n=t.split(";");for(var r=0;r<n.length;r++){var i=n[r];i.indexOf(":")!=-1&&(i=i.split(":"),this.rawNode.setAttribute(i[0],i[1]))}this.parent.appendChild(this.rawNode),this.rawNode.ownerFigure=this,this.setShape(this.shape),this.setText(this.text)},setShape:function(e){return this.shape=e,this.rawNode.setAttribute("width",e.w),this.rawNode.setAttribute("height",e.h),this.rawNode.setAttribute("x",e.x),this.rawNode.setAttribute("y",e.y),this.updateTextPos(),this},setStroke:function(e){this.rawNode.setAttribute("stroke",e.color),this.rawNode.setAttribute("stroke-width",e.weight)},setFill:function(e){if(typeof e=="string"){this.rawNode.setAttribute("fill",e);return}return e.color!==undefined&&this.rawNode.setAttribute("fill",e.color),e.opacity!==undefined&&this.rawNode.setAttribute("opacity",e.opacity),this},moveToFront:function(){return this.rawNode.parentNode.appendChild(this.rawNode),this},getShape:function(){return this.shape},getBound:function(){if(this.rawNode)return this.shape},setText:function(e){this.text=e||"",this.text=this.text.replace(/@br@/gm,"");if(this.rawNode){this.textNode||(this.textColor=this.textColor?this.textColor:"black",this.textNode=document.createElementNS(SVG_NS,"text"),this.textNode.setAttribute("style","font-size:13px;fill: "+this.textColor+";"),this.textNode.ownerFigure=this.rawNode.ownerFigure,this.parent.appendChild(this.textNode));while(this.textNode.firstChild)this.textNode.removeChild(this.textNode.firstChild);e!=""&&(this.textNode.appendChild(document.createTextNode(this.text)),this.updateTextPos())}},getText:function(){return this.text.replace(/<br\/>/gm,"@br@")},setVisible:function(e){var t=e?"":"none";this.rawNode.style.display=t,this.textNode&&(this.textNode.style.display=t)},setTextColor:function(e){this.textColor=e,this.textNode&&this.textNode.setAttribute("style","fill: "+e+";")},updateTextPos:function(){if(this.textNode){var e=this.getBound(),t=this.calcTextSize(),n=t.w;this.textNode.setAttribute("x",e.x+(e.w-n)/2),this.textNode.setAttribute("y",e.y+e.h/2+3)}},calcTextSize:function(){var e=document.createElement("span");e.style.position="absolute",e.style.top="-100px",e.style.fontSize="13px",document.body.appendChild(e),e.innerHTML=this.text;var t=e.offsetWidth,n=e.offsetHeight;return document.body.removeChild(e),{w:t,h:n}},dispose:function(){this.parent.removeChild(this.rawNode),this.textNode&&this.parent.removeChild(this.textNode)}},pd.svg.Rect=function(e){pd.svg.Shape.call(this,e),this.createRawNode("rect","fill:#ffffff;stroke-width:1;stroke:#000000;"),this.rawNode.setAttribute("rx",5)},pd.svg.Rect.prototype=new pd.svg.Shape,pd.svg.Triangular=function(e){pd.svg.Shape.call(this,e),this.createRawNode("polyline","fill:#ffffff;stroke-width:1;stroke:#000000;")},pd.svg.Triangular.prototype=new pd.svg.Shape,pd.svg.Triangular.prototype.setShape=function(e){this.shape=e;var t=e.x,n=e.x+e.w,r=e.y,i=e.y+e.h;this.rawNode.setAttribute("points",[t,r,n,r,(n+t)/2,i,t,r].join(" ")),this.updateTextPos()},pd.svg.Rhombus=function(e){pd.svg.Shape.call(this,e),this.createRawNode("polyline","fill:#ffffff;stroke-width:1;stroke:#000000;")},pd.svg.Rhombus.prototype=new pd.svg.Shape,pd.svg.Rhombus.prototype.setShape=function(e){this.shape=e;var t=e.x,n=e.x+e.w,r=e.y,i=e.y+e.h;this.rawNode.setAttribute("points",[t,(r+i)/2,(t+n)/2,r,n,(r+i)/2,(t+n)/2,i,t,(r+i)/2].join(" ")),this.updateTextPos()},pd.svg.Circle=function(e){pd.svg.Shape.call(this,e),this.createRawNode("circle","fill:#ffffff;stroke-width:1;stroke:#000000;")},pd.svg.Circle.prototype=new pd.svg.Shape,pd.svg.Circle.prototype.setShape=function(e){this.shape=e,this.rawNode.setAttribute("cx",e.x+e.w/2),this.rawNode.setAttribute("cy",e.y+e.h/2),this.rawNode.setAttribute("r",e.w<e.h?e.w/2:e.h/2),this.updateTextPos()},pd.svg.Trapezoid=function(e){pd.svg.Shape.call(this,e),this.createRawNode("polyline","fill:#ffffff;stroke-width:1;stroke:#000000;")},pd.svg.Trapezoid.prototype=new pd.svg.Shape,pd.svg.Trapezoid.prototype.setShape=function(e){this.shape=e;var t=e.x,n=e.x+e.w,r=e.y,i=e.y+e.h;this.rawNode.setAttribute("points",[t,r,n,r,n-e.w/4,i,t+e.w/4,i,t,r].join(" ")),this.updateTextPos()},pd.svg.Path=function(e){pd.svg.Shape.call(this,e),this.createRawNode("path","fill-opacity:0;stroke-width:1;stroke:#000000;")},pd.svg.Path.prototype=new pd.svg.Shape,pd.svg.Path.prototype.setShape=function(e){this.shape=e;var t=["M"];for(var n=0,r=e.length;n<r;n++){var i=parseInt(e[n].x,10),s=parseInt(e[n].y,10);n==0?t.push(i+","+s):(t.push("L"),t.push(i+","+s));if(e[n].attach){var o=e[n].attach,u=o.split(" ");for(var a=0;a<u.length/8;a++)t.push("L"),t.push(parseInt(u[0+a*8].replace("L",""),10)+","+parseInt(u[1+a*8],10)),t.push("C"),t.push(parseInt(u[2+a*8].replace("C",""),10)+","+parseInt(u[3+a*8],10)),t.push(parseInt(u[4+a*8],10)+","+parseInt(u[5+a*8],10)),t.push(parseInt(u[6+a*8],10)+","+parseInt(u[7+a*8],10))}}this.rawNode.setAttribute("d",t.join(" ")),this.updateArrowPos(this.endArrow),this.updateTextPos()},pd.svg.Path.prototype.getBound=function(){var e=9999,t=9999,n=0,r=0;for(var i=0;i<this.shape.length;i++){var s=this.shape[i];e=Math.min(e,s.x),t=Math.min(t,s.y),n=Math.max(n,s.x),r=Math.max(r,s.y);if(s.attach){var o=s.attach.split(" ");for(var u=0;u<o.length;u++){var a=parseInt(o[u].replace("C",""));u%2==0?(e=Math.min(e,a),n=Math.max(n,a)):(t=Math.min(t,a),r=Math.max(r,a))}}}return{x:e,y:t,w:n-e,h:r-t}},pd.svg.Path.prototype.updateTextPos=function(){if(this.textNode){var e=this.shape[0].x,t=this.shape[0].y,n=this.shape[1].x,r=this.shape[1].y,i=this.calcTextSize(),s=i.w;this.textNode.setAttribute("x",(e+n-s)/2),this.textNode.setAttribute("y",(t+r)/2)}},pd.svg.Path.prototype.paintEndArrow=function(){if(!this.endArrow){var e=document.createElementNS(SVG_NS,"path");this.parent.appendChild(e),this.endArrow=e,this.updateArrowPos(e)}},pd.svg.Path.prototype.updateArrowPos=function(e){if(!e)return;var t=this.shape.length,n=this.shape[t-1].x,r=this.shape[t-1].y,i=this.shape[t-2].x,s=this.shape[t-2].y,o=n==i?s>r?"up":"down":i>n?"left":"right";o=="left"?e.setAttribute("d","M"+n+" "+r+" L"+(n+10)+" "+(r-3)+" L"+(n+10)+" "+(r+3)+" Z"):o=="right"?e.setAttribute("d","M"+n+" "+r+" L"+(n-10)+" "+(r-3)+" L"+(n-10)+" "+(r+3)+" Z"):o=="up"?e.setAttribute("d","M"+n+" "+r+" L"+(n-3)+" "+(r+10)+" L"+(n+3)+" "+(r+10)+" Z"):o=="down"&&e.setAttribute("d","M"+n+" "+r+" L"+(n-3)+" "+(r-10)+" L"+(n+3)+" "+(r-10)+" Z")},pd.svg.Path.prototype.setStroke=function(e){this.rawNode.style.stroke=e.color,this.rawNode.style.strokeWidth=e.weight,this.endArrow&&(this.endArrow.style.stroke=e.color,this.endArrow.style.fill=e.color)},pd.svg.Path.prototype.dispose=function(e){this.parent.removeChild(this.rawNode),this.textNode&&this.parent.removeChild(this.textNode),this.endArrow&&this.parent.removeChild(this.endArrow)},String.prototype.replaceAll=function(e,t){return this.replace(new RegExp(e,"gm"),t)},pd.graphics={},pd.process={},pd.PortDirection={UP:"n",RIGHT:"e",DOWN:"s",LEFT:"w"},pd.graphics.ManhattanConnectionRouter=function(){this.MINDIST=30,this.points=[]},pd.graphics.ManhattanConnectionRouter.prototype={route:function(e,t,n,r,i){var s=e.getShape();return t=t||s[0],n=n||e.outPort.direction,r=r||s[s.length-1],i=i||e.inPort.direction,this.points=[],this._route(e,r,i,t,n),this.points},isManhattanRouter:function(e){for(var t=0;t<e.length-1;t++)if(!this.isInAline(e[t],e[t+1]))return!1;return!0},isInAline:function(e,t){return Math.abs(e.x-t.x)<.5||Math.abs(e.y-t.y)<.5?!0:!1},newPoint:function(e,t){return{x:e,y:t}},_route:function(e,t,n,r,i){var s=.1,o=.01,u="n",a="e",f="s",l="w",c=t.x-r.x,h=t.y-r.y,p,d;if(c*c<o&&h*h<o){this.points.push(this.newPoint(r.x,r.y));return}if(n==l)if(c>0&&h*h<s&&i==a)p=r,d=i;else{if(c<0)p=this.newPoint(t.x-this.MINDIST,t.y);else if(h>0&&i==f||h<0&&i==u)p=this.newPoint(r.x,t.y);else if(n==i){var v=Math.min(t.x,r.x)-this.MINDIST;p=this.newPoint(v,t.y)}else p=this.newPoint(t.x-c/2,t.y);h>0?d=u:d=f}else if(n==a)if(c<0&&h*h<s&&i==l)p=r,d=i;else{if(c>0)p=this.newPoint(t.x+this.MINDIST,t.y);else if(h>0&&i==f||h<0&&i==u)p=this.newPoint(r.x,t.y);else if(n==i){var v=Math.max(t.x,r.x)+this.MINDIST;p=this.newPoint(v,t.y)}else p=this.newPoint(t.x-c/2,t.y);h>0?d=u:d=f}else if(n==f)if(c*c<s&&h<0&&i==u)p=r,d=i;else{if(h>0)p=this.newPoint(t.x,t.y+this.MINDIST);else if(c>0&&i==a||c<0&&i==l)p=this.newPoint(t.x,r.y);else if(n==i){var v=Math.max(t.y,r.y)+this.MINDIST;p=this.newPoint(t.x,v)}else p=this.newPoint(t.x,t.y-h/2);c>0?d=l:d=a}else if(n==u)if(c*c<s&&h>0&&i==f)p=r,d=i;else{if(h<0)p=this.newPoint(t.x,t.y-this.MINDIST);else if(c>0&&i==a||c<0&&i==l)p=this.newPoint(t.x,r.y);else if(n==i){var v=Math.min(t.y,r.y)-this.MINDIST;p=this.newPoint(t.x,v)}else p=this.newPoint(t.x,t.y-h/2);c>0?d=l:d=a}this._route(e,p,d,r,i),this.points.push(t)}},pd.graphics.Utils={containInLine:function(e,t,n){var r=this.distance({x:n[0].x,y:n[0].y},{x:e,y:t}),i=this.distance({x:n[1].x,y:n[1].y},{x:e,y:t}),s=this.distance({x:n[1].x,y:n[1].y},{x:n[0].x,y:n[0].y}),o=Math.abs(s-r-i);return o<=3?!0:!1},containInRect:function(e,t,n){if(e>=n.x&&e<=n.x+n.w&&t>=n.y&&t<=n.y+n.h)return!0},distance:function(e,t){var n=e.x-t.x,r=e.y-t.y;return Math.sqrt(n*n+r*r)},manhattanRoute:function(e,t,n,r,i){return this.manhattanRouter||(this.manhattanRouter=new pd.graphics.ManhattanConnectionRouter),this.manhattanRouter.route(e,t,n,r,i)}},pd.graphics.Port=function(e){this.connections={};for(var t in e)this[t]=e[t];this.shape=this.shape||{x:0,y:0,w:12,h:12}},pd.graphics.Port.prototype={initFigure:function(){this.figure||(this.figure=new pd[this.figureType].Circle({parent:this.parent,shape:this.shape}),this.figure.setFill("green"),this.figure.setVisible(!1))},setVisible:function(e){this.visible=e,this.initFigure(),e||this.setHighLight(!1),this.figure.setVisible(e)},addConnection:function(e,t){this.connections[e.id]=e},hasConnection:function(){for(var e in this.connections)return!0;return!1},removeConnection:function(e){var t=e.id;this.connections[t]=null,delete this.connections[t]},getPortType:function(){if(this.connections)for(var e in this.connections){var t=this.connections[e];if(t.inPort==this)return"inPort";if(t.outPort==this)return"outPort"}return this.portType},getCenter:function(){var e=this.getShape();return{x:e.x+e.w/2,y:e.y+e.h/2}},setHighLight:function(e){this.initFigure();if(this.figureType!="vml")return;if(e&&!this.highLightPort){this.highLightPort=this.figure.createVmlElement(this.parent,"v:oval","z-index:1000;Behavior: url(#default#VML);position:absolute;width:19px;height:19px;",{filled:"t",fillcolor:"#f57bff",stroked:"f"});var t=this.figure.createVmlElement(this.highLightPort,"v:fill","",{opacity:"0.5"});this.highLightPort.appendChild(t);var n=this.getCenter();this.highLightPort.style.top=n.y-11+"px",this.highLightPort.style.left=n.x-11+"px"}else!e&&this.highLightPort&&(this.parent.removeChild(this.highLightPort),this.highLightPort=null)},updateConnectionPosition:function(e,t){var t=t||this.getCenter(),n=e.getShape(),r=0;this.getPortType()=="inPort"&&(r=n.length-1);var i=t.x-n[r].x,s=t.y-n[r].y;if(e.inPort&&e.outPort){var o=e.outPort.getCenter(),u=e.inPort.getCenter();n[0].x=o.x,n[0].y=o.y,n[n.length-1].x=u.x,n[n.length-1].y=u.y;var a=!1;for(var f=0,l=n.length;f<l;f++)if(n[f].cusMove){a=!0;break}if(!a)n=pd.graphics.Utils.manhattanRoute(e);else{var c=-1,h=e.inPort.direction;r==n.length-1?c=r-1:(c=r+1,h=e.outPort.direction);switch(h){case pd.PortDirection.UP:case pd.PortDirection.DOWN:n[c].x+=i;break;case pd.PortDirection.LEFT:case pd.PortDirection.RIGHT:n[c].y+=s}}}for(var f=0,l=n.length;f<l;f++)n[f].x<0&&(n[f].x=1),n[f].y<0&&(n[f].y=1);e.setShape(n)},getBound:function(){this.initFigure();if(this.figureType=="vml"){var e=this.figure.rawNode.style.left,t=this.figure.rawNode.style.top,n=$(this.figure.rawNode),r=n.position();return{x:e?parseInt(e):r.left,y:t?parseInt(t):r.top,w:this.w,h:this.h}}return this.figure.getBound()},getShape:function(){return this.shape},setShape:function(e){this.shape=e,this.figure?this.figure.setShape(e):this.visible&&this.initFigure()},updatePosition:function(){if(this.calcuPosition){var e=this.calcuPosition.call(this),t=this.getShape();t.x=e.x-3,t.y=e.y-3,this.setShape(t);var n=this.getCenter();for(var r in this.connections){var i=this.connections[r];this.updateConnectionPosition(i)}if(this.highLightPort){var s=this.getCenter();this.highLightPort.style.top=s.y-6+"px",this.highLightPort.style.left=s.x-6+"px"}}},dispose:function(){this.highLightPort&&(this.highLightPort.parentNode.removeChild(this.highLightPort),this.highLightPort=null),this.figure&&this.figure.dispose(),this.figure=null}},pd.vml.Port=function(e){this.connections={},pd.vml.Shape.call(this,e),this.w=12,this.h=12,this.rawNode=this.createVmlElement(this.parent,"v:oval","display:none;z-index:1000;Behavior: url(#default#VML);position:absolute;width:"+this.w+"px;height:"+this.h+"px",{fillcolor:"green",stroked:"f"}),this.parent.appendChild(this.rawNode)},pd.vml.Port.prototype=new pd.vml.Shape,pd.vml.Port.prototype.setVisible=function(e){this.rawNode.style.display=e?"":"none"},pd.vml.Port.prototype.addConnection=function(e,t){this.connections[e.id]=e},pd.vml.Port.prototype.getPortType=function(){if(this.connections)for(var e in this.connections){var t=this.connections[e];if(t.inPort==this)return"inPort";if(t.outPort==this)return"outPort"}return this.portType},pd.vml.Port.prototype.removeConnection=function(e){var t=e.id;this.connections[t]=null,delete this.connections[t]},pd.vml.Port.prototype.getCenter=function(){var e=this.getShape();return{x:e.x+e.w/2,y:e.y+e.h/2}},pd.vml.Port.prototype.setVisible=function(e){e||this.setHighLight(!1),this.rawNode.style.display=e?"block":"none"},pd.vml.Port.prototype.setHighLight=function(e){if(e&&!this.highLightPort){this.highLightPort=this.createVmlElement(this.parent,"v:oval","z-index:1000;Behavior: url(#default#VML);position:absolute;width:19px;height:19px;",{filled:"t",fillcolor:"#f57bff",stroked:"f"});var t=this.createVmlElement(this.highLightPort,"v:fill","",{opacity:".5"});this.highLightPort.appendChild(t);var n=this.getCenter();this.highLightPort.style.top=n.y-9+"px",this.highLightPort.style.left=n.x-9+"px"}else!e&&this.highLightPort&&(this.parent.removeChild(this.highLightPort),this.highLightPort=null)},pd.vml.Port.prototype.updateConnectionPosition=function(e,t){var t=t||this.getCenter(),n=e.getShape(),r=0;this.getPortType()=="inPort"&&(r=n.length-1);var i=t.x-n[r].x,s=t.y-n[r].y;if(e.inPort&&e.outPort){var o=e.outPort.getCenter(),u=e.inPort.getCenter();n[0].x=o.x,n[0].y=o.y,n[n.length-1].x=u.x,n[n.length-1].y=u.y;var a=!1;for(var f=0,l=n.length;f<l;f++)if(n[f].cusMove){a=!0;break}if(!a)n=pd.graphics.Utils.manhattanRoute(e);else{var c=-1,h=e.inPort.direction;r==n.length-1?c=r-1:(c=r+1,h=e.outPort.direction);switch(h){case pd.PortDirection.UP:case pd.PortDirection.DOWN:n[c].x+=i;break;case pd.PortDirection.LEFT:case pd.PortDirection.RIGHT:n[c].y+=s}}}for(var f=0,l=n.length;f<l;f++)n[f].x<0&&(n[f].x=1),n[f].y<0&&(n[f].y=1);e.setShape(n)},pd.vml.Port.prototype.getBound=function(){var e=this.rawNode.style.left,t=this.rawNode.style.top,n=$(this.rawNode),r=n.position();return{x:e?parseInt(e):r.left,y:t?parseInt(t):r.top,w:this.w,h:this.h}},pd.vml.Port.prototype.updatePosition=function(){if(this.calcuPosition){var e=this.calcuPosition.call(this);this.setShape({x:e.x-3,y:e.y-3,w:this.w,h:this.h});var t=this.getCenter();for(var n in this.connections){var r=this.connections[n];this.updateConnectionPosition(r)}if(this.highLightPort){var i=this.getCenter();this.highLightPort.style.top=i.y-6+"px",this.highLightPort.style.left=i.x-6+"px"}}},pd.vml.Port.prototype.dispose=function(){this.highLightPort&&(this.highLightPort.parentNode.removeChild(this.highLightPort),this.highLightPort=null),pd.vml.Shape.prototype.dispose.call(this)},pd.graphics.ProcessRect=function(e,t){this.modelData=t,this.ownerCanvas=e,this.figureType=e.figureType,this.id=t.id;var n=this.type=t.type,r=t.style||{};r.bound&&(r.shape=r.bound,r.bound=null,delete r.bound),r.parent=e.canvasElement;var i,s=106,o=34,u=44,a,f,l,c=e.genaUniqueNameIdx(n);if(!this.ownerCanvas.version){var h=r.shape;h&&(h.w,h.h)}switch(n){case"start":i=[["inPort","e"],["outPort","s"],["inPort","w"]],s=u,o=u,a="开始",l="place";break;case"conditionActivity":i=[["inPort","n"],["outPort","s"]],a="条件环节"+c,f="true",l="condition-activity";break;case"businessActivity":i=[["inPort","n"],["","e"],["","s"],["","w"]],a="活动环节"+c,f="true",l="business-activity";break;case"conditionBranch":i=[["inPort","n"],["","e"],["","s"],["","w"]],a="条件分支"+c,o=40,f="true",l="if-else-activity";break;case"and":i=[["inPort","n"],["","e"],["","s"],["","w"]],s=u,o=u,a="AND",l="and-activity";break;case"xor":i=[["inPort","n"],["","e"],["","s"],["","w"]],s=u,o=u,a="XOR",l="place";break;case"autoActivity":i=[["inPort","n"],["","e"],["","s"],["","w"]],a="自动环节"+c,f="true",l="auto-activity";break;case"end":i=[["inPort","n"],["inPort","e"],["inPort","s"],["inPort","w"]],s=u,o=u,a="结束",l="place"}t.CONDITION=t.CONDITION||f,t.name=t.name||n+c,t.LABEL=t.LABEL||a,t.tagName=l;if(!t.xmlNode){var p="";l=="business-activity"&&t.ref&&(p=' ref="'+t.ref+'" ');var d=$.parseXml("<"+l+' name="'+t.name+'"'+p+'><label language="zh_CN"></label></'+l+">");t.xmlNode=d.childNodes[0]}else t.xmlNode.setAttribute("name",t.name);if(r.shape){var h=r.shape;h.x=h.x<1?100:h.x,h.y=h.y<1?100:h.y,h.w=h.w||s,h.h=h.h||o}else r.shape={x:100,y:100,w:s,h:o};this.figureTypeMap={businessActivity:"Rect",conditionActivity:"Triangular",conditionBranch:"Rhombus",and:"Circle",xor:"Circle",start:"Circle",end:"Circle",autoActivity:"Trapezoid"},this.rawFigureType=this.figureTypeMap[n];var v=t.LABEL,m=r.LABEL;m&&m.replaceAll("@br@","")==v?r.text=m:r.text=v;var g=new pd[this.figureType][this.rawFigureType](r);this.createPorts(i),this.rawFigure=g,g.rawNode.ownerFigure=this,g.textNode.ownerFigure=this,this.updatePortsPosition(),g.setStroke({color:"black"})},pd.graphics.ProcessRect.prototype={getRawFigure:function(){return this.rawFigure},getShape:function(){return this.rawFigure.getShape()},createGhost:function(){if(this.ghost)return this.ghost;var e=$.extend({},this.getShape());return this.ghost=new pd[this.figureType][this.rawFigureType]({parent:this.rawFigure.parent,shape:e}),this.ghost.rawNode.style.zIndex="2",this.ghost.setFill({color:"blue",opacity:.4}),this.ghost.setStroke({color:"blue"}),this.ghost},getModelData:function(){return{figureType:this.getType(),name:this.getName(),LABEL:this.getText(),CONDITION:this.modelData.CONDITION}},getName:function(){return this.modelData.name},getType:function(){return this.modelData.type},setShape:function(e){this.rawFigure.setShape(e),this.updatePortsPosition(),this.updateSelectBoxPosition()},getBound:function(){return this.rawFigure.getBound()},setText:function(e){this.rawFigure.setText(e),this.modelData.label=e},getText:function(){return this.rawFigure.getText()},getCenter:function(){var e=this.getShape();return{x:e.x+e.w/2,y:e.y+e.h/2}},getBindingConnections:function(){var e=[];for(var t=0,n=this.ports.length;t<n;t++){var r=this.ports[t].connections;for(var i in r)e.push(r[i])}return e},createPorts:function(e){var t=[];for(var n=0,r=e.length;n<r;n++){var i;switch(e[n][1]){case"n":i=function(){var e=this.owner.getShape();return{x:e.x+e.w/2-($.browser.msie?4:3),y:e.y-4}};break;case"e":this.type=="conditionBranch"?i=function(){var e=this.owner.getShape();return{x:e.x+e.w-10,y:e.y+e.h/2-($.browser.msie?5:3)}}:this.type=="autoActivity"?i=function(){var e=this.owner.getShape();return{x:e.x+e.w-19,y:e.y+e.h/2-($.browser.msie?5:3)}}:i=function(){var e=this.owner.getShape();return{x:e.x+e.w-4,y:e.y+e.h/2-($.browser.msie?5:3)}};break;case"s":this.type=="conditionBranch"?i=function(){var e=this.owner.getShape();return{x:e.x+e.w/2-($.browser.msie?4:3),y:e.y+e.h-($.browser.msie?6:4)}}:i=function(){var e=this.owner.getShape();return{x:e.x+e.w/2-($.browser.msie?4:3),y:e.y+e.h-4}};break;case"w":this.type=="conditionBranch"?i=function(){var e=this.owner.getShape();return{x:e.x-3,y:e.y+e.h/2-($.browser.msie?5:3)}}:this.type=="autoActivity"?i=function(){var e=this.owner.getShape();return{x:e.x+8,y:e.y+e.h/2-($.browser.msie?5:3)}}:i=function(){var e=this.owner.getShape();return{x:e.x-4,y:e.y+e.h/2-($.browser.msie?5:3)}}}t.push(new pd.graphics.Port({figureType:this.figureType,direction:e[n][1],parent:this.ownerCanvas.canvasElement,owner:this,portType:e[n][0],calcuPosition:i})),this.ports=t}},getPort:function(e,t){e=e=="inPort"?"outPort":"Inport";var n=null;for(var r=0,i=this.ports.length;r<i;r++)if(this.ports[r].getPortType()!=e){n=this.ports[r];if(!t)return this.ports[r];if(this.ports[r].direction==t)return this.ports[r]}return n},setSelection:function(){if(this.selectionBoxE)return;var e=this.rawFigure.getBound(),t=[],n="height:6px;line-height:6px;width:6px;background:green;position:absolute;";t.push('<div style="; width:'+(e.w+5)+"px;height:"+(e.h+4)+"px;top:"+(e.y-2)+"px;left:"+(e.x-3)+'px;z-index:1;position:absolute;padding:2px;">'),t.push('  <div name="selectBoxContainer" style="background:blue;filter:alpha(opacity=5);opacity: 0.1;width:100%;height:100%;border:1px dotted red;cursor:default;"></div>'),t.push('  <div dir="wn" name="selectBox" style="'+n+'top:0;left:0;cursor:nw-resize">&nbsp;</div>'),t.push('  <div dir="ne" name="selectBox" style="'+n+'top:0;right:-1px;cursor:ne-resize">&nbsp;</div>'),t.push('  <div dir="es" name="selectBox" style="'+n+'bottom:-1px;right:-1px;cursor:nw-resize"">&nbsp;</div>'),t.push('  <div dir="sw" name="selectBox" style="'+n+'bottom:-1px;left:0;cursor:ne-resize">&nbsp;</div>'),t.push('  <div dir="w" name="selectBox" style="'+n+'top:48%;left:0;cursor:e-resize">&nbsp;</div>'),t.push('  <div dir="e" name="selectBox" style="'+n+'top:48%;right:-1px;cursor:e-resize">&nbsp;</div>'),t.push('  <div dir="n" name="selectBox" style="'+n+'left:48%;top:0;cursor:s-resize">&nbsp;</div>'),t.push('  <div dir="s" name="selectBox" style="'+n+'left:48%;bottom:-1px;cursor:s-resize">&nbsp;</div>'),t.push("</div>"),this.selectionBoxE=$(t.join("")).appendTo(this.ownerCanvas.dContainer)[0],this.selectionBoxE.ownerFigure=this,this.selectionBoxE.owner=this},isSelected:function(){return this.selectionBoxE?!0:!1},clearSelection:function(){this.selectionBoxE&&(this.selectionBoxE.owner=null,this.selectionBoxE.parentNode.removeChild(this.selectionBoxE),this.selectionBoxE=null)},setPortsVisible:function(e,t){var n=this.ports;for(var r=0,i=n.length;r<i;r++)t?n[r].getPortType()!=t&&n[r].setVisible(e):n[r].setVisible(e)},getPortByPosition:function(e,t,n){var r=this.ports,i=1e3,s,o;for(var u=0,a=r.length;u<a;u++)if(r[u].getPortType()!=n){var f=r[u].getBound(),l=pd.graphics.Utils.distance(f,{x:e,y:t});l<i&&(i=l,o=r[u])}return o},updateSelectBoxPosition:function(){if(this.selectionBoxE){var e=this.rawFigure.getBound();$(this.selectionBoxE).css({left:e.x-2,top:e.y-2,width:e.w,height:e.h})}},executeDrag:function(e,t){var n=e.target;t.isDrag=!1,$.fn.setCapture(n);var r=t.mouseDownPos,i=r?r.x:e.clientX,s=r?r.y:e.clientY,o=[],u=this,a=t.selections,f=a.length,l=1e4,c=1e4,h=0,p=0;for(var d=0;d<f;d++)if(a[d].type!="connection"){var v=a[d].getShape();o.push({top:v.y,left:v.x}),l=Math.min(l,v.x),c=Math.min(c,v.y),h=Math.max(h,v.x+v.w),p=Math.max(p,v.y+v.h)}var m=[],g=t.figures;for(var y in g){var b=g[y];b.type!="connection"&&!b.isSelected()&&m.push(b.getShape())}var w=document,E={x:l,y:c,w:h-l,h:p-c};w.onmousemove=function(e){t.isDrag=!0,e=e||window.event;var r=e.clientX-i,o=e.clientY-s;if(r==0&&o==0)return;n.style.cursor="move",E.x=Math.max(l+r,9),E.y=Math.max(c+o,9),E=autoAlign(E,m,t.dContainer);for(var u=0;u<f;u++)if(a[u].type!="connection"){a[u].createGhost();var h=a[u].ghost.getShape();h.x=a[u].getShape().x+(E.x-l),h.y=a[u].getShape().y+(E.y-c),a[u].ghost.setShape(h)}},w.onmouseup=function(e){hiddenAlignLine(t.dContainer),e=e||window.event,$.fn.releaseCapture(n),w.onmousemove=null,w.onmouseup=null,n.style.cursor="default";if(e.clientX-i==0&&e.clientY-s==0)return;t.undoManager.startBatch();for(var r=0;r<f;r++)a[r].type!="connection"&&a[r].ghost&&(t.undoManager.changeShapeAction(a[r].id,a[r].ghost.getShape()),a[r].ghost.dispose(),a[r].ghost=null);t.undoManager.endBatch(),t.transInterPointToArc(),t.fireFigureStyleChanged()}},executeResize:function(e,t){var n=e.srcElement||e.target;$.fn.setCapture(n);var r=[],i=t.selections.length;for(var s=0;s<i;s++){var o=$(t.selections[s].selectionBoxE),u=o.position();r.push({top:u.top,left:u.left,width:o.outerWidth(),height:o.outerHeight()})}var a=e.clientX,f=e.clientY,l=n.getAttribute("dir"),c=20,h=20,p=this,d=function(e){e=e||window.event;var n=e.clientX-a,s=e.clientY-f,o=t.canvasElement.scrollLeft,u=t.canvasElement.scrollTop;for(var p=0;p<i;p++){var d=t.selections[p].selectionBoxE;if(t.selections[p]instanceof pd[t.figureType].Circle){var v=n>0?1:-1,m=s>0?1:-1;n=s=Math.min(Math.abs(n),Math.abs(s)),n=v*n,s=m*s}var g=r[p].width+n,b=r[p].width-n,w=r[p].height+s,E=r[p].height-s,S=r[p].top+s+u,T=r[p].left+n+o;l=="es"?g>h&&w>c&&$(d).width(g).height(w):l=="e"?g>h&&$(d).width(g):l=="s"?w>c&&$(d).height(w):l=="wn"?S>2&&T>2&&b-2>h&&E-2>c&&$(d).css({top:S,left:T,width:b-2,height:E-2}):l=="w"?T>2&&b-2>h&&$(d).css({left:T,width:b-2}):l=="n"?S>2&&E-2>c&&$(d).css({top:S,height:E-2}):l=="ne"?S>2&&g-2>h&&E-2>c&&$(d).css({top:S,width:g-2,height:E-2}):l=="sw"&&T>2&&w-2>c&&b-2>h&&$(d).css({left:T,height:w-2,width:b-2})}},v=function(e){e=e||window.event,$.fn.releaseCapture(n),$.browser.msie?($(n).unbind("mousemove"),$(n).unbind("mouseup")):($(document.body).unbind("mousemove"),$(document.body).unbind("mouseup"));if(e.clientX-a==0&&e.clientY-f==0)return;var i=t.canvasElement.scrollLeft,s=t.canvasElement.scrollTop;t.undoManager.startBatch();for(var o=0,u=t.selections.length;o<u;o++){var l=$(t.selections[o].selectionBoxE),c=l.position(),h=c.left-r[o].left,d=c.top-r[o].top,v=l.outerWidth()-r[o].width,m=l.outerHeight()-r[o].height,g=$.extend({},t.selections[o].getShape());g.x+=h,g.y+=d,g.w+=v,g.h+=m,t.undoManager.changeShapeAction(t.selections[o].id,g)}t.undoManager.endBatch(),p=null,t.transInterPointToArc(),t.fireFigureStyleChanged()};$.browser.msie?($(n).bind("mousemove",d),$(n).bind({mouseup:v})):($(document.body).bind("mousemove",d),$(document.body).bind({mouseup:v}))},updatePortsPosition:function(){var e=this.ports;if(e)for(var t=0,n=e.length;t<n;t++)e[t].updatePosition()},dispose:function(){this.clearSelection();if(this.ports)for(var e=0,t=this.ports.length;e<t;e++)this.ports[e].dispose();this.rawFigure.rawNode.ownerFigure=null,this.rawFigure.dispose();for(var n in this)this[n]=null}},pd.graphics.ProcessConnection=function(e,t){this.modelData=t,this.id=t.id,this.ownerCanvas=e,this.figureType=e.figureType;var n=t.style;n.parent=e.canvasElement,n.points&&(n.shape=n.points,n.points=null,delete n.points),this.rawFigure=new pd[this.figureType].Path(n),this.rawFigure.rawNode.ownerFigure=this,this.rawFigure.textNode.ownerFigure=this,this.type=t.type,t.varIn=t.varIn||"x",t.varOut=t.varOut||"x";var r=t.LABEL||t.text||n.LABEL,i=e.figures[t.sourceNode],s=e.figures[t.targetNode];if(i&&s){var o={0:"n",1:"e",2:"s",3:"w"};this.bindPort(s.getPort("inPort",o[n.inPortDir]||n.inPortDir+""),"inPort"),this.bindPort(i.getPort("outPort",o[n.outPortDir]||n.outPortDir+""),"outPort")}this.rawFigure.setStroke({color:"black",weight:"1px"}),this.rawFigure.paintEndArrow(),r&&this.setText(r)},pd.graphics.ProcessConnection.prototype={updateConditionBranch:function(e){if(!e.modelData||!e.modelData.xmlNode)return;var t=e.modelData.xmlNode,n=$("true-output",t),r=$("false-output",t),i=e.getBindingConnections(),s=!1,o=!1,u=[];for(var a=0;a<i.length;a++)if(i[a].outPort.owner==e){if(!i[a].inPort)continue;var f=i[a].inPort.owner.getName();f==n.attr("unit")?s=!0:f==r.attr("unit")?o=!0:u.push(i[a])}s||n.remove(),o||r.remove();var l,c;!s&&!o?(l=u[0],c=u[1]):s?o||(c=u[0]):l=u[0],l&&($(t).appendXml('<true-output name="x" xmlns="http://www.justep.com/model" unit="'+l.inPort.owner.getName()+'"/>'),l.setText("是")),c&&($(t).appendXml('<false-output name="x" xmlns="http://www.justep.com/model" unit="'+c.inPort.owner.getName()+'"/>'),c.setText("否"))},getRawFigure:function(){return this.rawFigure},getName:function(){return this.modelData.name||this.inPort&&this.outPort&&this.outPort.owner&&this.inPort.owner&&(this.modelData.name=this.outPort.owner.getName()+"|"+this.inPort.owner.getName()),this.modelData.name},getType:function(){return this.modelData.type},getModelData:function(){return{figureType:this.getType(),name:this.getName(),LABEL:this.getText(),sourceNode:this.outPort.owner.getName(),targetNode:this.inPort.owner.getName(),varIn:this.modelData.varIn,varOut:this.modelData.varOut}},getShape:function(){return this.rawFigure.getShape()},setShape:function(e,t){this.rawFigure.setShape(e),t||this.updateBoxPostion()},getBound:function(){return this.rawFigure.getBound()},setText:function(e){this.rawFigure.setText(e)},getText:function(){return this.rawFigure.getText()},bindPort:function(e,t,n){if(e){var r=this[t];r&&r.removeConnection(this),e.addConnection(this,t),t=="inPort"?this.modelData.targetNode=e.owner.id:t=="outPort"&&(this.modelData.sourceNode=e.owner.id),this[t]=e;if(this.inPort&&this.outPort){if(n)e.updateConnectionPosition(this);else{var i=this.getShape();i.length==2&&Math.abs(i[0].x-i[1].x)<2&&Math.abs(i[0].y-i[1].y)<2&&e.updateConnectionPosition(this)}this.modelData.name=this.outPort.owner.getName()+"|"+this.inPort.owner.getName(),this.outPort&&this.outPort.owner.type=="conditionBranch"&&this.updateConditionBranch(this.outPort.owner)}}},changePort:function(e){e=e||window.event;var t=e.srcElement||e.target;$.fn.setCapture(t);var n=e.clientX,r=e.clientY,i=t.index,s=t.ownerConnection,o=this.getShape(),u=[];for(var a=0,f=o.length;a<f;a++)u.push($.extend({},o[a]));var l=i==0?"outPort":"inPort",c={x:o[i].x,y:o[i].y},h,p,d=s.ownerCanvas.figures,v=s.ownerCanvas,m=i==0?s.inPort.owner:s.outPort.owner,g=function(e){e=e||window.event;var t=e.clientX-n,u=e.clientY-r;if(e.clientX<10||e.clientY<10)return;o=s.getShape(),i=i==0?0:o.length-1;var a=i==0?"inPort":"outPort";o[i].x=c.x+t,o[i].y=c.y+u,o=pd.graphics.Utils.manhattanRoute(s);for(var f=0,l=o.length;f<l;f++)o[f].x<0&&(o[f].x=1),o[f].y<0&&(o[f].y=1);s.setShape(o,!0),p=v.getPortByPos(o[i],a),p?p!=this.lastPort&&(this.lastPort&&(this.lastPort.setHighLight(!1),this.lastPort.ower!=p.owner&&this.lastPort.owner.setPortsVisible(!1),this.lastPort=null),v.hasConnection(m,p.owner,i==0?"outPort":"inPort",s)?p=null:(this.lastPort=p,p.owner.setPortsVisible(!0,a),p.setHighLight(!0))):this.lastPort&&(this.lastPort.owner.setPortsVisible(!1),this.lastPort=null)},y=$(t);$.browser.msie||(y=$(document.body));var b=function(e){e=e||window.event,y.unbind("mousemove").unbind("mouseup"),v.highLightFigure&&v.highLightFigure.setPortsVisible(!1);if(p&&p!=s.inPort&&s!=s.outPort){var n=s.outPort.owner.getName(),r=s.inPort.owner.getName();v.unSelection(s),s.ownerCanvas.undoManager.changePortAction(s.id,p,l),p.setHighLight(!1),s.ownerCanvas.transInterPointToArc(),v.addSelection(s);var i={eventType:"portChanged",jsFunc:"",portType:p.getPortType(),oldSourceNode:n,newSourceNode:s.outPort.owner.getName(),oldTargetNode:r,newTargetNode:s.inPort.owner.getName(),styles:v.getFigureStyles()};v.dispatchEvent(i)}else s.setShape(u);this.lastPort&&(this.lastPort.owner.setPortsVisible(!1),this.lastPort=null),$.fn.releaseCapture(t),u=null,s.ownerCanvas.highLightFigure=null,s.ownerCanvas.highLightPort=null,p=null};y.bind({mousemove:g,mouseup:b})},setSelection:function(){if(this.boxes)return;this.boxes=[];var e=this.ownerCanvas.dContainer,t="height:6px;line-height:6px;width:6px;background:green;position:absolute;z-index:1000;font-size:0;",n=this.rawFigure.getShape(),r=this;for(var i=0,s=1;i<n.length;i++){var o=$('<div style="'+t+"top:"+(n[i].y-2)+"px;left:"+(n[i].x-3)+'px;">&nbsp;</div>').appendTo(e)[0];if(i==0||i==n.length-1)o.style.cursor="move",$(o).bind("mousedown",function(e){r.changePort(e),e.stopPropagation()});this.boxes.push(o),o.ownerConnection=this,o.index=i}this.rawFigure.setStroke({color:"red",weight:"2"})},isSelected:function(){return this.boxes?!0:!1},clearSelection:function(){if(this.boxes){this.rawFigure.setStroke({color:"black",weight:"1px"});for(var e=0,t=this.boxes.length;e<t;e++)this.boxes[e].ownerConnection=null,this.boxes[e].index=null,this.boxes[e].onmousedown=null,this.boxes[e].parentNode.removeChild(this.boxes[e]);this.boxes=null}},executeResize:function(){},executeDrag:function(e,t){var n=e.srcElement||e.target;t.isDrag=!1;var r=this,i=e.clientX,s=e.clientY,o=t.selections.length,r=this,u=this.getShape(),a=t.dContainer.scrollLeft,f=t.dContainer.scrollTop,l=-1;for(var c=0,o=u.length-1;c<o;c+=1)if(pd.graphics.Utils.containInLine(i+a-$(t.dContainer).offset().left,s+f-$(t.dContainer).offset().top,[u[c],u[c+1]])){l=c;break}if(l<=0||l==u.length-2){$.fn.releaseCapture(n);return}var h=[{x:u[l].x,y:u[l].y},{x:u[l+1].x,y:u[l+1].y}],p=t.createShape({type:"Path",shape:h});p.setStroke({color:"red"});var n=p.rawNode;n.style.display="none",$.fn.setCapture(n);var d=[u[l].x,u[l].y,u[l+1].x,u[l+1].y],v=u[l].x==u[l+1].x?!1:!0,m=$(n);if(!$.browser.msie||!m.tagName)m=$(document.body);var g=function(e){t.isDrag=!0,e=e||window.event;if(e.clientX-i==0&&e.clientY-s==0)return;n.style.cursor="move";var r=e.clientX-i,o=e.clientY-s;n.style.display="";var u=t.canvasElement.scrollLeft,a=t.canvasElement.scrollTop,f=d[0]+r,l=d[1]+o,c=d[2]+r,m=d[3]+o;v?(d[1]+o>2&&(h[0].y=d[1]+o),d[3]+o>2&&(h[1].y=d[3]+o)):(d[0]+r>2&&(h[0].x=d[0]+r),d[2]+r>2&&(h[1].x=d[2]+r)),p.setShape(h)},y=function(e){e=e||window.event,$.fn.releaseCapture(n),n.style.cursor="default",m.unbind("mousemove").unbind("mouseup"),u=$.extend(!0,[],u);if(e.clientX!=i||e.clientY!=s)u[l].x=h[0].x,u[l].y=h[0].y,u[l+1].x=h[1].x,u[l+1].y=h[1].y,u[l].cusMove=!0,u[l+1].cusMove=!0,t.undoManager.changeShapeAction(r.id,u),t.transInterPointToArc(),t.fireFigureStyleChanged();p.dispose(),n=null,target=null,r=null};m.bind({mousemove:g,mouseup:y})},updateBoxPostion:function(){if(this.boxes){var e=this.getShape();for(var t=0,n=e.length;t<n;t++)$(this.boxes[t]).css({top:e[t].y-1,left:e[t].x-1})}},dispose:function(){this.clearSelection(),this.inPort&&this.inPort.removeConnection&&this.inPort.removeConnection(this),this.outPort&&this.outPort.removeConnection&&this.outPort.removeConnection(this),this.rawFigure.rawNode.ownerFigure=null,this.rawFigure.dispose();for(var e in this)this[e]=null}},pd.graphics.ProcessCanvas=function(e){if(!e)return;this.id=e.id,this.nameIdx=1,this.draggable=e.draggable,this.figureType=$.browser.msie&&$.browser.version<10?"vml":"svg",this.selections=[],this.figures={},this.idIdx=0,this._init()},pd.graphics.ProcessCanvas.prototype={processFile:"unknown",_init:function(){this.dContainer=document.getElementById(this.id);if(this.figureType=="vml"){document.namespaces.add("v","urn:schemas-microsoft-com:vml"),this.canvasElement=document.createElement('<v:group style="WIDTH: 2000px; POSITION: absolute; HEIGHT: 3000px;border:2px solid green;" coordsize="2000,3000">');var e=document.createElement('<v:rect style="LEFT: 0px; WIDTH: 2000px; TOP: 0px; HEIGHT: 3000px" coordsize="21600,21600" filled="f" stroked="f"></v:rect>');this.canvasElement.appendChild(e)}else this.canvasElement=document.getElementById("svgc");this.dContainer.appendChild(this.canvasElement),this._installListener(this)},_installListener:function(e){$(e.dContainer).bind({mousedown:function(t){e._mouseDown(t)},mouseup:function(t){e._mouseUp(t)},mousemove:function(t){e._mouseMove(t)},dblclick:function(t){e._dblClick(t)},keydown:function(t){e._keydown(t)},contextmenu:function(t){return e._showPopuMenu(t),!1}})},_unStallListener:function(){$(this.dContainer).unbind()},_keydown:function(e){var e=window.event;if(e.keyCode==116)return e.keyCode=0,e.cancelBubble=!0,!1;e.ctrlKey&&e.keyCode==65&&(this.selectAll(),e.keyCode=0,e.cancelBubble=!0),this.startCache();var t=0,n=0,r=this.selections.length;if(r>0){switch(e.keyCode){case 37:t=-1;break;case 38:n=-1;break;case 39:t=1;break;case 40:n=1}if(t!=0||n!=0){for(var i=0,s=this.selections.length;i<s;i++){var o=this.selections[i];if(o instanceof pd.graphics.ProcessRect){var u=o.getShape();u.x+=t,u.y+=n,o.setShape(u)}}this.transInterPointToArc(),this.endCache();return}}if(e.keyCode==27)this.selectProcessItemType();else if(e.keyCode==46)this.removeSelections();else if(e.keyCode==83&&e.ctrlKey){var a={eventType:"save",jsFunc:"",styles:this.getFigureStyles()};this.dispatchEvent(a)}else e.ctrlKey&&(e.keyCode==89?this.dispatchEvent({eventType:"redo"}):e.keyCode==90&&this.dispatchEvent({eventType:"undo"}));this.endCache()},_mouseDown:function(e){e=e||window.event;var t=e.srcElement||e.target;this.oldStyle=this.getFigureStyles(),e.button==2&&this.selectProcessItemType(),this.currentTextInput&&this.currentTextInput.blur();var n=this.getOwnerFigure(t);if(!$.browser.msie)n||(n=this.getFigureByPoint(e));else if(!this.processItemType&&!n&&this._isInScrollBar(e.clientX,e.clientY)||t.ownerConnection)return;this.mouseDownPos={x:e.clientX,y:e.clientY},this.mouseDownFlag=!0;if(this.processItemType){if(this.processItemType!="connection"){var r=this.undoManager.newAction({type:this.processItemType,style:{shape:{x:e.clientX+this.dContainer.scrollLeft-$(this.dContainer).offset().left+3,y:e.clientY+this.dContainer.scrollTop-3-$(this.dContainer).offset().top}}});this.fireAddFigureEvent(r),this.setSelection(r)}else this.currentPort&&(this.currentOutPort=this.currentPort,this.connectionGhost=this.createShape({type:"Path",shape:[this.currentOutPort.getCenter(),{x:e.clientX+this.dContainer.scrollLeft-$(this.dContainer).offset().left,y:e.clientY+this.dContainer.scrollTop+1-$(this.dContainer).offset().top}]}));return}if(t.getAttribute("name")=="selectBox")t.parentNode.owner.executeResize(e,this);else if(t.getAttribute("name")=="selectBoxContainer")e.ctrlKey||t.parentNode.owner.executeDrag(e,this);else if(n&&n.isProcessShape){if(!e.ctrlKey)if($.browser.msie)n.isSelected()||this.mouseIsOnFigure(e,n)&&this.executeSelect(e,n),n.isSelected()&&(this.mouseDownFigure=n);else{if(!this.mouseIsOnFigure(e,n)){var i;n instanceof pd.graphics.ProcessConnection&&(i=this.getFigureByPoint(e));if(!i){this.clearFlag=!0;return}n=i}n.isSelected()||this.executeSelect(e,n),this.mouseDownFigure=n}}else this._isInScrollBar(e.clientX,e.clientY)||(this.clearFlag=!0)},getFigureByPoint:function(e){var t=this.figures;for(var n in t){var r=t[n];if(this.mouseIsOnFigure(e,r))return r}},mouseIsOnFigure:function(e,t){if($.browser.msie&&(!document.documentMode||document.documentMode<10))return this.mouseIsOnFigure_svg(e,t);var n=$(this.dContainer).offset();if(t.rawFigure instanceof pd.svg.Path){var r=e.clientX+this.dContainer.scrollLeft-n.left,i=e.clientY+this.dContainer.scrollTop-n.top,s=t.rawFigure.getShape();for(var o=0;o<=s.length-2;o++){var u=s[o],a=s[o+1],n=$.browser.msie?10:10;if(u.x==a.x){if(u.x-n<r&&r<u.x+n&&Math.min(u.y,a.y)<=i&&i<=Math.max(u.y,a.y))return!0}else if(u.y-n<i&&i<u.y+n&&Math.min(u.x,a.x)<=r&&r<=Math.max(u.x,a.x))return!0}return!1}var f=t.getBound();return pd.graphics.Utils.containInRect(e.clientX+this.dContainer.scrollLeft-n.left,e.clientY+this.dContainer.scrollTop-n.top,f)?!0:!1},mouseIsOnFigure_svg:function(e,t){if(t.rawFigure instanceof pd.svg.Path){var n=e.layerX,r=e.layerY,i=t.rawFigure.getShape();for(var s=0;s<=i.length-2;s++){var o=i[s],u=i[s+1];if(o.x==u.x){if(o.x-10<n&&n<o.x+10&&Math.min(o.y,u.y)<=r&&r<=Math.max(o.y,u.y))return!0}else if(o.y-10<r&&r<o.y+10&&Math.min(o.x,u.x)<=n&&n<=Math.max(o.x,u.x))return!0}return!1}return!0},_mouseMove:function(e){e=e||window.event;if(this.processItemType){if(this.processItemType=="connection"){if(!this.mouseDownFlag||this.mouseDownFlag&&this.currentOutPort){var t=this.mouseDownFlag?"outPort":"inPort",n=this.getPortByPos({x:e.clientX+this.dContainer.scrollLeft-$(this.dContainer).offset().left,y:e.clientY+this.dContainer.scrollTop-$(this.dContainer).offset().top},t,this.currentOutPort?this.currentOutPort.owner:null);n?n!=this.currentPort&&(this.currentPort&&(this.currentPort.setHighLight(!1),this.currentPort.ower!=n.owner&&this.currentPort.owner.setPortsVisible(!1),this.currentPort=null),!this.currentOutPort||!this.hasConnection(this.currentOutPort.owner,n.owner,"inPort")?(this.currentPort=n,n.owner.setPortsVisible(!0,t),n.setHighLight(!0)):n=null):this.currentPort&&(this.currentPort.owner.setPortsVisible(!1),this.currentPort=null)}if(this.mouseDownFlag&&this.connectionGhost){var r=this.connectionGhost.getShape();r[r.length-1].x=e.clientX+this.dContainer.scrollLeft-$(this.dContainer).offset().left,r[r.length-1].y=e.clientY+this.dContainer.scrollTop-$(this.dContainer).offset().top,this.connectionGhost.setShape(r)}}return}this.mouseDownFigure?(this.mouseDownFigure.executeDrag(e,this),this.mouseDownFigure=null):this.mouseDownFlag&&this.clearFlag&&!this.selectDiv&&this._dragSelect(e,this)},_mouseUp:function(e){e=e||window.event;var t=e.srcElement||e.target;if(t==this.dContainer&&this._isInScrollBar(e.clientX,e.clientY))return;this.mouseDownFlag=!1,this.mouseDownFigure=null;if(this.processItemType){if(this.connectionGhost){if(this.currentPort&&this.currentOutPort.owner.id!=this.currentPort.owner.id){var n=this.connectionGhost.getShape(),r=this.undoManager.newAction({sourceNode:this.currentOutPort.owner.id,targetNode:this.currentPort.owner.id,type:this.processItemType,style:{outPortDir:this.currentOutPort.direction,inPortDir:this.currentPort.direction,shape:n}});this.fireAddFigureEvent(r),this.setSelection(r)}this.connectionGhost.dispose(),this.connectionGhost=null,this.transInterPointToArc()}this.currentPort&&this.currentPort.owner.setPortsVisible(!1),this.selectProcessItemType(),this.processItemType=null,this.currentPort=null,this.currentPort=null,this.currentOutPort=null,this.isDrag=!1,this.clearFlag=!1;return}if(t.ownerConnection){this.isDrag=!1,this.clearFlag=!1;return}var i;e.ctrlKey?(i=this.getOwnerFigure(t),i&&i.isProcessShape?this.executeSelect(e,i):t.getAttribute("name")=="selectBoxContainer"&&this.executeSelect(e,t.parentNode.owner.target)):!this.isDrag&&t.getAttribute("name")=="selectBoxContainer"?this.executeSelect(e,t.parentNode.owner||this.getOwnerFigure(t)):this.clearFlag?(this.clearSelection(),this.selectProcessRoot()):(i=this.getOwnerFigure(t),i&&i.isProcessShape&&this.executeSelect(e,i)),this.isDrag=!1,this.clearFlag=!1},_dragSelect:function(e,t){var n=e.clientX+t.dContainer.scrollLeft-$(t.dContainer).offset().left+3,r=e.clientY+t.dContainer.scrollTop-3-$(t.dContainer).offset().top,i=document,s=$("<div style='background:blue; filter:alpha(opacity=10);opacity:0.1; border:1px dotted green;position:absolute;top:"+r+"px;left:"+n+"px;font-size:0;height:1px;'>&nbsp;</div>").appendTo(t.dContainer);$.fn.setCapture(s[0]),this.selectDiv=s;var o=$(i.body),u=function(e){e=e||window.event;var i=e.clientX-n+t.dContainer.scrollLeft-$(t.dContainer).offset().left,o=e.clientY-r+t.dContainer.scrollTop-$(t.dContainer).offset().top;i<1&&s.css("left",n+i),s.width(Math.abs(i)),o<1&&s.css("top",r+o),s.height(Math.abs(o))},a=function(e){o.unbind("mousemove").unbind("mouseup");var n=s.position(),r={x:n.left+t.dContainer.scrollLeft,y:n.top+t.dContainer.scrollTop,w:s.width(),h:s.height()},i=t.figures;t.clearSelection();var u;for(var a in i){var f=i[a];if(f instanceof pd.graphics.ProcessRect){t.unSelection(f);var l=f.getBound();t.containInSelectBound(r,l)&&(t.addSelection(f,!0),u=f)}else f instanceof pd.graphics.ProcessConnection}u&&t.fireSelectChangedEvent("add",u),$.fn.releaseCapture(s[0]),s.remove().empty(),s=null,t.selectDiv=null,t.mouseDownFlag=!1,t.mouseDownFigure=null,t.isDrag=!1,t.clearFlag=!1,t=null};o.bind({mousemove:u,mouseup:a})},_showPopuMenu:function(e){e=e||window.event,this.popuPos={x:e.clientX-$(this.dContainer).offset().left,y:e.clientY+this.dContainer.scrollTop};var t=e.srcElement||e.target;this.currentFigure=null;var n=this.getOwnerFigure(t);t.getAttribute("name")=="selectBoxContainer"&&(n=t.parentNode.owner);var r=!1;if(n)this.currentFigure=n,r=!0;else{this.currentFigure=null;var i=$(this.dContainer).position();this.menuPos={x:e.clientX-i.left-$(this.dContainer).offset().left,y:e.clientY-i.top+this.dContainer.scrollTop-50}}var s={eventType:"contextmenu",jsFunc:"",haveSelect:r};return this.dispatchEvent(s),!1},hasConnection:function(e,t,n,r){if(e==t)return!0;if(e&&t){var i=e.getBindingConnections();for(var s=0,o=i.length;s<o;s++)if(i[s]!=r&&i[s][n].owner==t)return!0}},getPortByPos:function(e,t,n){var r=this.figures;for(var i in r){var s=r[i];if(s.isProcessShape&&s.type!="connection"){var o=s.getBound();if(e&&pd.graphics.Utils.containInRect(e.x,e.y,{x:o.x-5,y:o.y-5,w:o.w+5,h:o.h+5})&&s!=n)return s.getPortByPosition(e.x,e.y,t)}}},genaUniqueNameIdx:function(e){var t=this.nameIdx++,n=e+t;if(!this.getFigureByName(n))return this.nameIdx=1,t;t=this.genaUniqueNameIdx(e);if(t)return t},getFigureByName:function(e){var t=this.figures;for(var n in t){var r=t[n];if(e==r.getName())return r}},dispatchEvent:function(e){this.eventData=e},containInSelectBound:function(e,t){return Math.abs(e.x+e.x+e.w-(t.x+t.x+t.w))<e.x+e.w+t.x+t.w-e.x-t.x&&Math.abs(e.y+e.y+e.h-(t.y+t.y+t.h))<e.y+e.h+t.y+t.h-e.y-t.y},_dblClick:function(e){e=e||window.event;var t=e.srcElement||e.target,n=this.getOwnerFigure(t);if(n&&n.type=="connection"){var r=event.clientX+this.dContainer.scrollLeft-$(this.dContainer).offset().left,i=event.clientY+this.dContainer.scrollTop-$(this.dContainer).offset().top,s=this.getPointIndex(n,{x:r,y:i});this.insertPoint(n,s+1,{x:r,y:i}),this.insertPoint(n,s+2,{x:r,y:i})}else n?this.showLabelInput(n):t.ownerConnection&&this.removePoint(t.ownerConnection,t.index)},insertPoint:function(e,t,n){t=parseInt(t);var r=e.getShape(),i=r[t-1],s=r[t];i&&i.x==s.x?n.x=i.x:i&&i.y==s.y?n.y=i.y:s&&(n.x=s.x,n.y=s.y),r.splice(t,0,n),this.unSelection(e),e.setShape(r),this.addSelection(e)},removePoint:function(e,t){t=parseInt(t);var n=e.getShape();if(t>1&&t<n.length-2){t+2==n.length-1&&(t-=1),t-1===0&&(t+=1);var r=n[t-1],i=n[t],s=n[t+1];if(r.x==i.x&&r.y==i.y)n.splice(t-1,2);else if(i.x==s.x&&i.y==s.y)n.splice(t,2);else{var o=this.calcuNewPoint(r,i,s);n.splice(t-1,3,o)}this.unSelection(e),e.setShape(n),this.addSelection(e)}},calcuNewPoint:function(e,t,n){var r={};return e.x==t.x&&t.y==n.y?(r.x=n.x,r.y=e.y):e.y==t.y&&t.x==n.x?(r.x=e.x,r.y=n.y):e.x<t.x&&t.y<n.y?(r.x=e.x,r.y=n.y):e.x>t.x&&t.y<n.y?(r.x=e.x,r.y=n.y):e.x<t.x&&t.y>n.y&&(r.x=e.x,r.y=n.y),r},getPointIndex:function(e,t){var n=-1,r=e.getShape();for(var i=0,s=r.length;i<s;i++)if(i+1<r.length){var o=pd.graphics.Utils.containInLine(t.x,t.y,[{x:r[i].x,y:r[i].y},{x:r[i+1].x,y:r[i+1].y}]);if(o===!0)return i}return n},showLabelInput:function(e){return},getOwnerFigure:function(e){var t=e;while(t){var n=t.ownerFigure;if(n)return n;t=t.parentNode}},_isInScrollBar:function(e,t){return this.dContainer.scrollHeight!=this.dContainer.clientHeight&&e>this.dContainer.clientWidth||this.dContainer.scrollWidth!=this.dContainer.clientWidth&&t>this.dContainer.clientHeight?!0:!1},createProcessShape:function(e){var t={businessActivity:"Rect",conditionActivity:"Triangular",connection:"Path",conditionBranch:"Rhombus",and:"Circle",xor:"Circle",start:"Circle",end:"Circle",autoActivity:"Trapezoid"},n=e.type;e.id||(e.id=n+(new Date).getTime());var r;return this.initData&&($.extend(e,this.initData),this.initData=null),n!="connection"?r=new pd.graphics.ProcessRect(this,e):r=new pd.graphics.ProcessConnection(this,e),r.isProcessShape=!0,this.figures[r.id]=r,r},clear:function(){this.undoManager.clear(),this.clearSelection();for(var e in this.figures)this.figures[e].dispose();this.figures={}},loadData:function(e){this.clear();if(!e||e==="")return;this.version=e.version,this.modelData=e;var t=e.processMainData||{},n=[];for(var r in t){var i=t[r];i.id=r,i.style&&i.type!="connection"?this.createProcessShape(i):i.type=="connection"&&n.push(i)}for(var s=0,o=n.length;s<o;s++){var i=n[s],u=this.figures[i.sourceNode],a=this.figures[i.targetNode];if(!u||!a)continue;this.createProcessShape(i)}if(!this.version){var f=this.figures;for(var r in f){var l=f[r];l.type!="connection"&&l.updatePortsPosition()}}},createShape:function(e){return e.parent=this.canvasElement,new pd[this.figureType][e.type](e)},selectProcessItemType:function(e,t,n){if(!e){this.initData=null,this.processItemType=null,this.dContainer.style.cursor="default";return}var r=this.newShapeValidate(e);if(r){this.dContainer.style.cursor="default",alert(r);return}this.initData=n,this.processItemType=e,this.dContainer.style.cursor=e?"crosshair":"default";if(e&&e!="connection"&&this.selections.length>0){this.autoCreateShape(e);return}if(e&&t&&this.popuPos){this.dContainer.style.cursor="default",this.processItemType=null;var i=this.createProcessShape({type:e,style:{shape:{x:this.popuPos.x-5,y:this.popuPos.y-5}}});this.setSelection(i)}},autoCreateShape:function(e){var t,n,r=this.direction||"s";for(var i=0,s=this.selections.length;i<s;i++)if(this.selections[i]instanceof pd.graphics.ProcessRect&&this.selections[i].type!="end"){t=this.selections[i],t.type=="conditionBranch"?this.direction?n=t.getPort("outPort",r):(r="w",n=t.getPort("outPort","w"),n.hasConnection()&&(r="e",n=t.getPort("outPort","e"))):n=t.getPort("outPort",r),n||(n=t.getPort("outPort"));if(n)break}if(n){var o=t.getBound();this.undoManager.startBatch();var u=this.undoManager.newAction({type:e,style:{shape:{x:o.x,y:o.y}}}),a=u.getBound(),f=t.getCenter(),l=u.getCenter(),c=o.x,h=o.y,p=25,d;switch(r){case"n":h-=a.h+p,c-=l.x-f.x,d="s";break;case"e":c+=o.w+p,h-=l.y-f.y,d="w";break;case"s":h+=o.h+p,c-=l.x-f.x,d="n";break;case"w":c-=a.w+p,h-=l.y-f.y,d="e"}var v=u.getShape();v.x=Math.max(c,9),v.y=Math.max(h,9),u.setShape(v),this.fireAddFigureEvent(u);var m=u.getPort("inPort",d);m||(m=u.getPort("inPort"));if(m){var g=this.undoManager.newAction({type:"connection",sourceNode:n.owner.id,targetNode:m.owner.id,style:{outPortDir:n.direction,inPortDir:m.direction,shape:[n.getCenter(),m.getCenter()]}});this.fireAddFigureEvent(g)}this.processItemType=null,this.dContainer.style.cursor="default",this.setSelection(u),this.undoManager.endBatch()}},newShapeValidate:function(e){var t=this.figures;if(e=="start"||e=="end")for(var n in t)if(t[n].type==e)return"只能创建一个开始或者结束节点！"},getAllConnections:function(e){var t=[];for(var n in this.figures)this.figures[n].type=="connection"&&t.push(this.figures[n]);return t},removeCusPointFlag:function(e){var t=e.getShape();for(var n=0,r=t.length;n<r;n++)t[n].cusMove&&delete t[n].cusMove},transInterPointToArc:function(){this.arcs={};var e=this.getAllConnections(!0);for(var t=0,n=e.length;t<n;t++){var r=e[t],i=r.getShape(),s=this.calcuInterPoint(r,t+1,e);s&&r.setShape(i)}},getLineDirection:function(e,t){if(e.x==t.x)return t.y-e.y>0?pd.PortDirection.DOWN:pd.PortDirection.UP;if(e.y==t.y)return t.x-e.x>0?pd.PortDirection.RIGHT:pd.PortDirection.LEFT},arcR:4,calcuInterPoint:function(e,t,n){var r=this.arcR,i=!1,s=e.getShape(),o=n.length;for(var u=0;u<s.length-1;u++){s[u].attach&&(s[u].attach=null,delete s[u].attach,i=!0);var a=Math.min(s[u].x,s[u+1].x),f=Math.min(s[u].y,s[u+1].y),l=Math.max(s[u].x,s[u+1].x),c=Math.max(s[u].y,s[u+1].y),h=this.getLineDirection(s[u],s[u+1]);for(var p=t;p<o;p++){var d=n[p].getShape();if(s[u].x==s[u+1].x){for(var v=0;v<d.length-1;v+=1)if(d[v].y==d[v+1].y&&s[u].x>Math.min(d[v].x,d[v+1].x)&&s[u].x<Math.max(d[v].x,d[v+1].x)&&d[v].y>f&&d[v].y<c){s[u].attach=s[u].attach||[];var m=s[u].x,g=d[v].y,y=m+" "+(g-r)+" C"+(m-r)+" "+(g-r)+" "+(m-r)+" "+(g+r)+" "+m+" "+(g+r);h==pd.PortDirection.UP&&(y=m+" "+(g+r)+" C"+(m-r)+" "+(g+r)+" "+(m-r)+" "+(g-r)+" "+m+" "+(g-r)),s[u].attach.push({v:y,pos:g,x:m,y:g}),i=!0}}else if(s[u].y==s[u+1].y)for(var v=0;v<d.length-1;v+=1)if(d[v].x==d[v+1].x&&s[u].y>Math.min(d[v].y,d[v+1].y)&&s[u].y<Math.max(d[v].y,d[v+1].y)&&d[v].x>a&&d[v].x<l){s[u].attach=s[u].attach||[];var m=d[v].x,g=s[u].y,y=m-r+" "+g+" C"+(m-r)+" "+(g-r)+" "+(m+r)+" "+(g-r)+" "+(m+r)+" "+g;h==pd.PortDirection.LEFT&&(y=m+r+" "+g+" C"+(m+r)+" "+(g-r)+" "+(m-r)+" "+(g-r)+" "+(m-r)+" "+g),s[u].attach.push({v:y,pos:m,x:m,y:g}),i=!0}}if(s[u].attach){var b=s[u].attach.sort(function(e,t){return h==pd.PortDirection.UP||h==pd.PortDirection.LEFT?e.pos>t.pos?-1:1:e.pos>t.pos?1:-1}),w=[];for(var E=0;E<b.length;E++)w.push(b[E].v);s[u].attach=w.join(" L")}}return i},executeSelect:function(e,t){if(!t)return;if(this.labelChanging)return;var n=this.selections.length;e.type=="mousedown"?!e.ctrlKey&&n<=1&&this.setSelection(t):e.ctrlKey?t.isSelected()?this.unSelection(t):this.addSelection(t):n>1&&e.button!=2&&this.setSelection(t)},addSelection:function(e,t){e.isSelected()||(e.setSelection(),this.selections.push(e),t||this.fireSelectChangedEvent("add",e))},setSelection:function(e){this.clearSelection(),this.addSelection(e)},unSelection:function(e){var t=!1;for(var n=0;n<this.selections.length;n++)if(this.selections[n]==e){this.selections[n].clearSelection(),this.selections.splice(n,1),t=!0;break}t&&this.fireSelectChangedEvent("unselect")},clearSelection:function(){for(var e=0,t=this.selections.length;e<t;e++)this.selections[e].clearSelection();this.selections=[]},selectAll:function(){this.designer.clearSelection();var e=this.designer.figures,t;for(var n in e){var r=e[n];this.addSelection(e[n],!0),r.type!="connection"&&(t=r)}t&&this.fireSelectChangedEvent("add",t)},removeSelections:function(){var e=[],t=[];this.deleteFigures=[];var n=this.selections,r={};for(var i=0,s=n.length;i<s;i++)if(n[i].status){alert("当前环节不允许删除！");return}var o=[];for(var i=0,s=n.length;i<s;i++)o.push(n[i].id);this.undoManager.removeAction(o),this.selections=[];var u={eventType:"figureRemoved",jsFunc:"",removeids:e.join(","),types:t.join(","),styles:this.getFigureStyles()};this.dispatchEvent(u)},fireFigureStyleChanged:function(){this.startCache();var e={eventType:"figureChanged",jsFunc:"",styles:this.getFigureStyles(),oldStyles:this.oldStyle};this.dispatchEvent(e),this.endCache()},fireSelectChangedEvent:function(e,t){t||this.selections.length>0&&(t=this.selections[0]);var n={eventType:"selectChanged",jsFunc:"",selectType:t?t.getType():"",selectFigure:t?t.getName():""};this.dispatchEvent(n)},fireAddFigureEvent:function(e){var t={eventType:"figureAdded",jsFunc:"",styles:this.getFigureStyles()};$.extend(t,e.getModelData()),this.dispatchEvent(t)},startCache:function(){this.dispatchEvent({eventType:"startCache"})},endCache:function(){this.dispatchEvent({eventType:"endCache"})},setProcessFile:function(e){this.processFile=e||""},getFigureStyles:function(){var e={},t=this.figures;for(var n in t){var r=t[n],i=r.getName();r.type!="connection"?e[i]={shape:r.getShape(),LABEL:r.getText()}:e[i]={LABEL:r.getText(),outPortDir:r.outPort.direction,inPortDir:r.inPort.direction,targetNode:r.inPort.owner.getName(),sourceNode:r.outPort.owner.getName(),shape:r.getShape()}}var s=this.processFile.replaceAll("\\\\","/");return e={version:"2",shapeStyle:e,scale:this.scale,processFile:s.substring(s.lastIndexOf("/")+1)},JSON.stringify(e)},getFigureStyle:function(e){var t=e.getName();return e.type!="connection"?{shape:$.extend({},e.getShape()),LABEL:e.getText()}:{LABEL:e.getText(),outPortDir:e.outPort.direction,inPortDir:e.inPort.direction,targetNode:e.inPort.owner.getName(),sourceNode:e.outPort.owner.getName(),shape:$.extend([],e.getShape())}},selectProcessRoot:function(){var e={eventType:"selectChanged",jsFunc:"",selectType:"",selectFigure:""};this.dispatchEvent(e)},alignFigures:function(e){var t=this.selections;if(t.length<2)return;var n={x:1800,y:1800};for(var r=0,i=t.length;r<i;r++){var s=t[r];s instanceof pd.graphics.ProcessRect&&(e=="h"?n.y>s.getCenter().y&&(n=s.getCenter()):e=="v"&&n.x>s.getCenter().x&&(n=s.getCenter()))}var o=[];this.undoManager.startBatch();for(var r=0,i=t.length;r<i;r++){var s=t[r];if(s instanceof pd.graphics.ProcessRect){var u=$.extend({},s.getShape());o.push({figureId:s.id,value:$({},s.getBound())}),e=="h"?u.y=n.y-u.h/2:e=="v"&&(u.x=n.x-u.w/2),this.undoManager.changeShapeAction(s.id,u)}}this.undoManager.endBatch(),this.fireFigureStyleChanged()},dispose:function(){this._unStallListener(),this.clear(),this.dContainer.innerHTML="",this.dContainer.parentNode.removeChild(this.dContainer);for(var e in this)this[e]=null}},pd.graphics.ProcessWebCanvas=function(e){this.activities=e.activities,this.loadProcess=e.loadProcess,this.loadTemplate=e.loadTemplate,this.editProperties=e.editProperties,this.selectExecutor=e.selectExecutor,this.toolboxItems=e.toolboxItems,this.undoManager=pd.graphics.UndoRedoManager,this.undoManager.designer=this,pd.graphics.ProcessCanvas.call(this,e)},pd.graphics.ProcessWebCanvas.prototype=new pd.graphics.ProcessCanvas,pd.graphics.ProcessWebCanvas.prototype.nameMap={start:"start",end:"end",place:"place",arc:"connection",connection:"connection","and-activity":"and","xor-activity":"xor","business-activity":"businessActivity","if-else-activity":"conditionBranch","condition-activity":"conditionActivity","auto-activity":"autoActivity"},pd.graphics.ProcessWebCanvas.prototype._init=function(){var e=document.getElementById(this.id);this.initUI(e,this);if(this.figureType=="vml"){document.namespaces.add("v","urn:schemas-microsoft-com:vml"),this.canvasElement=document.createElement("v:group"),this.canvasElement.style.cssText="WIDTH: 100px; POSITION: absolute; HEIGHT: 100px;",this.canvasElement.setAttribute("coordsize","100,100");var t=pd.vml.Shape.prototype.createVmlElement(this.canvasElement,"v:rect","LEFT: 0px; WIDTH: 100px; TOP: 0px; HEIGHT: 100px",{filled:"f",stroked:"f"});this.dContainer.appendChild(this.canvasElement)}else{var n=document.createElementNS("http://www.w3.org/2000/svg","svg");n.setAttribute("width",4e3),n.setAttribute("height",2e3),n.setAttribute("version","1.1%"),this.canvasElement=n,this.dContainer.appendChild(n)}this.dContainer.appendChild(this.canvasElement),this._installListener(this),this.activities&&this.initToolbox(this.activities);var r=this;r._resizeFn=function(){r.layout()},$(window).bind("resize",r._resizeFn)},pd.graphics.ProcessWebCanvas.prototype.destroy=function(){$(window).unbind("resize",this._resizeFn)},pd.graphics.ProcessWebCanvas.prototype.setLoadTmplBtnVisible=function(e){$("button[name='loadTemplate']",this.dContainer.parentNode)[e?"show":"hide"]()},pd.graphics.ProcessWebCanvas.prototype.initUI=function(e,t){var n=this,r="";if(this.toolbar)for(var i in this.toolbar){var s=this.toolbar[i];r+='<button onclick="'+s.handler+';">'+s.text+"</button>"}var o='<div style="position:relative;overflow:auto;"><div class="canvas-toolbar">'+r+'<button name="editRules"  class="tool-item" style="width:80px"><span class="editRules">编辑规则</span></button>'+'<button name="loadModel" class="tool-item" style="width:92px;"><span class="icon load-process" >加载流程图</span></button>'+'<button name="loadTemplate" class="tool-item" style="width:80px"><span class="icon load-template">加载模板</span></button>'+'<button name="importTemplate" class="tool-item" ><span class="icon load-template">导入</span></button>'+'<button name="viewSource" class="tool-item" style=""><span class="icon load-template">源码</span></button>'+'<button name="copy" class="tool-item" style="text-align:left;"><span class="icon copy">复制</span></button><button name="delete" class="tool-item"><span class="icon remove">删除</span></button>'+'<button name="hAlign" class="tool-item" style="width:82px"><span class="icon h-align">水平对齐</span></button><button name="vAlign" class="tool-item" style="width:82px"><span class="icon v-align">垂直对齐</span></button>'+'<button name="undo" class="tool-item" disabled="true"><span class="icon undo">撤销</span></button><button name="redo" disabled="true" class="tool-item"><span class="icon redo">重做</span></button>'+'<button name="viewSoudce" class="tool-item" style="width:70px;display:none;">查看源码</button><button name="reload" class="tool-item" >刷新</button><span style="padding-left:10px;"></span><label style="font-size:10pt;padding-right:5px;">已流转</label><span style="width:15px;height:22px;display:inline;background:green;padding-left:30px;padding-top:3px;">&nbsp;</span><label style="font-size:10pt;padding-right:5px;padding-left:10px;">当前</label><span style="width:15px;height:22px;display:inline;background:#0080FF;padding-left:30px;padding-top:3px;">&nbsp;</span></div>'+'<div class="mydesigner" style="-moz-user-select:none;border:1px solid #8DB2E3;position:relative; width: 1000px; height:600px; ; overflow: auto" >'+"</div>"+'<div class="toolbox" style="width:150px;height:600px;position:absolute;top:25px;left:999px;border:1px solid #8DB2E3;overflow:hidden;background:white;overflow:auto;">'+'    <div class="toolbox-title"><span>环节列表</span></div>'+'    <ul class="toolbox-items">'+'       <li><a  onfocus="this.blur();" class="cancel-selected"  title="activity1">取消选择</a></li>'+'       <li style="padding:0;margin:0;font-size:0;position:relative;height:12px;position:relative;"><div style="position:absolute;top:8px;left:0;border-top:1px dotted #8DB2E3;font-size:0;height:0px;width:100%;"></div></li>'+'<li style="padding:0;margin:0;position:relative;height:18px;position:relative;"><div style="position:absolute;top:8px;left:0;border-top:1px dotted #8DB2E3;font-size:0;height:0px;width:100%;"></div></li>'+'<li><a  onfocus="this.blur();" class="start" label="开始" >开始</a></li>'+'<li><a onfocus="this.blur();" class="and-activity" label="and" title="conditionactivity1">and环节</a></li>'+'<li><a onfocus="this.blur();" class="xor-activity"  label="xor" title="conditionactivity1">xor环节</a></li>'+'<li><a onfocus="this.blur();" class="connection"  title="connection">连接</a></li>'+'<li><a onfocus="this.blur();" class="end" label="结束" >结束</a></li>'+"</ul>"+"</div>"+"</div>"+"</div>",u=$(o).appendTo(e||document.body).css({width:"100%",height:"100%"});this.dContainer=$(".mydesigner",u)[0],this.dContainer.style.cursor="default",this.dContainer.onselectstart=function(){return!1},$(".canvas-toolbar button",u).bind("click",function(){var e=$(this).attr("name");if(e!="setProp")if(e=="loadModel"){if(t.loadProcess){for(var r in t.figures){if(!confirm("加载流程图将会覆盖当前内容，是否要继续？"))return;break}t.setData(t.loadProcess.call(window))}}else if(e=="loadTemplate"){if(t.loadTemplate){for(var r in t.figures){if(!confirm("加载模板将会覆盖当前内容，是否要继续？"))return;break}t.setData(t.loadTemplate.call(window))}}else if(e=="importTemplate")t.showImportDlg(t);else if(e!="copyTemplate")if(e=="viewSource")t.showPropertyDlg(t,t.getData());else if(e=="copy")t.copyFigure();else if(e=="delete")t.removeSelections();else if(e=="trace"){var i=t.figures.deptActivity,s=t.figures.leadActivity,o=t.getTrace(i,s);t.setFillColor(o,"green")}else if(e=="reload"){var u=t.getData();t.setData(u)}else if(e=="vAlign")t.alignFigures("v");else if(e=="hAlign")t.alignFigures("h");else if(e=="undo")t.undoManager.undo();else if(e=="redo")t.undoManager.redo();else if(e=="editRules"){var a=n.figures,f=n.selections[0];if(n.selections.length!=1||f.type=="connection"||f.type=="xor"){alert("请先选中一个有效图形");return}n.editProperties(f,a)}}).bind("mouseover",function(){$(this).addClass("tool-item-over")}).bind("mouseout",function(){$(this).removeClass("tool-item-over")}),this.layout()},pd.graphics.ProcessWebCanvas.prototype.copyFigure=function(){var e=[];this.undoManager.startBatch();for(var t=0;t<this.selections.length;t++){var n=this.selections[t];if(n.type!="connection"){var r=n.getBound(),i=n.getText(),s=n.modelData.xmlNode;if(s){var o=$.parseXml($(s).xml());s=o.firstChild}e.push(this.undoManager.newAction({xmlNode:s,LABEL:i,type:n.type,style:{shape:{x:r.x+30,y:r.y+20,w:r.w,h:r.h}}}))}}this.undoManager.endBatch();if(e.length>0){this.clearSelection();for(var t=0;t<e.length;t++)this.addSelection(e[t])}},pd.graphics.ProcessWebCanvas.prototype.buildProperty=function(figure){var propContainer=$(".prop-area>.prop-list",this.dContainer.parentNode);$("select,input",propContainer).unbind();if(!figure){propContainer.html("");return}var htmlBuf=["<table cellspacing=0 cellpadding=0 style='font-size:10pt;'><tr>"],self=this,label=figure.getText(),xmlNode=figure.modelData.xmlNode,trueFalseOutput=[];htmlBuf.push('<td>标签：</td><td style="height:22px;"><input name="label"  value="'+label+'" class="prop-input" style="height:24px;margin-right:15px;" ></td>'),propContainer.html(htmlBuf.join(""));if(figure.type=="businessActivity"){var executeRule=$(">execute-rule",xmlNode),executorRange=$(">executor-range",executeRule),executeMode=$(">task-relation-value>item[relation='sExecuteMode']",executeRule),advanceRule=$(">advance-rule",xmlNode),customizedEnabled=advanceRule.attr("customized-enabled"),dRangeExpr=executorRange.attr("d-range-expr"),rangeExpr=executorRange.attr("range-expr"),executeModeName=executeMode.text();htmlBuf.push('<td>允许定制：</td><td><input name="customized-enabled" type="checkbox"  style="height:24px;margin-right:15px" ></td>'),htmlBuf.push('<td style="width:80px;">执行者模式：</td><td style="height:24px;"><select name="executeMode"  style="height:24px;margin-right:15px ">'),htmlBuf.push("<option value=\"'temPreempt'\">抢占</option>"),htmlBuf.push("<option value=\"'temSequential'\" >顺序</option>"),htmlBuf.push("<option value=\"'temSimultaneous'\" >同时</option>"),htmlBuf.push("</select></td>"),htmlBuf.push('<td style="width:60px;">执行者：</td><td style="height:22px;"><input name="executor-range" style="height:24px" class="prop-input" readonly  ></td><td><input class="tool-item" type="button" value="选择..." name="rangeExprSelect" style="height:24px;padding:0;margin:0"></td>'),htmlBuf.push("</tr></table>"),propContainer.html(htmlBuf.join("")),$("input[name='rangeExprSelect']",propContainer).bind("click",function(){if(self.selectExecutor){var executorRange=$(">execute-rule>executor-range",xmlNode),dRangeExpr=executorRange.attr("d-range-expr");dRangeExpr=eval("("+dRangeExpr+")");var rangeExpr=executorRange.attr("range-expr");self.selectExecutor.call(window,self,xmlNode,{items:dRangeExpr||[],expr:rangeExpr})}}),this.updatePropUI("customized-enabled",customizedEnabled),this.updatePropUI("executeMode",executeModeName),this.updatePropUI("executor-range",this.getExecutorDispay(dRangeExpr))}else if(figure.type=="conditionBranch"){var data=[],cons=figure.getBindingConnections();for(var i=0;i<cons.length;i++){var con=cons[i],targetFigure=con.outPort.owner;if(targetFigure==figure){var inPutFigure=con.inPort.owner,name=inPutFigure.getName();data.push([name,inPutFigure.getText()||name])}}trueFalseOutput=data,htmlBuf.push('<td>条件为真：</td><td><select name="true-output" style="margin-right:20px">');for(var i=0;i<data.length;i++)htmlBuf.push('<option value="'+data[i][0]+'" >'+data[i][1]+"</option>");htmlBuf.push("</select></td>"),htmlBuf.push('<td>条件为假：</td><td><select name="false-output" style="margin-right:20px">');for(var i=0;i<data.length;i++)htmlBuf.push('<option value="'+data[i][0]+'" >'+data[i][1]+"</option>");htmlBuf.push("</select></td>"),htmlBuf.push("</tr></table>"),propContainer.html(htmlBuf.join("")),this.updatePropUI("true-output",$("true-output",xmlNode).attr("unit")),this.updatePropUI("false-output",$("false-output",xmlNode).attr("unit"))}else htmlBuf.push("</tr></table>"),propContainer.html(htmlBuf.join(""));figure.status=="finished"?$("select,input",propContainer).attr("disabled","true"):$("select,input",propContainer).bind("change",function(){var e=$(this);self.updatePropertyFromUI(figure,e)})},pd.graphics.ProcessWebCanvas.prototype.updatePropertyFromUI=function(e,t){var n=e.modelData.xmlNode,r=t.attr("name"),i=t.val();if(r=="label")e.setText(i);else if(r=="executeMode")this.setExecuteRuleProp(r,i);else if(r=="customized-enabled")this.setExecuteRuleProp(r,$(t).prop("checked")+"");else if(r=="true-output"||r=="false-output"){var s=r=="true-output"?"false-output":"true-output",o=r=="true-output"?"是":"否";$(r,n).remove(),i&&$(n).appendXml("<"+r+' name="x" xmlns="http://www.justep.com/model" unit="'+i+'"/>'),this.setIfElseConnectionText(e,i,o);for(var u=0;u<trueFalseOutput.length;u++)if(trueFalseOutput[u][0]!=i){$(s,n).remove(),$(n).appendXml("<"+s+' name="x" xmlns="http://www.justep.com/model" unit="'+trueFalseOutput[u][0]+'"/>'),this.updatePropUI(s,trueFalseOutput[u][0]),this.setIfElseConnectionText(e,trueFalseOutput[u][0],s=="true-output"?"是":"否");break}}},pd.graphics.ProcessWebCanvas.prototype.setIfElseConnectionText=function(e,t,n){var r=e.getBindingConnections();for(var i=0;i<r.length;i++)if(r[i].inPort.owner.getName()==t){r[i].setText(n);break}},pd.graphics.ProcessWebCanvas.prototype.setExecuteRuleProp=function(e,t,n){n=n||this.selections[0].modelData.xmlNode;var r=$(">execute-rule",n);r.length===0&&(e=="executor-range"||e=="executeMode")&&($(n).appendXml('<execute-rule xmlns="http://www.justep.com/model"></execute-rule>'),r=$(">execute-rule",n));if(e=="customized-enabled"){var i=$(">advance-rule",n);i.length===0&&($(n).appendXml('<advance-rule xmlns="http://www.justep.com/model"></advance-rule>'),i=$(">advance-rule",n)),i.attr("customized-enabled",t)}else if(e=="executor-range"){var s=$(">executor-range",r);s.length===0&&(r.appendXml('<executor-range xmlns="http://www.justep.com/model"><kind>PSM</kind></executor-range>'),s=$(">executor-range",r)),s.attr("range-expr",t.expr),s.attr("default-expr",t.expr),s.attr("d-range-expr",JSON.stringify(t.items)),this.updatePropUI("executor-range",this.getExecutorDispay(JSON.stringify(t.items)))}else if(e=="executeMode"){var o=$(">task-relation-value",r);o.length===0&&(r.appendXml('<task-relation-value xmlns="http://www.justep.com/model"></task-relation-value>'),o=$(">task-relation-value",r));var u=$(">item[relation='sExecuteMode']",o);u.length===0?o.appendXml('<item relation="sExecuteMode" xmlns="http://www.justep.com/model">'+t+"</item>  "):u.text(t)}},pd.graphics.ProcessWebCanvas.prototype.updatePropUI=function(e,t){var n=$(".prop-area>.prop-list *[name='"+e+"']",this.dContainer.parentNode);e=="customized-enabled"?t=="true"?$(n).prop("checked",!0):$(n).prop("checked",!1):$(".prop-area>.prop-list *[name='"+e+"']",this.dContainer.parentNode).val(t)},pd.graphics.ProcessWebCanvas.prototype.getExecutorDispay=function(dRangeExpr){if(dRangeExpr){var names=[];dRangeExpr=eval("("+dRangeExpr+")");for(var i=0;i<dRangeExpr.length;i++){var fname=dRangeExpr[i].fname||"",idx=fname.lastIndexOf("/");idx!=-1&&(fname=fname.substring(idx+1)),names.push(fname)}return names.join(",")}return""},pd.graphics.ProcessWebCanvas.prototype.showPropertyDlg=function(e,t){if(this.propDialog)return;if(this.selections.length<0){alert("请选择需要设置的图形!");return}var n=this.selections[0],r=["<div style='position:absolute;border:1px solid #baceeb;background:white;width:650px;z-index:10000'><div class='toolbox-title' style=' height:22px;line-height:22px;padding-left:5px; '>流程源码</div>"];r.push("<div class='content' style='height:390px;padding:10px;'><textarea style='border:1px solid gray;width:622px;height:375px'></textarea></div>"),r.push("<div class='propdlg-footer' style='border:1px solid #baceeb;'> <button style='width:60px;float:right;' name='cancel'>关闭</button></div></div>"),this.propDialog=$(r.join("")).appendTo(document.body).css({top:document.body.clientHeight/2-260+"px",left:document.body.clientWidth/2-400+"px"}),$("textarea",this.propDialog).val(t),$(".propdlg-footer button",this.propDialog).bind("click",function(){var t=$(this).name;t=="ok",e.closePropertyDlg()})},pd.graphics.ProcessWebCanvas.prototype.showImportDlg=function(e){if(this.importDialog)return;var t=["<div style='z-index:3000;position:absolute;border:1px solid #baceeb;background:white;width:650px;'><div class='toolbox-title' style=' height:22px;line-height:22px;padding-left:5px; '>输入模板内容</div>"];t.push("<div class='content' style='height:390px;padding:10px;'><textarea style='border:1px solid gray;width:622px;height:375px'></textarea></div>"),t.push("<div class='propdlg-footer' style='border:1px solid #baceeb;'>  <button style='width:60px;float:right;' name='cancel'>取消</button> <button style='width:60px;float:right;' name='ok'>确定</button></div></div>"),this.importDialog=$(t.join("")).appendTo(document.body).css({top:document.body.clientHeight/2-260+"px",left:document.body.clientWidth/2-400+"px"}),$(".propdlg-footer button",this.importDialog).bind("click",function(){var t=$(this).attr("name");if(t=="ok"){var n=$("textarea",e.importDialog).val(),r=n.indexOf("</model>");if(r!=-1){var i=n.substring(0,r+8),s=n.substring(r+8);r=s.indexOf("{"),r!=-1&&(s=s.substring(r)),e.setData([i,s])}}$(".propdlg-footer button",e.importDialog).unbind(),e.importDialog.remove().empty(),e.importDialog=null})},pd.graphics.ProcessWebCanvas.prototype.closePropertyDlg=function(){this.propDialog&&($(".propdlg-footer button",this.propDialog).unbind(),this.propDialog.remove().empty(),this.propDialog=null)},pd.graphics.ProcessWebCanvas.prototype.layout=function(){var e=this;setTimeout(function(){var t=180,n=70,r=$(".canvas-toolbar").outerHeight(),i=$(e.dContainer).closest(".x-panel-content");i.length===0&&(i=$(e.dContainer.parentNode));var s=$(e.dContainer.parentNode).width()-t,o=i.height();$(".mydesigner",i).width(s+3).height(o-r-15),$(".prop-area",i).css({height:n,"border-top":"0",width:$(e.dContainer.parentNode).width()-2}),$(".toolbox",i).css({left:s+4,width:t-6,height:o-r-2-1-13,top:r})},200)},pd.graphics.ProcessWebCanvas.prototype.parseModelAsJson=function(e,t){if(!e)return{};t=t||{};var n=t.shapeStyle||{},r={verstion:t.version,processMainData:{LABEL:""}},i=(new Date).getTime(),s=e.childNodes,o;for(var u=0;u<s.length;u++){var a=s[u].tagName;if(a=="model"){var f=s[u].childNodes;for(var l=0;l<f.length;l++)if(f[l].tagName=="process"||f[l].tagName=="template"){o=f[l];break}break}if(a=="process"||a=="template"){o=s[u];break}}if(!o)return;var c=[];this.root=o;var h=this.nameMap,p=o.getAttribute("start"),d=o.getAttribute("end");r.templateName=o.getAttribute("name"),r.process=o.getAttribute("process"),this.startName=p,s=o.childNodes;var v=r.processMainData,m=[],g=[];for(var u=0,y=s.length;u<y;u++){var b=s[u],w=h[b.tagName];if(w){w=="place"&&(name==p?w="start":name==d?w="end":w="xor");var E=b.getAttribute("name");w=="connection"?(E=b.getAttribute("from")+"|"+b.getAttribute("to"),v[E]={sourceNode:b.getAttribute("from"),targetNode:b.getAttribute("to"),xmlNode:b,name:E,ref:E,type:w,LABEL:$(">label",b).text(),style:n[E]}):v[E]={xmlNode:b,name:E,ref:E,type:w,LABEL:$(">label",b).text(),style:n[E]},$(">output,>true-output,>false-output,>input",b).each(function(e){var t=$(this),r=t.attr("unit"),i=$(">label",t).text(),s,o,u;t[0].tagName=="input"?(s=r+"|"+E,o=r,u=E):(s=E+"|"+r,o=E,u=r);var a=v[s];a?a.LABEL=a.LABEL||i:v[s]={type:"connection",sourceNode:o,targetNode:u,LABEL:i,style:n[s]}})}else b.nodeType==1&&c.push($(b).xml())}return r.otherData=c,r},pd.graphics.ProcessWebCanvas.prototype.setData=function(data){if(!data)return;var xml=data[0],shape=data[1];shape=typeof shape=="string"?eval("("+shape+")"):shape;var xmlDoc=$.parseXml(xml),t1=(new Date).getTime(),modelData=this.parseModelAsJson(xmlDoc,shape);this.loadData(modelData);var currents=this.currentActivities=data[2]||[],finishedActivities=data[3]||[],isNew=data[4],currentColor="#0080FF",finishColor="green";if(isNew){for(var i=0,l=finishedActivities.length;i<l;i++){var figure=this.getFigureByName(finishedActivities[i]);figure&&this.setFillColor(figure,finishColor)}for(var p in this.figures){var figure=this.figures[p];if(figure.outPort&&figure.inPort){var outPortName=figure.outPort.owner.getName(),inPortName=figure.inPort.owner.getName();$.inArray(outPortName,finishedActivities)!=-1&&$.inArray(inPortName,finishedActivities)!=-1&&this.setFillColor(figure,finishColor)}}for(var i=0,l=currents.length;i<l;i++){var figure=this.getFigureByName(currents[i]);figure&&(figure.status="finished",this.setFillColor(figure,currentColor))}finishedActivities.length>0||currents.length>0?$("button[name='loadModel'],button[name='loadTemplate']",this.dContainer.parentNode).removeClass("tool-item-over").attr("disabled","true"):$("button[name='loadModel'],button[name='loadTemplate']",this.dContainer.parentNode).removeAttr("disabled")}else{if(finishedActivities.length>0)for(var i=0,l=finishedActivities.length;i<l;i++){var act=finishedActivities[i];if(act[2])continue;var from=this.figures[act[0]],to=this.figures[act[1]],trace=this.getTrace(from,to);for(var j=0,ll=trace.length;j<ll;j++)trace[j].status="finished",this.setFillColor(trace[j],finishColor)}if(currents.length>0)for(var p in this.figures){var figure=this.figures[p];for(var i=0;i<currents.length;i++)figure.getName()==currents[i]&&(figure.status="finished",this.setFillColor(figure,currentColor))}if(finishedActivities.length>0||currents.length>0){if(this.startName){var figure=this.getFigureByName(this.startName);if(figure){figure.status="finished",this.setFillColor(figure,finishColor);var cons=figure.getBindingConnections();for(var i=0;i<cons.length;i++)cons[i].outPort.owner==figure&&(cons[i].status="finished",this.setFillColor(cons[i],finishColor))}}$("button[name='loadModel'],button[name='loadTemplate']",this.dContainer.parentNode).removeClass("tool-item-over").attr("disabled","true")}else $("button[name='loadModel'],button[name='loadTemplate']",this.dContainer.parentNode).removeAttr("disabled")}},pd.graphics.ProcessWebCanvas.prototype.getTrace=function(e,t,n,r,i){if(e==t||e==i||!e||!t)return;n||(n=[],r=[!1],i=e,n.push(e));var s=e.getBindingConnections();for(var o=0;o<s.length;o++){if(s[o].outPort.owner==e){var u=s[o].inPort.owner;if(u==t){r[0]=!0,n.push(t),n.push(s[o]);break}this.getTrace(u,t,n,r,i||e),r[0]&&(n.push(u),n.push(s[o]))}if(r[0])break}return n},pd.graphics.ProcessWebCanvas.prototype.setFillColor=function(e,t){e=e.getRawFigure(),e.setFill(t),e.setStroke({color:t})},pd.graphics.ProcessWebCanvas.prototype.getData=function(){return[this.parseModelAsXml(),this.getFigureStyles()]},pd.graphics.ProcessWebCanvas.prototype.initToolbox=function(e){var t=this.dContainer.parentNode;$(".toolbox-items>li>a",t).unbind(),$(".toolbox-items>li[name='dynItem']",t).remove().empty(),this.modelNodeMap={};var n;$.browser.msie&&typeof e!="string"&&(e=e.xml);if(typeof e=="string"){var r=$.parseXml(e),i=r.childNodes;for(var s=0;s<i.length;s++)if(i[s].tagName=="items"){n=i[s];break}}else n=e;if(n){var o=[],u=n.childNodes;for(var s=0;s<u.length;s++){var a=u[s],f=a.getAttribute("activity")||"",l=a.childNodes[0],c=a.getAttribute("tag"),h=a.getAttribute("label")||f;c=="activity"&&(c="business-activity",l&&l.setAttribute("ref",f)),l&&(this.modelNodeMap[f]=l),"true"==a.getAttribute("isEnd")&&(c="end"),o.push('<li name="dynItem"><a  label="'+h+'"  onfocus="this.blur();" class="'+c+'" ref='+f+' title="'+f+'">'+h+"</a></li>")}$(".toolbox-items li:eq(1)",t).after(o.join(""));var p=this;$(".toolbox-items>li>a",t).each(function(e){var t=$(this);t.bind("mousedown",function(e){var n=t[0].className;if(t.hasClass("cancel-selected"))p.selectProcessItemType();else{var r=p.nameMap[n.split(" ")[0]];if(r){var i=p.modelNodeMap[t.attr("ref")];i&&(i=i.cloneNode(!0)),p.selectProcessItemType(r,!1,{ref:t.attr("ref"),xmlNode:i,LABEL:t.attr("label")||"",type:r})}}})})}},pd.graphics.ProcessWebCanvas.prototype.removeNs=function(e){return e=e.replace(/xmlns=""/gm,""),e=e.replace(/xmlns="http:\/\/www.justep.com\/model"/gm,""),e},pd.graphics.ProcessWebCanvas.prototype.parseModelAsXml=function(){var e="zh_CN",t=[],n,r,i;this.root&&(n||(n=this.root.getAttribute("start")),r||(r=this.root.getAttribute("end")));for(var s in this.figures){var o=this.figures[s];if(o.isProcessShape&&o.type!="connection"){var u=o.modelData,a=u.xmlNode,f=o.getBindingConnections(),l=!1;$("label",a).text(o.getText()),o.type=="start"?n=u.name:o.type=="end"&&(r=u.name);if(a.tagName=="place"){for(var c=0;c<f.length;c+=1)if(f[c].inPort.owner==o){l=!0;break}l===!1;if(a.getAttribute("name")!=n)t.push("  "+$(a).xml()+"\n");else{$("has-token",a).remove();var h="t"+(new Date).getTime();t.push('<token name="'+h+'"/> \n ');var p=$(a).xml(),d=p.indexOf("</place>");d!=-1&&(p=p.substring(0,d)+'<has-token token="'+h+'"/> '+p.substring(d)),t.push("  "+p+"\n")}continue}a&&$("input,output",a).remove();var p=[];for(var c=0;c<f.length;c+=1){var v=f[c];v.outPort.owner==o?a.tagName!="if-else-activity"&&$(a).appendXml('  <output name="x" xmlns="http://www.justep.com/model" unit="'+v.inPort.owner.getName()+'"/>\n'):(l=!0,$(a).appendXml('  <input name="x" xmlns="http://www.justep.com/model" unit="'+v.outPort.owner.getName()+'"/>\n'))}l==0&&(i=s),t.push("  "+$(a).xml()+"\n")}else{var m=o.outPort.owner,g=o.inPort.owner;m.modelData.tagName=="place"&&g.modelData.tagName=="place"&&t.push('<arc name="arc'+this.genaUniqueNameIdx("arc")+'" from="'+m.getName()+'" to="'+g.getName()+'"/>\n')}}n?n='start="'+n+'"':n="",r=r?'end="'+r+'"':"";var y=this.modelData.templateName,b=this.modelData.process;for(var c=0;c<t.length;c+=1)t[c]=this.removeNs(t[c]);return t.splice(0,0,'<?xml version="1.0" encoding="UTF-8"?>\n<model xmlns="http://www.justep.com/model">\n<template name="'+y+'" process="'+b+'" '+n+" "+r+">\n"),t.push("</template>\n</model>\n"),t.join("")},pd.graphics.ProcessWebCanvas.prototype.addSelection=function(e,t){e.isSelected()||(e.setSelection(),this.selections.push(e),t||this.fireSelectChangedEvent("add",e),this.buildProperty(e))},pd.graphics.ProcessWebCanvas.prototype.clearSelection=function(){var e=$(".prop-area>.prop-list",this.dContainer.parentNode);$("select,input",e).each(function(){$(this)[0].blur()});for(var t=0,n=this.selections.length;t<n;t++)this.selections[t]&&this.selections[t].clearSelection&&this.selections[t].clearSelection();this.selections=[],this.buildProperty(null)},pd.graphics.UndoRedoManager={designer:null,undoList:[],redoList:[],actions:[],isBatch:!1,clear:function(){this.undoList=[],this.redoList=[]},startBatch:function(){this.isBatch=!0,this.actions=[]},endBatch:function(){this.isBatch=!1,this.redoList=[],this.undoList.push(this.actions),this.updateButtonState()},addAction:function(e){e.designer=this.designer,this.isBatch?this.actions.push(e):(this.redoList=[],this.undoList.push([e])),this.updateButtonState()},newAction:function(e){var t=new pd.graphics.undoable.NewAction(e);return this.addAction(t),t.execute()},removeAction:function(e){if(e.length===0)return;var t=new pd.graphics.undoable.RemoveAction(e);return this.addAction(t),t.execute()},changeShapeAction:function(e,t){var n=new pd.graphics.undoable.ChangeShapeAction(e,t);return this.addAction(n),n.execute()},changePortAction:function(e,t,n){var r=new pd.graphics.undoable.ChangePortAction(e,t,n);return this.addAction(r),r.execute()},updateButtonState:function(){this.redoList.length===0?$("button[name='redo']",this.designer.dContainer.parentNode).removeClass("tool-item-over").attr("disabled","true"):$("button[name='redo']",this.designer.dContainer.parentNode).removeAttr("disabled"),this.undoList.length===0?$("button[name='undo']",this.designer.dContainer.parentNode).removeClass("tool-item-over").attr("disabled","true"):$("button[name='undo']",this.designer.dContainer.parentNode).removeAttr("disabled")},redo:function(){if(this.redoList.length===0)return;var e=this.redoList[this.redoList.length-1];if(e){for(var t=0;t<e.length;t++)e[t].execute();this.redoList.splice(this.redoList.length-1,1),this.undoList.push(e)}this.designer.transInterPointToArc(),this.updateButtonState()},undo:function(){if(this.undoList.length===0)return;var e=this.undoList[this.undoList.length-1];if(e){for(var t=0;t<e.length;t++)e[t].undo();this.undoList.splice(this.undoList.length-1,1),this.redoList.push(e)}this.designer.transInterPointToArc(),this.updateButtonState()}},pd.graphics.undoable={},pd.graphics.undoable.NewAction=function(e){this.modelData=$.extend({},e)},pd.graphics.undoable.NewAction.prototype={execute:function(){var e=this.designer.createProcessShape(this.modelData);this.id=e.id;if(e.type=="connection"&&e.getShape().length==2){var t=e.getShape();t[0].x!=t[1].x&&t[0].y!=t[1].y&&e.inPort.updateConnectionPosition(e)}return e},undo:function(){this.designer.unSelection(this.figure);var e=this.id,t=this.designer.figures[e];this.designer.figures[e]=null,delete this.designer.figures[e],t.dispose()}},pd.graphics.undoable.RemoveAction=function(e){this.ids=$.isArray(e)?e:[e],this.processRects=[],this.connections=[]},pd.graphics.undoable.RemoveAction.prototype={execute:function(){var e=[];for(var t=0;t<this.ids.length;t++){var n=this.ids[t],r=this.designer.figures[n];if(!r)continue;r.type!="connection"&&e.push(r);var i=r.getBindingConnections?r.getBindingConnections():[r];for(var s=0;s<i.length;s++){if(this.isInit!==!1){var o=$.extend({},i[s].modelData);o.style=this.designer.getFigureStyle(i[s]),this.connections.push(o)}this.designer.figures[i[s].id]=null,delete this.designer.figures[i[s].id],i[s].dispose()}}for(var t=0;t<e.length;t++){var r=e[t];if(this.isInit!=0){var o=$.extend({},r.modelData);o.style=this.designer.getFigureStyle(r),this.processRects.push(o)}this.designer.figures[r.id]=null,delete this.designer.figures[r.id],r.dispose()}this.isInit=!1},undo:function(){if(this.processRects)for(var e=0;e<this.processRects.length;e++)this.designer.createProcessShape(this.processRects[e]);if(this.connections)for(var e=0;e<this.connections.length;e++)this.designer.createProcessShape(this.connections[e])}},pd.graphics.undoable.ChangePortAction=function(e,t,n){this.id=e,this.newPort=t,this.portType=n},pd.graphics.undoable.ChangePortAction.prototype={execute:function(){var e=this.designer.figures[this.id];if(!this.oldPort){var t=e[this.portType];this.oldPortCfg={ownerId:t.owner.id,direction:t.direction}}if(!this.newPortCfg)e.bindPort(this.newPort,this.portType,!0),this.newPortCfg={ownerId:this.newPort.owner.id,direction:this.newPort.direction};else{var n=this.designer.figures[this.newPortCfg.ownerId].getPort(this.portType,this.newPortCfg.direction);e.bindPort(n,this.portType,!0)}},undo:function(){var e=this.designer.figures[this.id],t=this.designer.figures[this.oldPortCfg.ownerId].getPort(this.portType,this.oldPortCfg.direction);e.bindPort(t,this.portType,!0)}},pd.graphics.undoable.ChangeShapeAction=function(e,t){this.id=e,this.newShape=$.extend(!0,$.isArray(t)?[]:{},t)},pd.graphics.undoable.ChangeShapeAction.prototype={execute:function(){var e=this.designer.figures[this.id];this.oldShape||(this.oldShape=$.extend(!0,$.isArray(this.newShape)?[]:{},e.getShape())),e.setShape($.extend(!0,$.isArray(this.newShape)?[]:{},this.newShape))},undo:function(){this.designer.figures[this.id].setShape($.extend(!0,$.isArray(this.newShape)?[]:{},this.oldShape))}},pd.graphics.ProcessWebCanvas}),define("$model/UI2/system/components/justep/processDesigner/js/convter",["require","$UI/system/lib/justep","$UI/system/lib/base/xml"],function(e){var t=e("$UI/system/lib/justep"),n=e("$UI/system/lib/base/xml"),r=["sExecuteMode2","sLimitTime","sExecuteMode","sName","sPreemptMode"],i=["sLimitTime","sExecuteMode","sName","sPreemptMode"],s=["transferTask","advanceProcess","backProcess"],o=["sExecuteMode2","sEURL","sLimitTime","sName"],u={toModelExecuteRule:function(e){var t=[];return e!=null&&e.each(function(e){var i='<execute-rule condition="'+e.row.val("condition")+"\" task-assign-mode='"+e.row.val("taskAssignMode")+"'><executor-range range-expr=\""+e.row.val("rangeExpr")+'" default-expr="'+e.row.val("defaultExpr")+'" range-expr-value="'+e.row.val("rangeExprValue")+'" default-expr-value="'+e.row.val("defaultExprValue")+'">',s=e.row.val("kind").split(","),o=e.row.val("kindName").split(",");for(var u=0;u<s.length;u++)i+="<kind>"+s[u]+"</kind>";for(var u=0;u<o.length;u++)i+="<kind-name>"+o[u]+"</kind-name>";i+="</executor-range><task-relation-value>";for(var u=0;u<r.length;u++)e.row.val(r[u])!=null&&e.row.val(r[u])!=""&&(u!=1?i=i+"<item relation='"+r[u]+"'>"+e.row.val(r[u])+"</item>":i=i+"<item relation='"+r[u]+"'>toDateTime('"+e.row.val(r[u])+"')</item>");i+="</task-relation-value></execute-rule>";var a=n.fromString(i);t.push(a)}),t},toModelTransferRule:function(e){var t=[];return e!=null&&e.each(function(e){var r,s;e.row.val("dialogEnabled")=="dialogEnabled"?r="true":r="false",e.row.val("saveEnabled")=="saveEnabled"?s="true":s="false";var o='<transfer-rule condition="'+e.row.val("condition")+"\" dialog-enabled='"+r+"' save-enabled='"+s+"' task-assign-mode='"+e.row.val("taskAssignMode")+"'><executor-range range-expr=\""+e.row.val("rangeExpr")+'" default-expr="'+e.row.val("defaultExpr")+'" range-expr-value="'+e.row.val("rangeExprValue")+'" default-expr-value="'+e.row.val("defaultExprValue")+'">',u=e.row.val("kind").split(","),a=e.row.val("kindName").split(",");for(var f=0;f<u.length;f++)o+="<kind>"+u[f]+"</kind>";for(var f=0;f<a.length;f++)o+="<kind-name>"+a[f]+"</kind-name>";o+="</executor-range><task-relation-value>";for(var f=0;f<i.length;f++)e.row.val(i[f])!=null&&e.row.val(i[f])!=""&&(f!=0?o=o+"<item relation='"+i[f]+"'>"+e.row.val(i[f])+"</item>":o=o+"<item relation='"+i[f]+"'>toDateTime('"+e.row.val(i[f])+"')</item>");o+="</task-relation-value></transfer-rule>";var l=n.fromString(o);t.push(l)}),t},toModelNoticeRule:function(e){var t=[],r="";return e!=null&&e.each(function(e){var i,u;e.row.val("dialogEnabled")=="dialogEnabled"?i="true":i="false",e.row.val("saveEnabled")=="saveEnabled"?u="true":u="false",e.row.val("whenToUnit")!=""?r='<notice-rule condition="'+e.row.val("condition")+"\" dialog-enabled='"+i+"' save-enabled='"+u+"' when-to-unit='"+e.row.val("whenToUnit")+"' task-assign-mode='singleness'>":r='<notice-rule condition="'+e.row.val("condition")+"\" dialog-enabled='"+i+"' save-enabled='"+u+"' task-assign-mode='singleness'>";for(var a=0;a<s.length;a++)e.row.val(s[a])!=null&&e.row.val(s[a])!=""&&(r=r+"<occasion>"+s[a]+"</occasion>");r=r+'<executor-range range-expr="'+e.row.val("rangeExpr")+'" default-expr="'+e.row.val("defaultExpr")+'" range-expr-value="'+e.row.val("rangeExprValue")+'" default-expr-value="'+e.row.val("defaultExprValue")+'">';var f=e.row.val("kind").split(","),l=e.row.val("kindName").split(",");for(var a=0;a<f.length;a++)r+="<kind>"+f[a]+"</kind>";for(var a=0;a<l.length;a++)r+="<kind-name>"+l[a]+"</kind-name>";r+="</executor-range><task-relation-value>";for(var a=0;a<o.length;a++)e.row.val(o[a])!=null&&(a!=2?r=r+"<item relation='"+o[a]+"'>"+e.row.val(o[a])+"</item>":r=r+"<item relation='"+o[a]+"'>toDateTime('"+e.row.val(o[a])+"')</item>");r+="</task-relation-value></notice-rule>";var c=n.fromString(r);t.push(c)}),t},toModelAdvanceRule:function(e){var t=[];return e!=null&&e.each(function(e){var r,i,s,o,u,a="";e.row.val("dialogEnabled")=="dialogEnabled"?r="true":r="false",e.row.val("saveEnabled")=="saveEnabled"?i="true":i="false",e.row.val("jumpEnabled")=="jumpEnabled"?s="true":s="false",e.row.val("taskWait")=="taskWait"?o="true":o="false",e.row.val("taskJoin")=="taskJoin"?u="true":u="false",e.row.val("forkActivity")!=""&&e.row.val("ignoreExecuteMode")!=""?a='<advance-rule condition="'+e.row.val("condition")+"\" dialog-enabled='"+r+"' save-enabled='"+r+"' jump-enabled='"+s+"' customized-enabled='false' ignore-execute-mode='"+e.row.val("ignoreExecuteMode")+"' task-wait='"+o+"' task-join='"+u+"' fork-activity='"+e.row.val("forkActivity")+"'/>":e.row.val("forkActivity")!=""?a='<advance-rule condition="'+e.row.val("condition")+"\" dialog-enabled='"+r+"' save-enabled='"+r+"' jump-enabled='"+s+"' customized-enabled='false' task-wait='"+o+"' task-join='"+u+"' fork-activity='"+e.row.val("forkActivity")+"'/>":e.row.val("ignoreExecuteMode")!=""?a='<advance-rule condition="'+e.row.val("condition")+"\" dialog-enabled='"+r+"' save-enabled='"+r+"' jump-enabled='"+s+"' customized-enabled='false' ignore-execute-mode='"+e.row.val("ignoreExecuteMode")+"' task-wait='"+o+"' task-join='"+u+"'/>":a='<advance-rule condition="'+e.row.val("condition")+"\" dialog-enabled='"+r+"' save-enabled='"+r+"' jump-enabled='"+s+"' customized-enabled='false' task-wait='"+o+"' task-join='"+u+"'/>";var f=n.fromString(a);t.push(f)}),t},toModelBackRule:function(e,t,r){var i=[];return e!=null&&e.each(function(e){var s,o,u;e.row.val("dialogEnabled")=="dialogEnabled"?s="true":s="false",e.row.val("saveEnabled")=="saveEnabled"?o="true":o="false",e.row.val("ignoreExecuteMode")=="ignoreExecuteMode"?u="true":u="false";if(e.row.val("backRange")=="specified"){var a='<back-rule condition="'+e.row.val("condition")+"\" dialog-enabled='"+s+"' save-enabled='"+o+"' ignore-execute-mode='"+u+"' back-range='"+e.row.val("backRange")+"' then-flow-mode='"+e.row.val("thenFlowMode")+"'>",f=t.find(["id"],[e.row.val("id")]);for(var l=0;l<f.length;l++){var c;for(var h in r){var p=r[h];p.modelData.LABEL==f[l].val("linkName")&&(c=p.id)}a=a+"<to activity='"+c+"'/>"}a+="</back-rule>"}else var a='<back-rule condition="'+e.row.val("condition")+"\" dialog-enabled='"+s+"' save-enabled='"+o+"' ignore-execute-mode='"+u+"' back-range='"+e.row.val("backRange")+"' then-flow-mode='"+e.row.val("thenFlowMode")+"'/>";var d=n.fromString(a);i.push(d)}),i},toModelJoinRule:function(e,t,r){var i=[],s="";return e!=null&&e.each(function(e){var o=t.find(["id"],[e.row.val("id")]);if(o!=null){s='<join-rule condition="'+e.row.val("condition")+"\" join-mode='"+e.row.val("joinMode")+"' fork-activity='"+e.row.val("forkActivity")+"'>";for(var u=0;u<o.length;u++){var a;for(var f in r){var l=r[f];l.modelData.LABEL==o[u].val("name")&&(a=l.id)}s=s+"<optional unit='"+a+"'/>"}s+="</join-rule>"}else s="<join-rule condition='"+e.row.val("condition")+"' join-mode='"+e.row.val("joinMode")+"' fork-activity='"+e.row.val("forkActivity")+"'/>";var c=n.fromString(s);i.push(c)}),i},toModelForkRule:function(e,t,r){var i=[],s="";return e!=null&&e.each(function(e){var o=t.find(["id"],[e.row.val("id")]);if(o!=null){s='<fork-rule condition="'+e.row.val("condition")+'">';for(var u=0;u<o.length;u++){var a;for(var f in r){var l=r[f];l.modelData.LABEL==o[u].val("name")&&(a=l.id)}s=s+"<optional unit='"+a+"'/>"}s+="</fork-rule>"}else s="<fork-rule condition='"+e.row.val("condition")+"'/>";var c=n.fromString(s);i.push(c)}),i},toJsonExecuteRule:function(e,n){var r=null,i=null,s=null,o=null,u=null,a=null,f=null,l=null,c=null,h="",p="",d="",v="";r=e.getAttribute("condition"),i=e.getAttribute("task-assign-mode");var m=e.childNodes;for(var g=0;g<m.length;g++){if(m[g].tagName=="executor-range"){s=m[g].getAttribute("range-expr"),o=m[g].getAttribute("default-expr"),m[g].getAttribute("range-expr-value")!==null?h=m[g].getAttribute("range-expr-value"):h=m[g].getAttribute("range-expr"),m[g].getAttribute("default-expr-value")!==null?p=m[g].getAttribute("default-expr-value"):p=m[g].getAttribute("default-expr");var y=m[g].childNodes;for(var b=0;b<y.length;b++)y[b].tagName=="kind"&&(d+=y[b].innerHTML,d+=","),y[b].tagName=="kind-name"&&(v+=y[b].innerHTML,v+=",")}if(m[g].tagName=="task-relation-value"){var w=m[g].childNodes;for(var E=0;E<w.length;E++)if(w[E].tagName=="item"){w[E].getAttribute("relation")=="sExecuteMode2"&&(u=w[E].innerHTML),w[E].getAttribute("relation")=="sExecuteMode"&&(a=w[E].innerHTML),w[E].getAttribute("relation")=="sName"&&(f=w[E].innerHTML),w[E].getAttribute("relation")=="sPreemptMode"&&(l=w[E].innerHTML);if(w[E].getAttribute("relation")=="sLimitTime"){var S=w[E].innerHTML;c=t.Date.fromString(S,"yyyy-MM-dd hh:mm:ss")}}}}var x=d.substring(0,d.length-1),T=v.substring(0,v.length-1);return{name:n,condition:r,taskAssignMode:i,rangeExpr:s,sExecuteMode:a,sPreemptMode:l,sExecuteMode2:u,sName:f,sLimitTime:c,defaultExpr:o,kind:x,kindName:T,rangeExprValue:h,defaultExprValue:p}},toJsonTransferRule:function(e,n){var r=null,i=null,s=null,o=null,u=null,a=null,f=null,l=null,c=null,h=null,p="",d="",v="",m="";r=e.getAttribute("condition"),e.getAttribute("dialog-enabled")=="true"&&(u="dialogEnabled"),e.getAttribute("save-enabled")=="true"&&(a="saveEnabled"),i=e.getAttribute("task-assign-mode");var g=e.childNodes;for(var y=0;y<g.length;y++){if(g[y].tagName=="executor-range"){s=g[y].getAttribute("range-expr"),o=g[y].getAttribute("default-expr"),g[y].getAttribute("range-expr-value")!==null?p=g[y].getAttribute("range-expr-value"):p=g[y].getAttribute("range-expr"),g[y].getAttribute("default-expr-value")!==null?d=g[y].getAttribute("default-expr-value"):d=g[y].getAttribute("default-expr");var b=g[y].childNodes;for(var w=0;w<b.length;w++)b[w].tagName=="kind"&&(v+=b[w].innerHTML,v+=","),b[w].tagName=="kind-name"&&(m+=b[w].innerHTML,m+=",")}if(g[y].tagName=="task-relation-value"){var E=g[y].childNodes;for(var S=0;S<E.length;S++)if(E[S].tagName=="item"){E[S].getAttribute("relation")=="sExecuteMode"&&(f=E[S].innerHTML),E[S].getAttribute("relation")=="sName"&&(l=E[S].innerHTML),E[S].getAttribute("relation")=="sPreemptMode"&&(c=E[S].innerHTML);if(E[S].getAttribute("relation")=="sLimitTime"){var x=E[S].innerHTML;h=t.Date.fromString(x,"yyyy-MM-dd hh:mm:ss")}}}}var T=v.substring(0,v.length-1),N=m.substring(0,m.length-1);return{name:n,condition:r,dialogEnabled:u,saveEnabled:a,taskAssignMode:i,rangeExpr:s,sExecuteMode:f,sPreemptMode:c,sName:l,sLimitTime:h,defaultExpr:o,kind:T,kindName:N,rangeExprValue:p,defaultExprValue:d}},toJsonNoticeRule:function(e,n){var r=null,i=null,s=null,o=null,u=null,a=null,f=null,l=null,c=null,h=null,p=null,d="",v=null,m="",g="",y="",b="",w=null;r=e.getAttribute("condition"),e.getAttribute("dialog-enabled")=="true"&&(a="dialogEnabled"),e.getAttribute("save-enabled")=="true"&&(f="saveEnabled"),e.getAttribute("when-to-unit")!==null&&(d=e.getAttribute("when-to-unit")),i=e.getAttribute("task-assign-mode");var E=e.childNodes;for(var S=0;S<E.length;S++){if(E[S].tagName=="executor-range"){s=E[S].getAttribute("range-expr"),o=E[S].getAttribute("default-expr"),E[S].getAttribute("range-expr-value")!==null&&(y=E[S].getAttribute("range-expr-value")),E[S].getAttribute("default-expr-value")!==null&&(b=E[S].getAttribute("default-expr-value"));var x=E[S].childNodes;for(var T=0;T<x.length;T++)x[T].tagName=="kind"&&(m+=x[T].innerHTML,m+=","),x[T].tagName=="kind-name"&&(g+=x[T].innerHTML,g+=",")}E[S].tagName=="occasion"&&(E[S].innerHTML=="transferTask"?h="transferTask":E[S].innerHTML=="advanceProcess"?l="advanceProcess":E[S].innerHTML=="backProcess"&&(c="backProcess"));if(E[S].tagName=="task-relation-value"){var N=E[S].childNodes;for(var C=0;C<N.length;C++)if(N[C].tagName=="item"){N[C].getAttribute("relation")=="sExecuteMode2"&&(u=N[C].innerHTML),N[C].getAttribute("relation")=="sEURL"&&(p=N[C].innerHTML),N[C].getAttribute("relation")=="sName"&&(v=N[C].innerHTML);if(N[C].getAttribute("relation")=="sLimitTime"){var k=N[C].innerHTML;w=t.Date.fromString(k,"yyyy-MM-dd hh:mm:ss")}}}}var L=m.substring(0,m.length-1),A=g.substring(0,g.length-1);return{name:n,condition:r,dialogEnabled:a,saveEnabled:f,taskAssignMode:i,rangeExpr:s,sName:v,sLimitTime:w,defaultExpr:o,kind:L,kindName:A,sExecuteMode2:u,advanceProcess:l,sEURL:p,backProcess:c,transferTask:h,whenToUnit:d,rangeExprValue:y,defaultExprValue:b}},toJsonAdvanceRule:function(e,t){var n=null,r=null,i=null,s=null,o="",u=null,a=null,f="";return e.getAttribute("condition")!==null&&(n=e.getAttribute("condition")),e.getAttribute("ignore-execute-mode")!==null&&(o=e.getAttribute("ignore-execute-mode")),e.getAttribute("fork-activity")!==null&&(f=e.getAttribute("fork-activity")),e.getAttribute("dialog-enabled")=="true"&&(i="dialogEnabled"),e.getAttribute("save-enabled")=="true"&&(s="saveEnabled"),e.getAttribute("jump-enabled")=="true"&&(r="jumpEnabled"),e.getAttribute("task-wait")=="true"&&(u="taskWait"),e.getAttribute("task-join")=="true"&&(a="taskJoin"),{name:t,condition:n,dialogEnabled:i,saveEnabled:s,jumpEnabled:r,ignoreExecuteMode:o,taskWait:u,taskJoin:a,forkActivity:f}},toJsonBackRule:function(e,t,n,r){var i=null,s=null,o=null,u=null,a=null,f=null,l=[],c=[];i=e.getAttribute("condition"),o=e.getAttribute("then-flow-mode"),s=e.getAttribute("back-range"),e.getAttribute("ignore-execute-mode")=="true"&&(f="ignoreExecuteMode"),e.getAttribute("dialog-enabled")=="true"&&(u="dialogEnabled"),e.getAttribute("save-enabled")=="true"&&(a="saveEnabled");var h=e.childNodes;if(e.childNodes.length>0)for(var p=0;p<h.length;p++)if(h[p].tagName=="to")for(var d in r){var v=r[d];v.id==h[p].getAttribute("activity")&&l.push({linkName:v.modelData.LABEL,id:n})}var m={name:t,condition:i,dialogEnabled:u,saveEnabled:a,backRange:s,ignoreExecuteMode:f,thenFlowMode:o,id:n};return c.push(l),c.push(m),c},toJsonJoinRule:function(e,t,n,r){var i=null,s=null,o=null,u=null,a=[],f=[];s=t.getAttribute("condition"),o=t.getAttribute("join-mode"),u=t.getAttribute("fork-activity");var l={id:n,condition:s,joinMode:o,forkActivity:u,name:e},c=t.childNodes;if(c.length>0)for(var h=0;h<c.length;h++)if(c[h].tagName=="optional")for(var p in r){var d=r[p];d.id==c[h].getAttribute("unit")&&a.push({id:n,name:d.modelData.LABEL})}return f.push(l),f.push(a),f},toJsonForkRule:function(e,t,n,r){var i=null,s=[],o=[];i=t.getAttribute("condition");var u={id:n,condition:i,name:e},a=t.childNodes;if(a.length>0)for(var f=0;f<a.length;f++)if(a[f].tagName=="optional")for(var l in r){var c=r[l];c.id==a[f].getAttribute("unit")&&s.push({id:n,name:c.modelData.LABEL})}return o.push(u),o.push(s),o},findAllLink:function(e){var t=[];for(var n in e){var r=e[n];r.type=="businessActivity"&&t.push({value:r.id,oValue:r.modelData.LABEL})}return t},findInputLink:function(e,t){var n=null;for(var r in e){var i=e[r];i.id==t.getAttribute("unit")&&(n=i.modelData.LABEL)}return{value:t.getAttribute("unit"),oValue:n}},findOutputLink:function(e,t){var n=null;for(var r in e){var i=e[r];i.id==t.getAttribute("unit")&&(n=i.modelData.LABEL)}return{value:t.getAttribute("unit"),oValue:n}},findAfterConditionLink:function(e,t){var n=[],r=[],i;for(var s=0;s<t.length;s++)t[s].tagName=="input"&&(i=t[s].getAttribute("unit"));for(var o in e){var u=e[o];u.type=="businessActivity"&&n.push(u),u.id==i&&(n=[])}for(var a=0;a<n.length;a++){var f=n[a].modelData.LABEL;r.push({value:n[a].id,oValue:f})}return r},toJsonConditionBranch:function(e){var t=null,n=null,r=null,i=null,s=[];t=e.LABEL,i=e.xmlNode.getAttribute("condition");var o=e.xmlNode.childNodes;for(var u=0;u<o.length;u++)o[u].tagName=="true-output"&&(n=o[u].getAttribute("unit")),o[u].tagName=="false-output"&&(r=o[u].getAttribute("unit"));return s.push({conditionName:t,trueOutput:n,falseOutput:r,condition:i}),s},editModelConditionBranch:function(e,t){e.setAttribute("condition",t.val("condition"));var n=e.childNodes;for(var r=0;r<n.length;r++)n[r].tagName=="true-output"&&n[r].setAttribute("unit",t.val("trueOutput")),n[r].tagName=="false-output"&&n[r].setAttribute("unit",t.val("falseOutput"));return e}};return u}),define("$model/UI2/system/components/justep/processDesigner/processDesigner.config",["require"],function(e){return{properties:{},events:["onLoadTemplateAfter"],binds:{}}}),define("$model/UI2/system/components/justep/processDesigner/processDesigner",["require","css!./css/processDesigner","jquery","$UI/system/lib/base/xml","$UI/system/lib/justep","$UI/system/lib/biz","./js/processWebCanvas","$UI/system/components/justep/processDesigner/js/convter","./processDesigner.config","$UI/system/components/justep/org/orgDialogPC","$UI/system/components/justep/windowDialog/windowDialog"],function(e){e("css!./css/processDesigner").load();var t=e("jquery"),n=e.normalizeName("./processDesigner"),r=e("$UI/system/lib/base/xml"),i=e("$UI/system/lib/justep"),s=e("$UI/system/lib/biz"),o=e("./js/processWebCanvas"),u=e("$UI/system/components/justep/processDesigner/js/convter"),a=e("./processDesigner.config"),f=e("$UI/system/components/justep/org/orgDialogPC"),l=e("$UI/system/components/justep/windowDialog/windowDialog"),c=e.toUrl("$UI/system/service/process/dialog/selectProcessTemplate.w");this.rulesDialog=null;var h=i.ViewComponent.extend({constructor:function(e){},getConfig:function(){return a},buildTemplate:function(e){throw new Error("ProcessDesigner don't support js create!")},init:function(t,n){var r=this.$domNode.attr("id");r||(r=this.getModel().getContextID()+"_processDesigner",this.$domNode.attr("id",r));var i=this;this.designer=new o({id:r,activities:null,loadProcess:function(){return i.getProcessDefine()},selectExecutor:function(e,t,n){var r=i._getExecutorDialog();r._container=e,r.open({data:{selected:{kind:"sName",value:[]}}})},loadTemplate:function(){var e=i._getTemplateDialog();e.open({data:{type:"PROCESS_TEMPLATE",process:i.process}})},editProperties:function(t,n){var r=i._getEditRulesDialog(t,n);t.type=="and"&&(r.set({src:e.toUrl("./dialog/branch.w")}),r.set({title:"规则设置"}),r.set({height:660}),r.set({width:900})),t.type=="businessActivity"&&(r.set({src:e.toUrl("./dialog/activity.w")}),r.set({title:"规则设置"}),r.set({height:660}),r.set({width:900})),t.type=="conditionBranch"&&(r.set({src:e.toUrl("./dialog/conditionActivity.w")}),r.set({title:"条件设置"}),r.set({height:450}),r.set({width:500})),r._figure=t,r._figures=n;var s=[];s.push(t.modelData),s.push(n),s.push(i.process),s.push(i.processName),r.open({data:s})}})},_getEditRulesDialog:function(t,n){if(this.rulesDialog==null){var r={showTitle:!0,src:e.toUrl("./dialog/activity.w"),status:"normal",forceRefreshOnOpen:!0,routable:!1,parentNode:this.domNode};this.rulesDialog=new l(r);var i=this;this.rulesDialog.on("onReceive",function(e){var t=i.rulesDialog._figure,n=i.rulesDialog._figures,r=t.modelData.xmlNode,s=r.childNodes,o=e.data.length-1;t.setText(e.data[o]);if(t.type=="businessActivity"){var a=[];for(var f=0;f<s.length;f++){var l=s[f].tagName;(l=="execute-rule"||l=="transfer-rule"||l=="notice-rule"||l=="advance-rule"||l=="back-rule")&&a.push(s[f])}for(var c=0;c<a.length;c++)r.removeChild(a[c]);var h=e.data[0],p=u.toModelExecuteRule(h);for(var f=0;f<p.length;f++)r.appendChild(p[f].childNodes[0]);var d=e.data[1],v=u.toModelTransferRule(d);for(var f=0;f<v.length;f++)r.appendChild(v[f].childNodes[0]);var m=e.data[2],g=u.toModelNoticeRule(m);for(var f=0;f<g.length;f++)r.appendChild(g[f].childNodes[0]);var y=e.data[3],b=u.toModelAdvanceRule(y);for(var f=0;f<b.length;f++)r.appendChild(b[f].childNodes[0]);var w=e.data[4],E=e.data[5],S=u.toModelBackRule(w,E,n);for(var f=0;f<S.length;f++)r.appendChild(S[f].childNodes[0])}if(t.type=="and"){var a=[];for(var f=0;f<s.length;f++){var l=s[f].tagName;(l=="join-rule"||l=="fork-rule")&&a.push(s[f])}for(var c=0;c<a.length;c++)r.removeChild(a[c]);var x=e.data[0],T=e.data[2],N=u.toModelJoinRule(x,T,n);for(var f=0;f<N.length;f++)r.appendChild(N[f].childNodes[0]);var C=e.data[1],k=e.data[3],L=u.toModelForkRule(C,k,n);for(var f=0;f<L.length;f++)r.appendChild(L[f].childNodes[0])}if(t.type=="conditionBranch"){var A=e.data[0];r=u.editModelConditionBranch(r,A)}})}return this.rulesDialog},dispose:function(){this.designer.destroy(),this.callParent()},_getTemplateDialog:function(){if(!this.templateDialog){var e=this;this.templateDialog=new l({parentNode:this.domNode,title:(new i.Message(i.Message.JUSTEP230056)).getMessage(),showTitle:!0,status:"",src:c}),this.templateDialog.on("onReceive",function(t){var n=t.data;n&&n.content&&e.setData({processDefine:n.content,processGraph:n.content2})})}return this.templateDialog},_getExecutorDialog:function(){if(!this.executorDialog){var e=this;this.executorDialog=new f({title:(new i.Message(i.Message.JUSTEP230055)).getMessage(),showTitle:!0,multiSelection:!0,parentNode:this.getModel().getRootNode()}),this.executorDialog.on("onReceive",function(t){var n=t.data||[],r=[],i="";for(var s=0;s<n.length;s++)fid=n[s].val("sFID"),fid&&(r[r.length]={fid:fid,fname:n[s].val("sFName")},i&&(i+=","),i+="'"+fid+"'");i!=""&&(i="findOrgUnitsByFID(list("+i+"))"),e.executorDialog._container.setExecuteRuleProp("executor-range",{items:r,expr:i})},this)}return this.executorDialog},getProcessDefine:function(){var e=["",""],t=new s.Request.ActionParam;t.setString("process",this.process);var n={},r=this.getModel().getContext();return n.context=r,n.contentType="json",n.process=r.getCurrentProcess(),n.activity=r.getCurrentActivity(),n.dataType="json",n.action="queryProcessDefine2Action",n.parameters=t,n.directExecute=!0,n.callback=function(t){t.state?e=t.response:t.ignoreError=!1},s.Request.sendBizRequest(n),e},_getActivities:function(){var e=null,t=new s.Request.ActionParam;t.setString("process",this.process);var n=this.getModel().getContext(),r={};r.context=n,r.contentType="json",r.process=n.getCurrentProcess(),r.activity=n.getCurrentActivity(),r.dataType="json",r.action="queryCustomizedRange3Action",r.parameters=t,r.directExecute=!0,r.callback=function(t){t.state?e=t.response.xml:t.ignoreError=!1};var i=s.Request.sendBizRequest(r);return e},load:function(e,t){this.process=e,this.processName=t,this.designer.initToolbox(this._getActivities())},setData:function(e){var t=e.processDefine;if(!t||t.length==0)t='<model  xmlns="http://www.justep.com/model"><template name="'+e.id+'" process="'+this.process.substr(this.process.lastIndexOf("/")+1)+'"/></model>';return this.designer.setData([t,e.processGraph,e.activeActivities,e.finishedActivities,e.isGraph2])},getData:function(){var e=this.designer.getData();return{processDefine:e[0],processGraph:e[1]}}});return h.LOAD_TEMPLATE_AFTER="onLoadTemplateAfter",i.Component.register(n,h),h});